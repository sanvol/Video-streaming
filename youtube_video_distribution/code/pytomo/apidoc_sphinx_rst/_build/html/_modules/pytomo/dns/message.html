

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pytomo.dns.message &mdash; Pytomo 2.8.6 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.8.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Pytomo 2.8.6 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Pytomo 2.8.6 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pytomo.dns.message</h1><div class="highlight"><pre>
<span class="c"># Copyright (C) 2001-2007, 2009, 2010 Nominum, Inc.</span>
<span class="c">#</span>
<span class="c"># Permission to use, copy, modify, and distribute this software and its</span>
<span class="c"># documentation for any purpose with or without fee is hereby granted,</span>
<span class="c"># provided that the above copyright notice and this permission notice</span>
<span class="c"># appear in all copies.</span>
<span class="c">#</span>
<span class="c"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND NOMINUM DISCLAIMS ALL WARRANTIES</span>
<span class="c"># WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="c"># MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL NOMINUM BE LIABLE FOR</span>
<span class="c"># ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="c"># WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="c"># ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT</span>
<span class="c"># OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>

<span class="sd">&quot;&quot;&quot;DNS Messages&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">cStringIO</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">edns</span> <span class="k">as</span> <span class="n">dns_edns</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exception</span> <span class="k">as</span> <span class="n">dns_exception</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">flags</span> <span class="k">as</span> <span class="n">dns_flags</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">name</span> <span class="k">as</span> <span class="n">dns_name</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">opcode</span> <span class="k">as</span> <span class="n">dns_opcode</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">entropy</span> <span class="k">as</span> <span class="n">dns_entropy</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rcode</span> <span class="k">as</span> <span class="n">dns_rcode</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rdata</span> <span class="k">as</span> <span class="n">dns_rdata</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rdataclass</span> <span class="k">as</span> <span class="n">dns_rdataclass</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rdatatype</span> <span class="k">as</span> <span class="n">dns_rdatatype</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">rrset</span> <span class="k">as</span> <span class="n">dns_rrset</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">renderer</span> <span class="k">as</span> <span class="n">dns_renderer</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tsig</span> <span class="k">as</span> <span class="n">dns_tsig</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tokenizer</span> <span class="k">as</span> <span class="n">dns_tokenizer</span>

<div class="viewcode-block" id="ShortHeader"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.ShortHeader">[docs]</a><span class="k">class</span> <span class="nc">ShortHeader</span><span class="p">(</span><span class="n">dns_exception</span><span class="o">.</span><span class="n">FormError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if the DNS packet passed to from_wire() is too short.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="TrailingJunk"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.TrailingJunk">[docs]</a><span class="k">class</span> <span class="nc">TrailingJunk</span><span class="p">(</span><span class="n">dns_exception</span><span class="o">.</span><span class="n">FormError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if the DNS packet passed to from_wire() has extra junk</span>
<span class="sd">    at the end of it.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="UnknownHeaderField"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.UnknownHeaderField">[docs]</a><span class="k">class</span> <span class="nc">UnknownHeaderField</span><span class="p">(</span><span class="n">dns_exception</span><span class="o">.</span><span class="n">DNSException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if a header field name is not recognized when converting from</span>
<span class="sd">    text into a message.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="BadEDNS"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.BadEDNS">[docs]</a><span class="k">class</span> <span class="nc">BadEDNS</span><span class="p">(</span><span class="n">dns_exception</span><span class="o">.</span><span class="n">FormError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if an OPT record occurs somewhere other than the start of</span>
<span class="sd">    the additional data section.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="BadTSIG"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.BadTSIG">[docs]</a><span class="k">class</span> <span class="nc">BadTSIG</span><span class="p">(</span><span class="n">dns_exception</span><span class="o">.</span><span class="n">FormError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if a TSIG record occurs somewhere other than the end of</span>
<span class="sd">    the additional data section.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="UnknownTSIGKey"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.UnknownTSIGKey">[docs]</a><span class="k">class</span> <span class="nc">UnknownTSIGKey</span><span class="p">(</span><span class="n">dns_exception</span><span class="o">.</span><span class="n">DNSException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised if we got a TSIG but don&#39;t know the key.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Message"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message">[docs]</a><span class="k">class</span> <span class="nc">Message</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A DNS message.</span>

<span class="sd">    @ivar id: The query id; the default is a randomly chosen id.</span>
<span class="sd">    @type id: int</span>
<span class="sd">    @ivar flags: The DNS flags of the message.  @see: RFC 1035 for an</span>
<span class="sd">    explanation of these flags.</span>
<span class="sd">    @type flags: int</span>
<span class="sd">    @ivar question: The question section.</span>
<span class="sd">    @type question: list of dns_rrset.RRset objects</span>
<span class="sd">    @ivar answer: The answer section.</span>
<span class="sd">    @type answer: list of dns_rrset.RRset objects</span>
<span class="sd">    @ivar authority: The authority section.</span>
<span class="sd">    @type authority: list of dns_rrset.RRset objects</span>
<span class="sd">    @ivar additional: The additional data section.</span>
<span class="sd">    @type additional: list of dns_rrset.RRset objects</span>
<span class="sd">    @ivar edns: The EDNS level to use.  The default is -1, no Edns.</span>
<span class="sd">    @type edns: int</span>
<span class="sd">    @ivar ednsflags: The EDNS flags</span>
<span class="sd">    @type ednsflags: long</span>
<span class="sd">    @ivar payload: The EDNS payload size.  The default is 0.</span>
<span class="sd">    @type payload: int</span>
<span class="sd">    @ivar options: The EDNS options</span>
<span class="sd">    @type options: list of dns_edns_Option objects</span>
<span class="sd">    @ivar request_payload: The associated request&#39;s EDNS payload size.</span>
<span class="sd">    @type request_payload: int</span>
<span class="sd">    @ivar keyring: The TSIG keyring to use.  The default is None.</span>
<span class="sd">    @type keyring: dict</span>
<span class="sd">    @ivar keyname: The TSIG keyname to use.  The default is None.</span>
<span class="sd">    @type keyname: dns_name.Name object</span>
<span class="sd">    @ivar keyalgorithm: The TSIG algorithm to use; defaults to</span>
<span class="sd">    dns_tsig.default_algorithm.  Constants for TSIG algorithms are defined</span>
<span class="sd">    in dns_tsig, and the currently implemented algorithms are</span>
<span class="sd">    HMAC_MD5, HMAC_SHA1, HMAC_SHA224, HMAC_SHA256, HMAC_SHA384, and</span>
<span class="sd">    HMAC_SHA512.</span>
<span class="sd">    @type keyalgorithm: string</span>
<span class="sd">    @ivar request_mac: The TSIG MAC of the request message associated with</span>
<span class="sd">    this message; used when validating TSIG signatures.   @see: RFC 2845 for</span>
<span class="sd">    more information on TSIG fields.</span>
<span class="sd">    @type request_mac: string</span>
<span class="sd">    @ivar fudge: TSIG time fudge; default is 300 seconds.</span>
<span class="sd">    @type fudge: int</span>
<span class="sd">    @ivar original_id: TSIG original id; defaults to the message&#39;s id</span>
<span class="sd">    @type original_id: int</span>
<span class="sd">    @ivar tsig_error: TSIG error code; default is 0.</span>
<span class="sd">    @type tsig_error: int</span>
<span class="sd">    @ivar other_data: TSIG other data.</span>
<span class="sd">    @type other_data: string</span>
<span class="sd">    @ivar mac: The TSIG MAC for this message.</span>
<span class="sd">    @type mac: string</span>
<span class="sd">    @ivar xfr: Is the message being used to contain the results of a DNS</span>
<span class="sd">    zone transfer?  The default is False.</span>
<span class="sd">    @type xfr: bool</span>
<span class="sd">    @ivar origin: The origin of the zone in messages which are used for</span>
<span class="sd">    zone transfers or for DNS dynamic updates.  The default is None.</span>
<span class="sd">    @type origin: dns_name.Name object</span>
<span class="sd">    @ivar tsig_ctx: The TSIG signature context associated with this</span>
<span class="sd">    message.  The default is None.</span>
<span class="sd">    @type tsig_ctx: hmac.HMAC object</span>
<span class="sd">    @ivar had_tsig: Did the message decoded from wire format have a TSIG</span>
<span class="sd">    signature?</span>
<span class="sd">    @type had_tsig: bool</span>
<span class="sd">    @ivar multi: Is this message part of a multi-message sequence?  The</span>
<span class="sd">    default is false.  This variable is used when validating TSIG signatures</span>
<span class="sd">    on messages which are part of a zone transfer.</span>
<span class="sd">    @type multi: bool</span>
<span class="sd">    @ivar first: Is this message standalone, or the first of a multi</span>
<span class="sd">    message sequence?  This variable is used when validating TSIG signatures</span>
<span class="sd">    on messages which are part of a zone transfer.</span>
<span class="sd">    @type first: bool</span>
<span class="sd">    @ivar index: An index of rrsets in the message.  The index key is</span>
<span class="sd">    (section, name, rdclass, rdtype, covers, deleting).  Indexing can be</span>
<span class="sd">    disabled by setting the index to None.</span>
<span class="sd">    @type index: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">dns_entropy</span><span class="o">.</span><span class="n">random_16</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authority</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyring</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyname</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyalgorithm</span> <span class="o">=</span> <span class="n">dns_tsig</span><span class="o">.</span><span class="n">default_algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_mac</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other_data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsig_error</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fudge</span> <span class="o">=</span> <span class="mi">300</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mac</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xfr</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsig_ctx</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">had_tsig</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;DNS message, ID &#39;</span> <span class="o">+</span> <span class="sb">`self.id`</span> <span class="o">+</span> <span class="s">&#39;&gt;&#39;</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_text</span><span class="p">()</span>

<div class="viewcode-block" id="Message.to_text"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.to_text">[docs]</a>    <span class="k">def</span> <span class="nf">to_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">origin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">relativize</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert the message to text.</span>

<span class="sd">        The I{origin}, I{relativize}, and any other keyword</span>
<span class="sd">        arguments are passed to the rrset to_wire() method.</span>

<span class="sd">        @rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">cStringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;id </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;opcode </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
              <span class="n">dns_opcode</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">dns_opcode</span><span class="o">.</span><span class="n">from_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">))</span>
        <span class="n">rc</span> <span class="o">=</span> <span class="n">dns_rcode</span><span class="o">.</span><span class="n">from_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;rcode </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">dns_rcode</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">rc</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;flags </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;edns </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">edns</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;eflags </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> \
                      <span class="n">dns_flags</span><span class="o">.</span><span class="n">edns_to_text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span><span class="p">)</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;payload&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span>
        <span class="n">is_update</span> <span class="o">=</span> <span class="n">dns_opcode</span><span class="o">.</span><span class="n">is_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;;ZONE&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;;QUESTION&#39;</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="n">rrset</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">relativize</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;;PREREQ&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;;ANSWER&#39;</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="n">rrset</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">relativize</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_update</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;;UPDATE&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;;AUTHORITY&#39;</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authority</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="n">rrset</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">relativize</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;;ADDITIONAL&#39;</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="n">rrset</span><span class="o">.</span><span class="n">to_text</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">relativize</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="c">#</span>
        <span class="c"># We strip off the final \n so the caller can print the result without</span>
        <span class="c"># doing weird things to get around eccentricities in Python print</span>
        <span class="c"># formatting</span>
        <span class="c">#</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Two messages are equal if they have the same content in the</span>
<span class="sd">        header, question, answer, and authority sections.</span>
<span class="sd">        @rtype: bool&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Message</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">flags</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authority</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">authority</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">authority</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authority</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Are two messages not equal?</span>
<span class="sd">        @rtype: bool&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

<div class="viewcode-block" id="Message.is_response"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.is_response">[docs]</a>    <span class="k">def</span> <span class="nf">is_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Is other a response to self?</span>
<span class="sd">        @rtype: bool&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">other</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">QR</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> \
           <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> \
           <span class="n">dns_opcode</span><span class="o">.</span><span class="n">from_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> \
           <span class="n">dns_opcode</span><span class="o">.</span><span class="n">from_flags</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">flags</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">dns_rcode</span><span class="o">.</span><span class="n">from_flags</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">ednsflags</span><span class="p">)</span> <span class="o">!=</span> \
               <span class="n">dns_rcode</span><span class="o">.</span><span class="n">NOERROR</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">dns_opcode</span><span class="o">.</span><span class="n">is_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Message.section_number"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.section_number">[docs]</a>    <span class="k">def</span> <span class="nf">section_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">authority</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;unknown section&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Message.find_rrset"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.find_rrset">[docs]</a>    <span class="k">def</span> <span class="nf">find_rrset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span>
                   <span class="n">covers</span><span class="o">=</span><span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span> <span class="n">deleting</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">force_unique</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find the RRset with the given attributes in the specified section.</span>

<span class="sd">        @param section: the section of the message to look in, e.g.</span>
<span class="sd">        self.answer.</span>
<span class="sd">        @type section: list of dns_rrset.RRset objects</span>
<span class="sd">        @param name: the name of the RRset</span>
<span class="sd">        @type name: dns_name.Name object</span>
<span class="sd">        @param rdclass: the class of the RRset</span>
<span class="sd">        @type rdclass: int</span>
<span class="sd">        @param rdtype: the type of the RRset</span>
<span class="sd">        @type rdtype: int</span>
<span class="sd">        @param covers: the covers value of the RRset</span>
<span class="sd">        @type covers: int</span>
<span class="sd">        @param deleting: the deleting value of the RRset</span>
<span class="sd">        @type deleting: int</span>
<span class="sd">        @param create: If True, create the RRset if it is not found.</span>
<span class="sd">        The created RRset is appended to I{section}.</span>
<span class="sd">        @type create: bool</span>
<span class="sd">        @param force_unique: If True and create is also True, create a</span>
<span class="sd">        new RRset regardless of whether a matching RRset exists already.</span>
<span class="sd">        @type force_unique: bool</span>
<span class="sd">        @raises KeyError: the RRset was not found and create was False</span>
<span class="sd">        @rtype: dns_rrset.RRset object&quot;&quot;&quot;</span>

        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">section_number</span><span class="p">(</span><span class="n">section</span><span class="p">),</span>
               <span class="n">name</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">covers</span><span class="p">,</span> <span class="n">deleting</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force_unique</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">rrset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rrset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">rrset</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="n">section</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rrset</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">covers</span><span class="p">,</span> <span class="n">deleting</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">rrset</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">create</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span>
        <span class="n">rrset</span> <span class="o">=</span> <span class="n">dns_rrset</span><span class="o">.</span><span class="n">RRset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">covers</span><span class="p">,</span> <span class="n">deleting</span><span class="p">)</span>
        <span class="n">section</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rrset</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rrset</span>
        <span class="k">return</span> <span class="n">rrset</span>
</div>
<div class="viewcode-block" id="Message.get_rrset"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.get_rrset">[docs]</a>    <span class="k">def</span> <span class="nf">get_rrset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span>
                  <span class="n">covers</span><span class="o">=</span><span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span> <span class="n">deleting</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">force_unique</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the RRset with the given attributes in the specified section.</span>

<span class="sd">        If the RRset is not found, None is returned.</span>

<span class="sd">        @param section: the section of the message to look in, e.g.</span>
<span class="sd">        self.answer.</span>
<span class="sd">        @type section: list of dns_rrset.RRset objects</span>
<span class="sd">        @param name: the name of the RRset</span>
<span class="sd">        @type name: dns_name.Name object</span>
<span class="sd">        @param rdclass: the class of the RRset</span>
<span class="sd">        @type rdclass: int</span>
<span class="sd">        @param rdtype: the type of the RRset</span>
<span class="sd">        @type rdtype: int</span>
<span class="sd">        @param covers: the covers value of the RRset</span>
<span class="sd">        @type covers: int</span>
<span class="sd">        @param deleting: the deleting value of the RRset</span>
<span class="sd">        @type deleting: int</span>
<span class="sd">        @param create: If True, create the RRset if it is not found.</span>
<span class="sd">        The created RRset is appended to I{section}.</span>
<span class="sd">        @type create: bool</span>
<span class="sd">        @param force_unique: If True and create is also True, create a</span>
<span class="sd">        new RRset regardless of whether a matching RRset exists already.</span>
<span class="sd">        @type force_unique: bool</span>
<span class="sd">        @rtype: dns_rrset.RRset object or None&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">rrset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_rrset</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">covers</span><span class="p">,</span>
                                    <span class="n">deleting</span><span class="p">,</span> <span class="n">create</span><span class="p">,</span> <span class="n">force_unique</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">rrset</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">rrset</span>
</div>
<div class="viewcode-block" id="Message.to_wire"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.to_wire">[docs]</a>    <span class="k">def</span> <span class="nf">to_wire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string containing the message in DNS compressed wire</span>
<span class="sd">        format.</span>

<span class="sd">        Additional keyword arguments are passed to the rrset to_wire()</span>
<span class="sd">        method.</span>

<span class="sd">        @param origin: The origin to be appended to any relative names.</span>
<span class="sd">        @type origin: dns_name.Name object</span>
<span class="sd">        @param max_size: The maximum size of the wire format output; default</span>
<span class="sd">        is 0, which means &#39;the message&#39;s request payload, if nonzero, or</span>
<span class="sd">        65536&#39;.</span>
<span class="sd">        @type max_size: int</span>
<span class="sd">        @raises dns_exception.TooBig: max_size was exceeded</span>
<span class="sd">        @rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">max_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">max_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">max_size</span> <span class="o">=</span> <span class="mi">65535</span>
        <span class="k">if</span> <span class="n">max_size</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">:</span>
            <span class="n">max_size</span> <span class="o">=</span> <span class="mi">512</span>
        <span class="k">elif</span> <span class="n">max_size</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">:</span>
            <span class="n">max_size</span> <span class="o">=</span> <span class="mi">65535</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">dns_renderer</span><span class="o">.</span><span class="n">Renderer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">origin</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">add_question</span><span class="p">(</span><span class="n">rrset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rrset</span><span class="o">.</span><span class="n">rdtype</span><span class="p">,</span> <span class="n">rrset</span><span class="o">.</span><span class="n">rdclass</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">add_rrset</span><span class="p">(</span><span class="n">dns_renderer</span><span class="o">.</span><span class="n">ANSWER</span><span class="p">,</span> <span class="n">rrset</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">authority</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">add_rrset</span><span class="p">(</span><span class="n">dns_renderer</span><span class="o">.</span><span class="n">AUTHORITY</span><span class="p">,</span> <span class="n">rrset</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">add_edns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">add_rrset</span><span class="p">(</span><span class="n">dns_renderer</span><span class="o">.</span><span class="n">ADDITIONAL</span><span class="p">,</span> <span class="n">rrset</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">write_header</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">add_tsig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyring</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">keyname</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">fudge</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsig_error</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">other_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_mac</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">keyalgorithm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mac</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">mac</span>
        <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">get_wire</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Message.use_tsig"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.use_tsig">[docs]</a>    <span class="k">def</span> <span class="nf">use_tsig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyring</span><span class="p">,</span> <span class="n">keyname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">fudge</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                 <span class="n">original_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tsig_error</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">other_data</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">algorithm</span><span class="o">=</span><span class="n">dns_tsig</span><span class="o">.</span><span class="n">default_algorithm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;When sending, a TSIG signature using the specified keyring</span>
<span class="sd">        and keyname should be added.</span>

<span class="sd">        @param keyring: The TSIG keyring to use; defaults to None.</span>
<span class="sd">        @type keyring: dict</span>
<span class="sd">        @param keyname: The name of the TSIG key to use; defaults to None.</span>
<span class="sd">        The key must be defined in the keyring.  If a keyring is specified</span>
<span class="sd">        but a keyname is not, then the key used will be the first key in the</span>
<span class="sd">        keyring.  Note that the order of keys in a dictionary is not defined,</span>
<span class="sd">        so applications should supply a keyname when a keyring is used, unless</span>
<span class="sd">        they know the keyring contains only one key.</span>
<span class="sd">        @type keyname: dns_name.Name or string</span>
<span class="sd">        @param fudge: TSIG time fudge; default is 300 seconds.</span>
<span class="sd">        @type fudge: int</span>
<span class="sd">        @param original_id: TSIG original id; defaults to the message&#39;s id</span>
<span class="sd">        @type original_id: int</span>
<span class="sd">        @param tsig_error: TSIG error code; default is 0.</span>
<span class="sd">        @type tsig_error: int</span>
<span class="sd">        @param other_data: TSIG other data.</span>
<span class="sd">        @type other_data: string</span>
<span class="sd">        @param algorithm: The TSIG algorithm to use; defaults to</span>
<span class="sd">        dns_tsig.default_algorithm</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyring</span> <span class="o">=</span> <span class="n">keyring</span>
        <span class="k">if</span> <span class="n">keyname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyring</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keyname</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                <span class="n">keyname</span> <span class="o">=</span> <span class="n">dns_name</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">keyname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyname</span> <span class="o">=</span> <span class="n">keyname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyalgorithm</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fudge</span> <span class="o">=</span> <span class="n">fudge</span>
        <span class="k">if</span> <span class="n">original_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">original_id</span> <span class="o">=</span> <span class="n">original_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsig_error</span> <span class="o">=</span> <span class="n">tsig_error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">other_data</span> <span class="o">=</span> <span class="n">other_data</span>
</div>
<div class="viewcode-block" id="Message.use_edns"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.use_edns">[docs]</a>    <span class="k">def</span> <span class="nf">use_edns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edns</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ednsflags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="mi">1280</span><span class="p">,</span> <span class="n">request_payload</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Configure EDNS behavior.</span>
<span class="sd">        @param edns: The EDNS level to use.  Specifying None, False, or -1</span>
<span class="sd">        means &#39;do not use EDNS&#39;, and in this case the other parameters are</span>
<span class="sd">        ignored.  Specifying True is equivalent to specifying 0, i.e. &#39;use</span>
<span class="sd">        EDNS0&#39;.</span>
<span class="sd">        @type edns: int or bool or None</span>
<span class="sd">        @param ednsflags: EDNS flag values.</span>
<span class="sd">        @type ednsflags: int</span>
<span class="sd">        @param payload: The EDNS sender&#39;s payload field, which is the maximum</span>
<span class="sd">        size of UDP datagram the sender can handle.</span>
<span class="sd">        @type payload: int</span>
<span class="sd">        @param request_payload: The EDNS payload size to use when sending</span>
<span class="sd">        this message.  If not specified, defaults to the value of payload.</span>
<span class="sd">        @type request_payload: int or None</span>
<span class="sd">        @param options: The EDNS options</span>
<span class="sd">        @type options: None or list of dns_edns_Option objects</span>
<span class="sd">        @see: RFC 2671</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">edns</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">edns</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">edns</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">edns</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">edns</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">request_payload</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">request_payload</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="k">if</span> <span class="n">edns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ednsflags</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">request_payload</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># make sure the EDNS version in ednsflags agrees with edns</span>
            <span class="n">ednsflags</span> <span class="o">&amp;=</span> <span class="mh">0xFF00FFFF</span><span class="n">L</span>
            <span class="n">ednsflags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">edns</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">=</span> <span class="n">edns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">=</span> <span class="n">ednsflags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">payload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_payload</span> <span class="o">=</span> <span class="n">request_payload</span>
</div>
<div class="viewcode-block" id="Message.want_dnssec"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.want_dnssec">[docs]</a>    <span class="k">def</span> <span class="nf">want_dnssec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wanted</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Enable or disable &#39;DNSSEC desired&#39; flag in requests.</span>
<span class="sd">        @param wanted: Is DNSSEC desired?  If True, EDNS is enabled if</span>
<span class="sd">        required, and then the DO bit is set.  If False, the DO bit is</span>
<span class="sd">        cleared if EDNS is enabled.</span>
<span class="sd">        @type wanted: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wanted</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_edns</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">|=</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">DO</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">dns_flags</span><span class="o">.</span><span class="n">DO</span>
</div>
<div class="viewcode-block" id="Message.rcode"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.rcode">[docs]</a>    <span class="k">def</span> <span class="nf">rcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the rcode.</span>
<span class="sd">        @rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dns_rcode</span><span class="o">.</span><span class="n">from_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Message.set_rcode"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.set_rcode">[docs]</a>    <span class="k">def</span> <span class="nf">set_rcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rcode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the rcode.</span>
<span class="sd">        @param rcode: the rcode</span>
<span class="sd">        @type rcode: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">evalue</span><span class="p">)</span> <span class="o">=</span> <span class="n">dns_rcode</span><span class="o">.</span><span class="n">to_flags</span><span class="p">(</span><span class="n">rcode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="mh">0xFFF0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">&amp;=</span> <span class="mh">0x00FFFFFF</span><span class="n">L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">|=</span> <span class="n">evalue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edns</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Message.opcode"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.opcode">[docs]</a>    <span class="k">def</span> <span class="nf">opcode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the opcode.</span>
<span class="sd">        @rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">dns_opcode</span><span class="o">.</span><span class="n">from_flags</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Message.set_opcode"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.Message.set_opcode">[docs]</a>    <span class="k">def</span> <span class="nf">set_opcode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opcode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the opcode.</span>
<span class="sd">        @param opcode: the opcode</span>
<span class="sd">        @type opcode: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="mh">0x87FF</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">dns_opcode</span><span class="o">.</span><span class="n">to_flags</span><span class="p">(</span><span class="n">opcode</span><span class="p">)</span>
</div></div>
<span class="k">class</span> <span class="nc">_WireReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wire format reader.</span>

<span class="sd">    @ivar wire: the wire-format message.</span>
<span class="sd">    @type wire: string</span>
<span class="sd">    @ivar message: The message object being built</span>
<span class="sd">    @type message: dns_message.Message object</span>
<span class="sd">    @ivar current: When building a message object from wire format, this</span>
<span class="sd">    variable contains the offset from the beginning of wire of the next octet</span>
<span class="sd">    to be read.</span>
<span class="sd">    @type current: int</span>
<span class="sd">    @ivar updating: Is the message a dynamic update?</span>
<span class="sd">    @type updating: bool</span>
<span class="sd">    @ivar one_rr_per_rrset: Put each RR into its own RRset?</span>
<span class="sd">    @type one_rr_per_rrset: bool</span>
<span class="sd">    @ivar zone_rdclass: The class of the zone in messages which are</span>
<span class="sd">    DNS dynamic updates.</span>
<span class="sd">    @type zone_rdclass: int</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wire</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">question_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">one_rr_per_rrset</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wire</span> <span class="o">=</span> <span class="n">wire</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zone_rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">IN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">question_only</span> <span class="o">=</span> <span class="n">question_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_rr_per_rrset</span> <span class="o">=</span> <span class="n">one_rr_per_rrset</span>

    <span class="k">def</span> <span class="nf">_get_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qcount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the next I{qcount} records from the wire data and add them to</span>
<span class="sd">        the question section.</span>
<span class="sd">        @param qcount: the number of questions in the message</span>
<span class="sd">        @type qcount: int&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="ow">and</span> <span class="n">qcount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">FormError</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">qcount</span><span class="p">):</span>
            <span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span> <span class="o">=</span> <span class="n">dns_name</span><span class="o">.</span><span class="n">from_wire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">origin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">qname</span> <span class="o">=</span> <span class="n">qname</span><span class="o">.</span><span class="n">relativize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+</span> <span class="n">used</span>
            <span class="p">(</span><span class="n">rdtype</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">)</span> <span class="o">=</span> \
                     <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!HH&#39;</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+</span> <span class="mi">4</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">find_rrset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="n">qname</span><span class="p">,</span>
                                    <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">force_unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updating</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zone_rdclass</span> <span class="o">=</span> <span class="n">rdclass</span>

    <span class="k">def</span> <span class="nf">_get_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the next I{count} records from the wire data and add them to</span>
<span class="sd">        the specified section.</span>
<span class="sd">        @param section: the section of the message to which to add records</span>
<span class="sd">        @type section: list of dns_rrset.RRset objects</span>
<span class="sd">        @param count: the number of records to read</span>
<span class="sd">        @type count: int&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">one_rr_per_rrset</span><span class="p">:</span>
            <span class="n">force_unique</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force_unique</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">seen_opt</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
            <span class="n">rr_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>
            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">used</span><span class="p">)</span> <span class="o">=</span> <span class="n">dns_name</span><span class="o">.</span><span class="n">from_wire</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">)</span>
            <span class="n">absolute_name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">origin</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">relativize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+</span> <span class="n">used</span>
            <span class="p">(</span><span class="n">rdtype</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">)</span> <span class="o">=</span> \
                     <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!HHIH&#39;</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+</span> <span class="mi">10</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+</span> <span class="mi">10</span>
            <span class="k">if</span> <span class="n">rdtype</span> <span class="o">==</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">OPT</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">section</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">additional</span> <span class="ow">or</span> <span class="n">seen_opt</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">BadEDNS</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">rdclass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">=</span> <span class="n">ttl</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edns</span> <span class="o">=</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span>
                <span class="n">optslen</span> <span class="o">=</span> <span class="n">rdlen</span>
                <span class="k">while</span> <span class="n">optslen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">otype</span><span class="p">,</span> <span class="n">olen</span><span class="p">)</span> <span class="o">=</span> \
                            <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!HH&#39;</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">[</span><span class="n">current</span><span class="p">:</span><span class="n">current</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="n">current</span> <span class="o">+</span> <span class="mi">4</span>
                    <span class="n">opt</span> <span class="o">=</span> <span class="n">dns_edns</span><span class="o">.</span><span class="n">option_from_wire</span><span class="p">(</span><span class="n">otype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="n">olen</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="n">current</span> <span class="o">+</span> <span class="n">olen</span>
                    <span class="n">optslen</span> <span class="o">=</span> <span class="n">optslen</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">olen</span>
                <span class="n">seen_opt</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">rdtype</span> <span class="o">==</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">TSIG</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">section</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">additional</span> <span class="ow">and</span>
                        <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">BadTSIG</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">keyring</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">UnknownTSIGKey</span><span class="p">(</span><span class="s">&#39;got signed message without keyring&#39;</span><span class="p">)</span>
                <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">keyring</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">absolute_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">secret</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">UnknownTSIGKey</span><span class="p">(</span><span class="s">&quot;key &#39;</span><span class="si">%s</span><span class="s">&#39; unknown&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tsig_ctx</span> <span class="o">=</span> \
                                      <span class="n">dns_tsig</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">,</span>
                                          <span class="n">absolute_name</span><span class="p">,</span>
                                          <span class="n">secret</span><span class="p">,</span>
                                          <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">request_mac</span><span class="p">,</span>
                                          <span class="n">rr_start</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">,</span>
                                          <span class="n">rdlen</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tsig_ctx</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">multi</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">had_tsig</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ttl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ttl</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="ow">and</span> \
                   <span class="p">(</span><span class="n">rdclass</span> <span class="o">==</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">ANY</span> <span class="ow">or</span>
                    <span class="n">rdclass</span> <span class="o">==</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">NONE</span><span class="p">):</span>
                    <span class="n">deleting</span> <span class="o">=</span> <span class="n">rdclass</span>
                    <span class="n">rdclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone_rdclass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">deleting</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">deleting</span> <span class="o">==</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">ANY</span> <span class="ow">or</span> \
                   <span class="p">(</span><span class="n">deleting</span> <span class="o">==</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">NONE</span> <span class="ow">and</span> \
                    <span class="n">section</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">):</span>
                    <span class="n">covers</span> <span class="o">=</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">NONE</span>
                    <span class="n">rd</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rd</span> <span class="o">=</span> <span class="n">dns_rdata</span><span class="o">.</span><span class="n">from_wire</span><span class="p">(</span><span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="n">rdlen</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">origin</span><span class="p">)</span>
                    <span class="n">covers</span> <span class="o">=</span> <span class="n">rd</span><span class="o">.</span><span class="n">covers</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">xfr</span> <span class="ow">and</span> <span class="n">rdtype</span> <span class="o">==</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">SOA</span><span class="p">:</span>
                    <span class="n">force_unique</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">rrset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">find_rrset</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                                <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">covers</span><span class="p">,</span>
                                                <span class="n">deleting</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">force_unique</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">rd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">rrset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">+</span> <span class="n">rdlen</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a wire format DNS message and build a dns_message.Message</span>
<span class="sd">        object.&quot;&quot;&quot;</span>

        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ShortHeader</span>
        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">flags</span><span class="p">,</span> <span class="n">qcount</span><span class="p">,</span> <span class="n">ancount</span><span class="p">,</span>
         <span class="n">aucount</span><span class="p">,</span> <span class="n">adcount</span><span class="p">)</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;!HHHHHH&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">[:</span><span class="mi">12</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="k">if</span> <span class="n">dns_opcode</span><span class="o">.</span><span class="n">is_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">flags</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_question</span><span class="p">(</span><span class="n">qcount</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">question_only</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span> <span class="n">ancount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">authority</span><span class="p">,</span> <span class="n">aucount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_section</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">additional</span><span class="p">,</span> <span class="n">adcount</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current</span> <span class="o">!=</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TrailingJunk</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">multi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tsig_ctx</span> <span class="ow">and</span> \
               <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">had_tsig</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tsig_ctx</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wire</span><span class="p">)</span>


<div class="viewcode-block" id="from_wire"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.from_wire">[docs]</a><span class="k">def</span> <span class="nf">from_wire</span><span class="p">(</span><span class="n">wire</span><span class="p">,</span> <span class="n">keyring</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">request_mac</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">xfr</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">tsig_ctx</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">multi</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
              <span class="n">question_only</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">one_rr_per_rrset</span> <span class="o">=</span> <span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert a DNS wire format message into a message</span>
<span class="sd">    object.</span>

<span class="sd">    @param keyring: The keyring to use if the message is signed.</span>
<span class="sd">    @type keyring: dict</span>
<span class="sd">    @param request_mac: If the message is a response to a TSIG-signed request,</span>
<span class="sd">    I{request_mac} should be set to the MAC of that request.</span>
<span class="sd">    @type request_mac: string</span>
<span class="sd">    @param xfr: Is this message part of a zone transfer?</span>
<span class="sd">    @type xfr: bool</span>
<span class="sd">    @param origin: If the message is part of a zone transfer, I{origin}</span>
<span class="sd">    should be the origin name of the zone.</span>
<span class="sd">    @type origin: dns_name.Name object</span>
<span class="sd">    @param tsig_ctx: The ongoing TSIG context, used when validating zone</span>
<span class="sd">    transfers.</span>
<span class="sd">    @type tsig_ctx: hmac.HMAC object</span>
<span class="sd">    @param multi: Is this message part of a multiple message sequence?</span>
<span class="sd">    @type multi: bool</span>
<span class="sd">    @param first: Is this message standalone, or the first of a multi</span>
<span class="sd">    message sequence?</span>
<span class="sd">    @type first: bool</span>
<span class="sd">    @param question_only: Read only up to the end of the question section?</span>
<span class="sd">    @type question_only: bool</span>
<span class="sd">    @param one_rr_per_rrset: Put each RR into its own RRset</span>
<span class="sd">    @type one_rr_per_rrset: bool</span>
<span class="sd">    @raises ShortHeader: The message is less than 12 octets long.</span>
<span class="sd">    @raises TrailingJunk: There were octets in the message past the end</span>
<span class="sd">    of the proper DNS message.</span>
<span class="sd">    @raises BadEDNS: An OPT record was in the wrong section, or occurred more</span>
<span class="sd">    than once.</span>
<span class="sd">    @raises BadTSIG: A TSIG record was not the last record of the additional</span>
<span class="sd">    data section.</span>
<span class="sd">    @rtype: dns_message.Message object&quot;&quot;&quot;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">keyring</span> <span class="o">=</span> <span class="n">keyring</span>
    <span class="n">m</span><span class="o">.</span><span class="n">request_mac</span> <span class="o">=</span> <span class="n">request_mac</span>
    <span class="n">m</span><span class="o">.</span><span class="n">xfr</span> <span class="o">=</span> <span class="n">xfr</span>
    <span class="n">m</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
    <span class="n">m</span><span class="o">.</span><span class="n">tsig_ctx</span> <span class="o">=</span> <span class="n">tsig_ctx</span>
    <span class="n">m</span><span class="o">.</span><span class="n">multi</span> <span class="o">=</span> <span class="n">multi</span>
    <span class="n">m</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="n">first</span>

    <span class="n">reader</span> <span class="o">=</span> <span class="n">_WireReader</span><span class="p">(</span><span class="n">wire</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">question_only</span><span class="p">,</span> <span class="n">one_rr_per_rrset</span><span class="p">)</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">m</span>

</div>
<span class="k">class</span> <span class="nc">_TextReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Text format reader.</span>

<span class="sd">    @ivar tok: the tokenizer</span>
<span class="sd">    @type tok: dns_tokenizer.Tokenizer object</span>
<span class="sd">    @ivar message: The message object being built</span>
<span class="sd">    @type message: dns_message.Message object</span>
<span class="sd">    @ivar updating: Is the message a dynamic update?</span>
<span class="sd">    @type updating: bool</span>
<span class="sd">    @ivar zone_rdclass: The class of the zone in messages which are</span>
<span class="sd">    DNS dynamic updates.</span>
<span class="sd">    @type zone_rdclass: int</span>
<span class="sd">    @ivar last_name: The most recently read name when building a message object</span>
<span class="sd">    from text format.</span>
<span class="sd">    @type last_name: dns_name.Name object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tok</span> <span class="o">=</span> <span class="n">dns_tokenizer</span><span class="o">.</span><span class="n">Tokenizer</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zone_rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">IN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_header_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process one line from the text format header section.&quot;&quot;&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="n">what</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&#39;flags&#39;</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_identifier</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">unget</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">flags</span> <span class="o">|</span> \
                                     <span class="n">dns_flags</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dns_opcode</span><span class="o">.</span><span class="n">is_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">flags</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">updating</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&#39;edns&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">|</span> \
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edns</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&#39;eflags&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edns</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_identifier</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">unget</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">ednsflags</span> <span class="o">|</span> \
                              <span class="n">dns_flags</span><span class="o">.</span><span class="n">edns_from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&#39;payload&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_int</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edns</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">edns</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&#39;opcode&#39;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">flags</span> <span class="o">|</span> \
                      <span class="n">dns_opcode</span><span class="o">.</span><span class="n">to_flags</span><span class="p">(</span><span class="n">dns_opcode</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">what</span> <span class="o">==</span> <span class="s">&#39;rcode&#39;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_string</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">set_rcode</span><span class="p">(</span><span class="n">dns_rcode</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnknownHeaderField</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_eol</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_question_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process one line from the text format question section.&quot;&quot;&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">want_leading</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_whitespace</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">dns_name</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_identifier</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
        <span class="c"># Class</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_identifier</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
        <span class="k">except</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">IN</span>
        <span class="c"># Type</span>
        <span class="n">rdtype</span> <span class="o">=</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">find_rrset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">force_unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">updating</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zone_rdclass</span> <span class="o">=</span> <span class="n">rdclass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_eol</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_rr_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process one line from the text format answer, authority, or</span>
<span class="sd">        additional data sections.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">deleting</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># Name</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">want_leading</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_whitespace</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">dns_name</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_identifier</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
        <span class="c"># TTL</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ttl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_identifier</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
        <span class="k">except</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ttl</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># Class</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_identifier</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
            <span class="k">if</span> <span class="n">rdclass</span> <span class="o">==</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">ANY</span> <span class="ow">or</span> <span class="n">rdclass</span> <span class="o">==</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">NONE</span><span class="p">:</span>
                <span class="n">deleting</span> <span class="o">=</span> <span class="n">rdclass</span>
                <span class="n">rdclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone_rdclass</span>
        <span class="k">except</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">SyntaxError</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">IN</span>
        <span class="c"># Type</span>
        <span class="n">rdtype</span> <span class="o">=</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">is_eol_or_eof</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">unget</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="n">dns_rdata</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">covers</span> <span class="o">=</span> <span class="n">rd</span><span class="o">.</span><span class="n">covers</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rd</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">covers</span> <span class="o">=</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">NONE</span>
        <span class="n">rrset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">find_rrset</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                        <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">covers</span><span class="p">,</span>
                                        <span class="n">deleting</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">updating</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rrset</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a text format DNS message and build a dns_message.Message</span>
<span class="sd">        object.&quot;&quot;&quot;</span>

        <span class="n">line_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_line</span>
        <span class="n">section</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">is_eol_or_eof</span><span class="p">():</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">is_comment</span><span class="p">():</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;HEADER&#39;</span><span class="p">:</span>
                    <span class="n">line_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_header_line</span>
                <span class="k">elif</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;QUESTION&#39;</span> <span class="ow">or</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;ZONE&#39;</span><span class="p">:</span>
                    <span class="n">line_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_question_line</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">question</span>
                <span class="k">elif</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;ANSWER&#39;</span> <span class="ow">or</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;PREREQ&#39;</span><span class="p">:</span>
                    <span class="n">line_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rr_line</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">answer</span>
                <span class="k">elif</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;AUTHORITY&#39;</span> <span class="ow">or</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;UPDATE&#39;</span><span class="p">:</span>
                    <span class="n">line_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rr_line</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">authority</span>
                <span class="k">elif</span> <span class="n">u</span> <span class="o">==</span> <span class="s">&#39;ADDITIONAL&#39;</span><span class="p">:</span>
                    <span class="n">line_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rr_line</span>
                    <span class="n">section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">additional</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">get_eol</span><span class="p">()</span>
                <span class="k">continue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tok</span><span class="o">.</span><span class="n">unget</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">line_method</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>


<div class="viewcode-block" id="from_text"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.from_text">[docs]</a><span class="k">def</span> <span class="nf">from_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert the text format message into a message object.</span>

<span class="sd">    @param text: The text format message.</span>
<span class="sd">    @type text: string</span>
<span class="sd">    @raises UnknownHeaderField:</span>
<span class="sd">    @raises dns_exception.SyntaxError:</span>
<span class="sd">    @rtype: dns_message.Message object&quot;&quot;&quot;</span>

    <span class="c"># &#39;text&#39; can also be a file, but we don&#39;t publish that fact</span>
    <span class="c"># since it&#39;s an implementation detail.  The official file</span>
    <span class="c"># interface is from_file().</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>

    <span class="n">reader</span> <span class="o">=</span> <span class="n">_TextReader</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">m</span>
</div>
<div class="viewcode-block" id="from_file"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.from_file">[docs]</a><span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the next text format message from the specified file.</span>

<span class="sd">    @param f: file or string.  If I{f} is a string, it is treated</span>
<span class="sd">    as the name of a file to open.</span>
<span class="sd">    @raises UnknownHeaderField:</span>
<span class="sd">    @raises dns_exception.SyntaxError:</span>
<span class="sd">    @rtype: dns_message.Message object&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="mh">0x02030000</span><span class="p">:</span>
        <span class="c"># allow Unicode filenames; turn on universal newline support</span>
        <span class="n">str_type</span> <span class="o">=</span> <span class="nb">basestring</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="s">&#39;rU&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">str_type</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="s">&#39;r&#39;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">str_type</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
        <span class="n">want_close</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">want_close</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">from_text</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">want_close</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">m</span>
</div>
<div class="viewcode-block" id="make_query"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.make_query">[docs]</a><span class="k">def</span> <span class="nf">make_query</span><span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">IN</span><span class="p">,</span> <span class="n">use_edns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">want_dnssec</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a query message.</span>

<span class="sd">    The query name, type, and class may all be specified either</span>
<span class="sd">    as objects of the appropriate type, or as strings.</span>

<span class="sd">    The query will have a randomly choosen query id, and its DNS flags</span>
<span class="sd">    will be set to dns_flags.RD.</span>

<span class="sd">    @param qname: The query name.</span>
<span class="sd">    @type qname: dns_name.Name object or string</span>
<span class="sd">    @param rdtype: The desired rdata type.</span>
<span class="sd">    @type rdtype: int</span>
<span class="sd">    @param rdclass: The desired rdata class; the default is class IN.</span>
<span class="sd">    @type rdclass: int</span>
<span class="sd">    @param use_edns: The EDNS level to use; the default is None (no EDNS).</span>
<span class="sd">    See the description of dns_message.Message.use_edns() for the possible</span>
<span class="sd">    values for use_edns and their meanings.</span>
<span class="sd">    @type use_edns: int or bool or None</span>
<span class="sd">    @param want_dnssec: Should the query indicate that DNSSEC is desired?</span>
<span class="sd">    @type want_dnssec: bool</span>
<span class="sd">    @rtype: dns_message.Message object&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qname</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
        <span class="n">qname</span> <span class="o">=</span> <span class="n">dns_name</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">qname</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rdtype</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
        <span class="n">rdtype</span> <span class="o">=</span> <span class="n">dns_rdatatype</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">rdtype</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rdclass</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
        <span class="n">rdclass</span> <span class="o">=</span> <span class="n">dns_rdataclass</span><span class="o">.</span><span class="n">from_text</span><span class="p">(</span><span class="n">rdclass</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Message</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">RD</span>
    <span class="n">m</span><span class="o">.</span><span class="n">find_rrset</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">question</span><span class="p">,</span> <span class="n">qname</span><span class="p">,</span> <span class="n">rdclass</span><span class="p">,</span> <span class="n">rdtype</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">force_unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">use_edns</span><span class="p">(</span><span class="n">use_edns</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">want_dnssec</span><span class="p">(</span><span class="n">want_dnssec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span>
</div>
<div class="viewcode-block" id="make_response"><a class="viewcode-back" href="../../../pytomo.dns.html#pytomo.dns.message.make_response">[docs]</a><span class="k">def</span> <span class="nf">make_response</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">recursion_available</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">our_payload</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a message which is a response for the specified query.</span>
<span class="sd">    The message returned is really a response skeleton; it has all</span>
<span class="sd">    of the infrastructure required of a response, but none of the</span>
<span class="sd">    content.</span>

<span class="sd">    The response&#39;s question section is a shallow copy of the query&#39;s</span>
<span class="sd">    question section, so the query&#39;s question RRsets should not be</span>
<span class="sd">    changed.</span>

<span class="sd">    @param query: the query to respond to</span>
<span class="sd">    @type query: dns_message.Message object</span>
<span class="sd">    @param recursion_available: should RA be set in the response?</span>
<span class="sd">    @type recursion_available: bool</span>
<span class="sd">    @param our_payload: payload size to advertise in EDNS responses; default</span>
<span class="sd">    is 8192.</span>
<span class="sd">    @type our_payload: int</span>
<span class="sd">    @rtype: dns_message.Message object&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">QR</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">dns_exception</span><span class="o">.</span><span class="n">FormError</span><span class="p">(</span><span class="s">&#39;specified query message is not a query&#39;</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">QR</span> <span class="o">|</span> <span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">RD</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">recursion_available</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">dns_flags</span><span class="o">.</span><span class="n">RA</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_opcode</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">opcode</span><span class="p">())</span>
    <span class="n">response</span><span class="o">.</span><span class="n">question</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">question</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">query</span><span class="o">.</span><span class="n">edns</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">use_edns</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">our_payload</span><span class="p">,</span> <span class="n">query</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">query</span><span class="o">.</span><span class="n">keyname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">keyname</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">keyname</span>
        <span class="n">response</span><span class="o">.</span><span class="n">keyring</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">keyring</span>
        <span class="n">response</span><span class="o">.</span><span class="n">request_mac</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">mac</span>
    <span class="k">return</span> <span class="n">response</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Pytomo 2.8.6 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Louis Plissoneau.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>