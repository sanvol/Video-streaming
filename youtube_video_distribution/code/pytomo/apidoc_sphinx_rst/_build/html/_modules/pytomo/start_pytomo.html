

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pytomo.start_pytomo &mdash; Pytomo 2.8.6 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.8.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Pytomo 2.8.6 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pytomo 2.8.6 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pytomo.start_pytomo</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Module to launch a crawl.</span>
<span class="sd">This module supplies the following functions that can be used</span>
<span class="sd">independently:</span>
<span class="sd">    1. compute_stats: To calculate the download statistics of a URL.</span>

<span class="sd">    Usage:</span>
<span class="sd">        To use the functions provided in this module independently,</span>
<span class="sd">        first place yourself just above pytomo folder.Then:</span>

<span class="sd">import pytomo.start_pytomo as start_pytomo</span>
<span class="sd">import pytomo.config_pytomo as config_pytomo</span>
<span class="sd">config_pytomo.LOG_FILE = &#39;-&#39;</span>
<span class="sd">import time</span>
<span class="sd">timestamp = time.strftime(&#39;%Y-%m-%d.%H_%M_%S&#39;)</span>
<span class="sd">log_file = start_pytomo.configure_log_file(timestamp)</span>
<span class="sd">import platform</span>
<span class="sd">config_pytomo.SYSTEM = platform.system()</span>
<span class="sd">url = &#39;http://youtu.be/3VdOTTfSKyM&#39;</span>
<span class="sd">start_pytomo.compute_stats(url)</span>
<span class="sd"># test Dailymotion</span>
<span class="sd">url = &#39;http://www.dailymotion.com/video/xscdm4_le-losc-au-pays-basque_sport?no_track=1&#39;</span>

<span class="sd">import pytomo.start_pytomo as start_pytomo</span>
<span class="sd">import pytomo.config_pytomo as config_pytomo</span>
<span class="sd">config_pytomo.LOG_FILE = &#39;-&#39;</span>
<span class="sd">import time</span>
<span class="sd">timestamp = time.strftime(&#39;%Y-%m-%d.%H_%M_%S&#39;)</span>
<span class="sd">log_file = start_pytomo.configure_log_file(timestamp)</span>
<span class="sd">import platform</span>
<span class="sd">config_pytomo.SYSTEM = platform.system()</span>

<span class="sd"># video delivered by akamai CDN</span>
<span class="sd">url = &#39;http://www.dailymotion.com/video/xp9fq9_test-video-akamai_tech&#39;</span>
<span class="sd">start_pytomo.compute_stats(url)</span>
<span class="sd"># redirect url: do not work</span>
<span class="sd">url = &#39;http://vid.ak.dmcdn.net/video/986/034/42430689_mp4_h264_aac.mp4?primaryToken=1343398942_d77027d09aac0c5d5de74d5428fb9e5b&#39;</span>
<span class="sd">start_pytomo.compute_stats(url, redirect=True)</span>

<span class="sd"># video delivered by edgecast CDN</span>
<span class="sd">url = &#39;http://www.dailymotion.com/video/xmcyww_test-video-cell-edgecast_tech&#39;</span>
<span class="sd">start_pytomo.compute_stats(url)</span>
<span class="sd">url = &#39;http://vid.ec.dmcdn.net/cdn/H264-512x384/video/xmcyww.mp4?77838fedd64fa52abe6a11b3bdbb4e62f4387ebf7cbce2147ea4becc5eee5c418aaa6598bb98a61fc95a02997247e59bfb0dcd58cdf05c1601ded04f75ae357b225da725baad5e97ea6cce6d6a12e17d1c01&#39;</span>
<span class="sd">start_pytomo.compute_stats(url, redirect=True)</span>

<span class="sd"># video delivered by dailymotion servers</span>
<span class="sd">url = &#39;http://www.dailymotion.com/video/xmcyw2_test-video-cell-core_tech&#39;</span>
<span class="sd">start_pytomo.compute_stats(url)</span>
<span class="sd">url = &#39;http://proxy-60.dailymotion.com/video/246/655/37556642_mp4_h264_aac.mp4?auth=1343399602-4098-bdkyfgul-eb00ad223e1964e40b327d75367b273b&#39;</span>
<span class="sd">start_pytomo.compute_stats(url, redirect=True)</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span><span class="p">,</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlsplit</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">strftime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">maketrans</span><span class="p">,</span> <span class="n">lowercase</span>
<span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">OptionParser</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">abspath</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">sep</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">concat</span><span class="p">,</span> <span class="n">itemgetter</span><span class="p">,</span> <span class="n">eq</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">Error</span>
<span class="c">#from ast import literal_eval</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="c"># assumes the standard distribution paths</span>
<span class="n">PACKAGE_DIR</span> <span class="o">=</span> <span class="n">dirname</span><span class="p">(</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="c">#PUBLIC_IP_FINDER = &#39;http://automation.whatismyip.com/n09230945.asp&#39;</span>
<span class="c">#PUBLIC_IP_FINDER = &#39;http://ipogre.com/linux.php&#39;</span>
<span class="n">PUBLIC_IP_FINDER</span> <span class="o">=</span> <span class="s">r&#39;http://stat.ripe.net/data/whats-my-ip/data.json&#39;</span>
<span class="n">AS_REQUEST_URL</span> <span class="o">=</span> <span class="s">r&#39;http://stat.ripe.net/data/routing-status/data.json?resource=&#39;</span>
<span class="c"># to store the request on /24 prefixes</span>
<span class="n">CACHED_PREFIXES</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="c"># give a default fake value for convenience</span>
<span class="n">CACHED_PREFIXES</span><span class="p">[</span><span class="s">&#39;0.0.0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">IP_MATCH_PATTERN</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}&#39;</span>
                    <span class="s">&#39;([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])$&#39;</span><span class="p">)</span>
<span class="n">SEPARATOR_LINE</span> <span class="o">=</span> <span class="s">&#39;#&#39;</span> <span class="o">*</span> <span class="mi">80</span>
<span class="n">YOUTUBE_SERVICE</span> <span class="o">=</span> <span class="s">&#39;youtube&#39;</span>
<span class="n">DAILYMOTION_SERVICE</span> <span class="o">=</span> <span class="s">&#39;dailymotion&#39;</span>
<span class="n">GALERIE_VIDEO_SERVICE</span> <span class="o">=</span> <span class="s">&#39;galerievideo.orange-business.com&#39;</span>
<span class="n">CONTINUOUS_CRAWL_SIZE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">PARAM_URL</span> <span class="o">=</span> <span class="s">&#39;Url&#39;</span>
<span class="c">#REDIRECT_CACHE_URL_PATTERN = &#39;.youtube.com/videoplayback?sparams=id&#39;</span>

<span class="c"># initial cache url regex</span>
<span class="c">#CACHE_URL_REGEXP = re.compile(r&#39;(http://o-o---preferred---sn-)(\w{8})&#39;</span>
<span class="c">#                              &#39;(---v\d{1,2}---lscache\d.c.youtube.com)&#39;)</span>
<span class="c"># updated</span>
<span class="c"># direct cache *o-o---preferred* or redirect *rXX*</span>
<span class="c"># *---*</span>
<span class="c"># *sn-* - will be omitted in the decrypted url</span>
<span class="c"># something like *25g7rn7r* or *vg5obx-hgne*</span>
<span class="c"># direct cache have *---vXX---lscacheX*</span>
<span class="c"># *.c.youtube.com*</span>
<span class="n">CACHE_URL_REGEXP</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(http://)(o-o---preferred|r\d{1,2})(---)(sn-)&#39;</span>
                              <span class="s">r&#39;(\w{6}-\w{4}|(?:-|\w{8}))(---v\d{1,2}---lscache\d){0,1}&#39;</span>
                              <span class="s">r&#39;(.c.youtube.com)&#39;</span><span class="p">)</span>
<span class="n">TRANSLATION</span> <span class="o">=</span> <span class="n">maketrans</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)))</span> <span class="o">+</span> <span class="n">lowercase</span><span class="p">,</span>
                               <span class="s">&#39;uzpkfa50vqlgb61wrmhc72xsnid83ytoje94&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">win32com.shell</span> <span class="kn">import</span> <span class="n">shell</span><span class="p">,</span> <span class="n">shellcon</span>
    <span class="n">HOME_DIR</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">SHGetFolderPath</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shellcon</span><span class="o">.</span><span class="n">CSIDL_PROFILE</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HOME_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">config_pytomo</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_dns</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_ping</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_youtube_download</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_dailymotion_download</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_general_download</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_galerie_download</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_database</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_youtube_api</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_dailymotion_api</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_links_extractor</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_data_centralisation</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">translation_cache_url</span>

<span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PLOT</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">lib_plot</span>

<span class="c"># default service is YouTube</span>
<span class="n">SERVICE</span> <span class="o">=</span> <span class="s">&#39;YouTube&#39;</span>

<div class="viewcode-block" id="select_libraries"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.select_libraries">[docs]</a><span class="k">def</span> <span class="nf">select_libraries</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the libraries to use for dowloading and retrieving specific</span>
<span class="sd">    links&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">DAILYMOTION_SERVICE</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s">&#39;dmcdn&#39;</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s">&#39;dmcloud&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">lib_download</span> <span class="o">=</span> <span class="n">lib_dailymotion_download</span>
        <span class="n">lib_api</span> <span class="o">=</span> <span class="n">lib_dailymotion_api</span>
    <span class="k">elif</span> <span class="n">YOUTUBE_SERVICE</span> <span class="ow">in</span> <span class="n">url</span> <span class="ow">or</span> <span class="s">&#39;youtu.be&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">lib_download</span> <span class="o">=</span> <span class="n">lib_youtube_download</span>
        <span class="n">lib_api</span> <span class="o">=</span> <span class="n">lib_youtube_api</span>
    <span class="k">elif</span> <span class="n">GALERIE_VIDEO_SERVICE</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">lib_download</span> <span class="o">=</span> <span class="n">lib_galerie_download</span>
        <span class="n">lib_api</span> <span class="o">=</span> <span class="n">lib_dailymotion_api</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;only YouTube and Dailymotion download &#39;</span>
                                   <span class="s">&#39;are implemented&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lib_download</span><span class="p">,</span> <span class="n">lib_api</span><span class="p">)</span>

<span class="c">#def translate_cache_url(url):</span>
<span class="c">#    &#39;&#39;&#39; Return decrypted cache url name, using monoalphabetic cipher:</span>
<span class="c">#        digits, letters -&gt; uzpkfa50vqlgb61wrmhc72xsnid83ytoje94</span>
<span class="c">#    Assumes all cache servers that match pattern are encrypted, otherwise</span>
<span class="c">#    it returns original address. Unencrypted cache urls still exist, they do</span>
<span class="c">#    not contain *--sn* (http://r3---orange-mrs2.c.youtube.com/).</span>
<span class="c">#    &gt;&gt;&gt; url = &#39;http://o-o---preferred---sn-25g7rn7k---v18---lscache1.c.youtube.com/&#39;</span>
<span class="c">#    &gt;&gt;&gt; translate_cache_url(url)</span>
<span class="c">#    &#39;http://o-o---preferred---par08s07---v18---lscache1.c.youtube.com&#39;</span>
<span class="c">#    &gt;&gt;&gt; url = &#39;http://o-o---preferred---sn-vg5obx-hgnl---v16---lscache6.c.youtube.com&#39;</span>
<span class="c">#    &gt;&gt;&gt; translate_cache_url(url)</span>
<span class="c">#    &#39;http://o-o---preferred---orange-mrs2---v16---lscache6.c.youtube.com&#39;</span>
<span class="c">#    &gt;&gt;&gt; url = &#39;http://r10---sn-25g7rn7l.c.youtube.com/&#39;</span>
<span class="c">#    &gt;&gt;&gt; translate_cache_url(url)</span>
<span class="c">#    &#39;http://r10---par08s02.c.youtube.com&#39;</span>
<span class="c">#    &gt;&gt;&gt; url = &#39;http://r3---orange-mrs2.c.youtube.com/&#39;</span>
<span class="c">#    &gt;&gt;&gt; translate_cache_url(url)</span>
<span class="c">#    &#39;http://r3---orange-mrs2.c.youtube.com/&#39;</span>
<span class="c">#    &gt;&gt;&gt; url = &#39;http://r6---sn-5up-u0ol.c.youtube.com&#39;</span>
<span class="c">#    &gt;&gt;&gt; translate_cache_url(url)</span>
<span class="c">#    &#39;http://r6---ati-tun2.c.youtube.com&#39;</span>
<span class="c">#    &#39;&#39;&#39;</span>
<span class="c">#    match = CACHE_URL_REGEXP.match(url)</span>
<span class="c">#    config_pytomo.LOG.debug(&#39;translating url: %s&#39; % url)</span>
<span class="c">#    if not match:</span>
<span class="c">#        config_pytomo.LOG.debug(&#39;no match&#39;)</span>
<span class="c">#        new_url = url</span>
<span class="c">#    else:</span>
<span class="c">#        groups = match.groups()</span>
<span class="c">#        assert len(groups) == 7</span>
<span class="c">#        groups = filter(None, groups)</span>
<span class="c">#        new_url = (&#39;&#39;.join((groups[0:3])) + groups[4].translate(TRANSLATION) +</span>
<span class="c">#                   &#39;&#39;.join((groups[5:])))</span>
<span class="c">#    config_pytomo.LOG.debug(&#39;url translated as: %s&#39; % new_url)</span>
<span class="c">#    return new_url</span>
</div>
<div class="viewcode-block" id="compute_stats"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.compute_stats">[docs]</a><span class="k">def</span> <span class="nf">compute_stats</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache_uri</span><span class="p">,</span> <span class="n">do_download_stats</span><span class="p">,</span> <span class="n">redirect_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">do_full_crawl</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="s">&#39;&#39;</span> <span class="s">&#39;Return a list of the statistics related to the url&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_uri</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">current_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c"># the cache url server where the video is stored</span>
    <span class="c"># &lt;scheme&gt;://&lt;netloc&gt;/&lt;path&gt;?&lt;query&gt;#&lt;fragment&gt;</span>
    <span class="n">parsed_uri</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">cache_uri</span><span class="p">)</span>
    <span class="n">cache_url</span> <span class="o">=</span> <span class="s">&#39;://&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">parsed_uri</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">parsed_uri</span><span class="o">.</span><span class="n">netloc</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">YOUTUBE_SERVICE</span><span class="p">:</span>
        <span class="n">cache_url</span> <span class="o">=</span> <span class="n">translation_cache_url</span><span class="o">.</span><span class="n">translate_cache_url</span><span class="p">(</span><span class="n">cache_url</span><span class="p">)</span>
    <span class="c">#cache_urn = &#39;?&#39;.join((parsed_uri.path, parsed_uri.query))</span>
    <span class="n">ip_addresses</span> <span class="o">=</span> <span class="n">lib_dns</span><span class="o">.</span><span class="n">get_ip_addresses</span><span class="p">(</span><span class="n">parsed_uri</span><span class="o">.</span><span class="n">netloc</span><span class="p">)</span>
    <span class="c"># in case there is a problem in the DNS, for the variables to be bound</span>
    <span class="k">if</span> <span class="n">redirect_url</span><span class="p">:</span>
        <span class="n">parsed_uri</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span>
        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s">&#39;://&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">parsed_uri</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">parsed_uri</span><span class="o">.</span><span class="n">netloc</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">YOUTUBE_SERVICE</span><span class="p">:</span>
            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">translation_cache_url</span><span class="o">.</span><span class="n">translate_cache_url</span><span class="p">(</span>
                                                                   <span class="n">redirect_url</span><span class="p">)</span>
    <span class="n">redirect_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">req_time</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ip_addresses</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Compute stats for IP: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">ip_address</span><span class="p">)</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">in</span> <span class="n">current_stats</span> <span class="ow">and</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">SKIP_COMPUTED</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Skip IP already crawled: </span><span class="si">%s</span><span class="s">&#39;</span>
                                        <span class="o">%</span> <span class="n">ip_address</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ping_times</span> <span class="o">=</span> <span class="n">lib_ping</span><span class="o">.</span><span class="n">ping_ip</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_download_stats</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&#39;default&#39;</span> <span class="ow">in</span> <span class="n">resolver</span>
                                  <span class="ow">or</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DOWNLOAD_FROM_EXTRA_IPS</span><span class="p">):</span>
            <span class="p">(</span><span class="n">download_stats</span><span class="p">,</span> <span class="n">new_redirect_url</span><span class="p">,</span>
             <span class="n">status_code</span><span class="p">)</span> <span class="o">=</span> <span class="n">compute_download_stats</span><span class="p">(</span><span class="n">resolver</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span>
                                                   <span class="n">cache_uri</span><span class="p">,</span> <span class="n">current_stats</span><span class="p">,</span>
                                                   <span class="n">do_full_crawl</span><span class="o">=</span><span class="n">do_full_crawl</span><span class="p">)</span>
            <span class="n">redirect_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_redirect_url</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">download_stats</span><span class="p">,</span> <span class="n">new_redirect_url</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">ProxyHandler</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">)</span>
            <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
            <span class="n">urllib2</span><span class="o">.</span><span class="n">install_opener</span><span class="p">(</span><span class="n">opener</span><span class="p">)</span>
        <span class="c"># we do consider only /24 prefixes</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ip_address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">CACHED_PREFIXES</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># HARD CODED fields of json data</span>
                <span class="n">as_nb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span>
                    <span class="n">AS_REQUEST_URL</span> <span class="o">+</span> <span class="n">ip_address</span><span class="p">))[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;last_seen&#39;</span><span class="p">][</span><span class="s">&#39;origin&#39;</span><span class="p">])</span>
                <span class="n">CACHED_PREFIXES</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">as_nb</span>
                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;IP </span><span class="si">%s</span><span class="s"> resolved as AS: </span><span class="si">%d</span><span class="s">&#39;</span>
                                        <span class="o">%</span> <span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">as_nb</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">mes</span><span class="p">:</span>
                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">mes</span><span class="p">)</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s">&#39;0.0.0&#39;</span>
        <span class="n">current_stats</span><span class="p">[</span><span class="n">ip_address</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">ping_times</span><span class="p">,</span> <span class="n">download_stats</span><span class="p">,</span>
                                     <span class="n">redirect_url</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">req_time</span><span class="p">,</span>
                                     <span class="n">CACHED_PREFIXES</span><span class="p">[</span><span class="n">prefix</span><span class="p">],</span> <span class="n">status_code</span><span class="p">]</span>
    <span class="c"># check if cache_url is the same independently of DNS: YES only depend on</span>
    <span class="c"># video id</span>
    <span class="c">#assert reduce(eq, redirect_list)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;new redirect urls: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">redirect_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache_url</span><span class="p">,</span> <span class="n">current_stats</span><span class="p">),</span> <span class="n">redirect_list</span>
</div>
<div class="viewcode-block" id="compute_download_stats"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.compute_download_stats">[docs]</a><span class="k">def</span> <span class="nf">compute_download_stats</span><span class="p">(</span><span class="n">resolver</span><span class="p">,</span> <span class="n">ip_address</span><span class="p">,</span> <span class="n">cache_uri</span><span class="p">,</span> <span class="n">current_stats</span><span class="p">,</span>
                            <span class="n">do_full_crawl</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c">#redirect=False,</span>
    <span class="s">&#39;&#39;</span> <span class="s">&#39;Return a list of the download statistics related to the cache_uri&#39;&#39;&#39;</span>
    <span class="c"># it&#39;s important to pass the uri with the ip_address to avoid</span>
    <span class="c"># uncontrolled DNS resolution</span>
    <span class="k">if</span> <span class="n">do_full_crawl</span><span class="p">:</span>
        <span class="n">d_time</span> <span class="o">=</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_DOWNLOAD_TIME</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d_time</span> <span class="o">=</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DOWNLOAD_TIME</span>
    <span class="c"># may be done multiple times in case of different IP addresses</span>
    <span class="c"># resolved and uncaught errors on each IP</span>
    <span class="n">redirect_url</span> <span class="o">=</span> <span class="bp">None</span>
<span class="c">#    if &#39;default&#39; in resolver:</span>
<span class="c">#    config_pytomo.LOG.debug(&#39;trying url without IP&#39;)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">status_code</span><span class="p">,</span> <span class="n">download_stats</span><span class="p">,</span> <span class="n">redirect_url</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">lib_general_download</span><span class="o">.</span><span class="n">get_download_stats</span><span class="p">(</span><span class="n">cache_uri</span><span class="p">,</span>
                                        <span class="n">ip_address</span><span class="p">,</span> <span class="n">download_time</span><span class="o">=</span><span class="n">d_time</span><span class="p">))</span>
                                                <span class="c">#redirect=redirect))</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">urllib2</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">,</span> <span class="p">),</span> <span class="n">nested_err</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">nested_err</span><span class="p">)</span>
        <span class="c"># do nothing</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="p">),</span> <span class="n">mes</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;no data&#39;</span><span class="p">)</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">mes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">mes</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Uncaught exception: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mes</span><span class="p">)</span>
        <span class="c">#import pdb; pdb.set_trace()</span>
        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
<span class="c">#    else:</span>
<span class="c">#        # stats can thus be collected only on default resolver</span>
<span class="c">#        if ip_address in current_stats:</span>
<span class="c">#            # HARD CODED current_stats index: BAD</span>
<span class="c">#            download_stats = current_stats[ip_address][2]</span>
<span class="c">#        else:</span>
<span class="c">#            download_stats = None</span>
    <span class="k">return</span> <span class="n">download_stats</span><span class="p">,</span> <span class="n">redirect_url</span><span class="p">,</span> <span class="n">status_code</span>
</div>
<div class="viewcode-block" id="format_stats"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.format_stats">[docs]</a><span class="k">def</span> <span class="nf">format_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">cache_server_delay</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="n">SERVICE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the stats as a list of tuple to insert into database</span>
<span class="sd">    &gt;&gt;&gt; stats = (&#39;http://www.youtube.com/watch?v=RcmKbTR--iA&#39;,</span>
<span class="sd">    ...            &#39;http://v15.lscache3.c.youtube.com&#39;,</span>
<span class="sd">    ...             {&#39;173.194.20.56&#39;: [datetime.datetime(</span>
<span class="sd">    ...                                 2011, 5, 6, 15, 30, 50, 103775),</span>
<span class="sd">    ...                                 None,</span>
<span class="sd">    ...                                [8.9944229125976562, &#39;mp4&#39;,</span>
<span class="sd">    ...                                225,</span>
<span class="sd">    ...                                115012833.0,</span>
<span class="sd">    ...                                511168.14666666667,</span>
<span class="sd">    ...                                9575411,</span>
<span class="sd">    ...                                0,</span>
<span class="sd">    ...                                0.99954795837402344,</span>
<span class="sd">    ...                                7.9875903129577637,</span>
<span class="sd">    ...                                11.722306421319782,</span>
<span class="sd">    ...                                1192528.8804511931, 15169],</span>
<span class="sd">    ...                              None, &#39;default_10.193.225.12&#39;]})</span>

<span class="sd">    &gt;&gt;&gt; format_stats(stats) #doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        [(datetime.datetime(2011, 5, 6, 15, 30, 50, 103775),</span>
<span class="sd">          &#39;Youtube&#39;, &#39;http://www.youtube.com/watch?v=RcmKbTR--iA&#39;,</span>
<span class="sd">      &#39;http://v15.lscache3.c.youtube.com&#39;, &#39;173.194.20.56&#39;,</span>
<span class="sd">       &#39;default_10.193.225.12&#39;, 15169, None, None, None, 8.9944229125976562,</span>
<span class="sd">      &#39;mp4&#39;, 225, 115012833.0, 511168.14666666667, 9575411, 0,</span>
<span class="sd">     0.99954795837402344, 7.9875903129577637, 11.722306421319782,</span>
<span class="sd">      1192528.8804511931, None)]</span>

<span class="sd">    &gt;&gt;&gt; stats = (&#39;http://www.youtube.com/watch?v=OdF-oiaICZI&#39;,</span>
<span class="sd">    ...  &#39;http://v7.lscache8.c.youtube.com&#39;,</span>
<span class="sd">    ...                 {&#39;74.125.105.226&#39;: [datetime.datetime(</span>
<span class="sd">    ...                                       2011, 5, 6, 15, 30, 50, 103775),</span>
<span class="sd">    ...                                     [26.0, 196.0, 82.0],</span>
<span class="sd">    ...                                     [30.311000108718872, &#39;mp4&#39;,</span>
<span class="sd">    ...                                      287.487, 16840065.0,</span>
<span class="sd">    ...                                      58576.78781997099,</span>
<span class="sd">    ...                                      1967199, 0,</span>
<span class="sd">    ...                                      1.316999912261963,</span>
<span class="sd">    ...                                      28.986000061035156,</span>
<span class="sd">    ...                                      5.542251416248594,</span>
<span class="sd">    ...                                      1109.4598961624772, 15169],</span>
<span class="sd">    ...                                    &#39;http://www.youtube.com/fake_redirect&#39;,</span>
<span class="sd">    ...                       &#39;google_public_dns_8.8.8.8_open_dns_208.67.220.220&#39;],</span>
<span class="sd">    ...                  &#39;173.194.8.226&#39;: [datetime.datetime(2011, 5, 6, 15,</span>
<span class="sd">    ...                                                       30, 51, 103775),</span>
<span class="sd">    ...                                    [103.0, 108.0, 105.0],</span>
<span class="sd">    ...                                    [30.287999868392944, &#39;mp4&#39;,</span>
<span class="sd">    ...                                     287.487, 16840065.0,</span>
<span class="sd">    ...                                     58576.78781997099,</span>
<span class="sd">    ...                                     2307716,</span>
<span class="sd">    ...                                     0,</span>
<span class="sd">    ...                                     1.3849999904632568,</span>
<span class="sd">    ...                                     28.89300012588501,</span>
<span class="sd">    ...                                     11.47842453761781,</span>
<span class="sd">    ...                                     32770.37517215069, 15169],</span>
<span class="sd">    ...                                    None, &#39;default_212.234.161.118&#39;]})</span>


<span class="sd">    &gt;&gt;&gt; format_stats(stats) #doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    [(datetime.datetime(2011, 5, 6, 15, 30, 50, 103775),</span>
<span class="sd">       &#39;Youtube&#39;, &#39;http://www.youtube.com/watch?v=OdF-oiaICZI&#39;,</span>
<span class="sd">      &#39;http://v7.lscache8.c.youtube.com&#39;, &#39;74.125.105.226&#39;,</span>
<span class="sd">            &#39;google_public_dns_8.8.8.8_open_dns_208.67.220.220&#39;, 15169, 26.0, 196.0, 82.0,</span>
<span class="sd">      30.311000108718872, &#39;mp4&#39;, 287.48700000000002, 16840065.0,</span>
<span class="sd">      58576.787819970988, 1967199, 0, 1.3169999122619629,</span>
<span class="sd">      28.986000061035156, 5.5422514162485941, 1109.4598961624772,</span>
<span class="sd">      &#39;http://www.youtube.com/fake_redirect&#39;),</span>
<span class="sd">     (datetime.datetime(2011, 5, 6, 15, 30, 51, 103775),</span>
<span class="sd">      &#39;Youtube&#39;, &#39;http://www.youtube.com/watch?v=OdF-oiaICZI&#39;,</span>
<span class="sd">      &#39;http://v7.lscache8.c.youtube.com&#39;, &#39;173.194.8.226&#39;,</span>
<span class="sd">      &#39;default_212.234.161.118&#39;, 103.0, 108.0, 105.0, 30.287999868392944,</span>
<span class="sd">      &#39;mp4&#39;, 287.48700000000002, 16840065.0, 58576.787819970988, 2307716,</span>
<span class="sd">      0, 1.3849999904632568, 28.89300012588501, 11.47842453761781,</span>
<span class="sd">      32770.375172150692, None)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">record_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache_url</span><span class="p">,</span> <span class="n">current_stats</span><span class="p">)</span> <span class="o">=</span> <span class="n">stats</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span> <span class="ow">in</span> <span class="n">current_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">ping_times</span><span class="p">,</span> <span class="n">download_stats</span><span class="p">,</span> <span class="n">redirect_url</span><span class="p">,</span>
         <span class="n">resolver</span><span class="p">,</span> <span class="n">req_time</span><span class="p">,</span> <span class="n">as_nb</span><span class="p">,</span> <span class="n">status_code</span><span class="p">)</span> <span class="o">=</span> <span class="n">values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ping_times</span><span class="p">:</span>
            <span class="n">ping_times</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">NB_PING_VALUES</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">download_stats</span><span class="p">:</span>
            <span class="n">download_stats</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">NB_DOWNLOAD_VALUES</span>
        <span class="c"># use inet_aton(ip_address) for optimisation on this field</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">([</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">cache_url</span><span class="p">,</span> <span class="n">cache_server_delay</span><span class="p">,</span>
                <span class="n">ip_address</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">req_time</span><span class="p">,</span> <span class="n">as_nb</span><span class="p">]</span>
               <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">ping_times</span><span class="p">)</span> <span class="o">+</span> <span class="n">download_stats</span> <span class="o">+</span> <span class="p">[</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">status_code</span><span class="p">])</span>
        <span class="n">record_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">record_list</span>
</div>
<div class="viewcode-block" id="check_out_files"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.check_out_files">[docs]</a><span class="k">def</span> <span class="nf">check_out_files</span><span class="p">(</span><span class="n">file_pattern</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a full path of the file used for the output</span>
<span class="sd">    Test if the path exists, create if possible or create it in default user</span>
<span class="sd">    directory</span>

<span class="sd">    &gt;&gt;&gt; file_pattern = None</span>
<span class="sd">    &gt;&gt;&gt; directory = &#39;logs&#39;</span>
<span class="sd">    &gt;&gt;&gt; timestamp = &#39;doc_test&#39;</span>
<span class="sd">    &gt;&gt;&gt; check_out_files(file_pattern, directory, timestamp) #doctest: +ELLIPSIS</span>
<span class="sd">    &gt;&gt;&gt; file_pattern = &#39;pytomo.log&#39;</span>
<span class="sd">    &gt;&gt;&gt; check_out_files(file_pattern, directory, timestamp) #doctest: +ELLIPSIS</span>
<span class="sd">    &#39;...doc_test.pytomo.log&#39;</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_pattern</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">USE_PACKAGE_DIR</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">PACKAGE_DIR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">mes</span><span class="p">:</span>
                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s">&#39;Out dir </span><span class="si">%s</span><span class="s"> does not exist and cannot be created</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">mes</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">HOME_DIR</span><span class="p">:</span>
                    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Will use home base dir: </span><span class="si">%s</span><span class="s">&#39;</span>
                                           <span class="o">%</span> <span class="n">HOME_DIR</span><span class="p">)</span>
                    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_dir</span><span class="p">):</span>
                        <span class="c"># do not catch OSError as it&#39;s our second attempt</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s">&#39;Impossible to create output file: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">file_pattern</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">IOError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="c"># AO 27112012 modified to also include service (yt, dm)</span>
    <span class="n">crawl_service_provider</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span> <span class="o">+</span>
                              <span class="p">(</span><span class="s">&#39;_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROVIDER</span>
                               <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROVIDER</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">out_dir</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">(),</span>
                                            <span class="n">crawl_service_provider</span><span class="p">,</span>
                                            <span class="n">timestamp</span><span class="p">,</span> <span class="n">file_pattern</span><span class="p">))))</span>
    <span class="c"># do not catch IOError</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
        <span class="c"># just test writing in the out file</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">out_file</span>
</div>
<div class="viewcode-block" id="md5sum"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.md5sum">[docs]</a><span class="k">def</span> <span class="nf">md5sum</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
    <span class="s">&#39;Return the standard md5 of the file&#39;</span>
    <span class="c"># to cope with large files</span>
    <span class="c"># value taken from Python distribution</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">input_stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">),</span> <span class="n">mes</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Unable to compute the md5 of file: </span><span class="si">%s</span><span class="s">&#39;</span>
                                    <span class="o">%</span> <span class="n">mes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">8096</span>
    <span class="n">hash_value</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">input_stream</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bufsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">hash_value</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hash_value</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="MaxUrlException"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.MaxUrlException">[docs]</a><span class="k">class</span> <span class="nc">MaxUrlException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="s">&#39;Class to stop crawling when the max nb of urls has been attained&#39;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="add_stats"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.add_stats">[docs]</a><span class="k">def</span> <span class="nf">add_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">cache_server_delay</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">result_stream</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data_base</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Insert the stats in the db and update the crawled urls</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">result_stream</span><span class="p">:</span>
        <span class="n">pprint</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">result_stream</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_base</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">YOUTUBE_SERVICE</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s">&#39;YouTube&#39;</span>
        <span class="k">elif</span> <span class="n">DAILYMOTION_SERVICE</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s">&#39;Dailymotion&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">service</span> <span class="o">=</span> <span class="s">&#39;Unknown&#39;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">format_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">cache_server_delay</span><span class="p">,</span> <span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">):</span>
            <span class="n">data_base</span><span class="o">.</span><span class="n">insert_record</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="retrieve_cache_urls"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.retrieve_cache_urls">[docs]</a><span class="k">def</span> <span class="nf">retrieve_cache_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">lib_download</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return the list of cache url servers for a given video.</span>
<span class="sd">    The last element is the server from which the actual video is downloaded.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># cache url server dependent on the service</span>
    <span class="n">cache_uri</span> <span class="o">=</span> <span class="n">lib_download</span><span class="o">.</span><span class="n">get_cache_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_uri</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c"># list of cache urls</span>
    <span class="n">redirect_links</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nb_redirects</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">redirect_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cache_uri</span><span class="p">)</span>
    <span class="c"># try to connect to the cache url, check if there are more redirects</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">lib_links_extractor</span><span class="o">.</span><span class="n">retrieve_header</span><span class="p">(</span><span class="n">cache_uri</span><span class="p">)</span>
    <span class="c"># as long as you can retrieve the header and there are redirects</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">response</span> <span class="ow">and</span> <span class="n">nb_redirects</span> <span class="o">&lt;</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_NB_REDIRECT</span><span class="p">):</span>
        <span class="n">redirect_server</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">geturl</span><span class="p">()</span>
        <span class="c"># no more redirects</span>
        <span class="k">if</span> <span class="n">redirect_server</span> <span class="o">==</span> <span class="n">cache_uri</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">redirect_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">redirect_server</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">lib_links_extractor</span><span class="o">.</span><span class="n">retrieve_header</span><span class="p">(</span><span class="n">redirect_server</span><span class="p">)</span>
            <span class="n">cache_uri</span> <span class="o">=</span> <span class="n">redirect_server</span>
            <span class="n">nb_redirects</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">nb_redirects</span> <span class="o">&gt;</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_NB_REDIRECT</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;retrieve_redirect_links: Too many cache server&#39;</span>
                                <span class="s">&#39; redirects.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">redirect_links</span>
</div>
<div class="viewcode-block" id="check_full_download"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.check_full_download">[docs]</a><span class="k">def</span> <span class="nf">check_full_download</span><span class="p">(</span><span class="n">len_crawled_urls</span><span class="p">):</span>
    <span class="s">&#39;Check if the urls should be fully downloaded&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">FREQ_FULL_DOWNLOAD</span>
        <span class="ow">and</span> <span class="n">len_crawled_urls</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">FREQ_FULL_DOWNLOAD</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="crawl_link"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.crawl_link">[docs]</a><span class="k">def</span> <span class="nf">crawl_link</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">next_urls</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">,</span> <span class="n">related</span><span class="p">,</span> <span class="n">loop</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Crawl the link and return the next urls&#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">crawled_urls</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">itemgetter</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                       <span class="n">data_base</span><span class="o">.</span><span class="n">fetch_single_parameter_with_stats</span><span class="p">(</span><span class="n">PARAM_URL</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">Error</span><span class="p">,</span> <span class="n">mes</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Unable to extract data </span><span class="si">%s</span><span class="s"> with error:&#39;</span>
                                <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">PARAM_URL</span><span class="p">,</span> <span class="n">mes</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">next_urls</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">crawled_urls</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Reached max crawls&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">MaxUrlException</span><span class="p">()</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Crawl of url# </span><span class="si">%d</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">crawled_urls</span><span class="p">),</span> <span class="n">url</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span> <span class="ow">and</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">crawled_urls</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Skipped url already crawled: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">next_urls</span>
    <span class="c"># print completed urls so that user knows that the crawl is running</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">crawled_urls</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">crawled_urls</span><span class="p">)</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWLED_URLS_MODULO</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="c"># AO 26112012 trying to solve win freeze when printing to stdout</span>
        <span class="c"># does not work, best to not print on windows?</span>
        <span class="ow">and</span> <span class="s">&#39;win&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">lower</span><span class="p">()):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;Completed </span><span class="si">%d</span><span class="s"> urls</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">crawled_urls</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c">#print(&#39;Completed %d urls&#39; % len(crawled_urls))</span>
    <span class="k">if</span> <span class="n">result_stream</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Printing to result_stream&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">SEP_LINE</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">result_stream</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">redirect_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">download_libs</span> <span class="o">=</span> <span class="n">select_libraries</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">download_libs</span><span class="p">:</span>
        <span class="p">(</span><span class="n">lib_download</span><span class="p">,</span> <span class="n">lib_api</span><span class="p">)</span> <span class="o">=</span> <span class="n">download_libs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not select libraries to compute&#39;</span>
                                <span class="s">&#39; statistics for </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">next_urls</span>
    <span class="n">start_cache_server_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">cache_servers</span> <span class="o">=</span> <span class="n">retrieve_cache_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">lib_download</span><span class="p">)</span>
    <span class="n">end_cache_server_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">cache_server_delay</span> <span class="o">=</span> <span class="n">end_cache_server_time</span> <span class="o">-</span> <span class="n">start_cache_server_time</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;For url=</span><span class="si">%s</span><span class="s"> the cache urls are </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache_servers</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cache_servers</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error retrieving cache for: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">next_urls</span>
    <span class="c"># redirect servers (all except last) just ping statistics are stored</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">cache_server</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cache_servers</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">,</span> <span class="n">redirect_list</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache_server</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span>
                                    <span class="n">redirect_url</span><span class="o">=</span><span class="n">cache_servers</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error retrieving stats for: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                                    <span class="n">cache_server</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">add_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">cache_server_delay</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;no stats for url: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cache_server</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">redirect_list</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;redirect_list for redirect servers: </span><span class="si">%s</span><span class="s">&#39;</span>
                                   <span class="o">%</span> <span class="n">redirect_list</span><span class="p">)</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;these addresses are NOT taken into account&#39;</span><span class="p">)</span>
    <span class="n">do_full_crawl</span> <span class="o">=</span> <span class="n">check_full_download</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">crawled_urls</span><span class="p">))</span>
    <span class="c"># final redirect, download server for the video</span>
    <span class="n">cache_server</span> <span class="o">=</span> <span class="n">cache_servers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">redirect_list</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache_server</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                              <span class="n">do_full_crawl</span><span class="o">=</span><span class="n">do_full_crawl</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error retrieving stats for: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cache_server</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
        <span class="n">add_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">cache_server_delay</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">)</span>
        <span class="c"># wait only if there were stats retrieved</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DELAY_BETWEEN_REQUESTS</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;no stats for url: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cache_server</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">redirect_list</span> <span class="ow">and</span> <span class="n">redirect_list</span> <span class="o">!=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]:</span>
        <span class="c">#assert reduce(eq, redirect_list)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">eq</span><span class="p">,</span> <span class="n">redirect_list</span><span class="p">):</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;redirect list urls are not the same: </span><span class="si">%s</span><span class="s">&#39;</span>
                                    <span class="o">%</span> <span class="n">redirect_list</span><span class="p">)</span>
        <span class="n">cache_server</span> <span class="o">=</span> <span class="n">redirect_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stats</span><span class="p">,</span> <span class="n">redirect_list</span> <span class="o">=</span> <span class="n">compute_stats</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cache_server</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span>
                                             <span class="n">do_full_crawl</span><span class="o">=</span><span class="n">do_full_crawl</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">:</span>
            <span class="n">add_stats</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">cache_server_delay</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">)</span>
            <span class="c"># wait only if there were stats retrieved</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DELAY_BETWEEN_REQUESTS</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;no stats for url: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cache_server</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">redirect_list</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;new redirect list: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">redirect_list</span><span class="p">)</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;these addresses are NOT taken into account&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">related</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">next_urls</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">related_urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>
                                      <span class="n">lib_api</span><span class="o">.</span><span class="n">get_related_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
                                               <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_PAGE</span><span class="p">,</span>
                                               <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_URL</span><span class="p">)))</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">next_urls</span>
        <span class="n">next_urls</span> <span class="o">=</span> <span class="n">next_urls</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">related_urls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">next_urls</span>
</div>
<div class="viewcode-block" id="crawl_links"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.crawl_links">[docs]</a><span class="k">def</span> <span class="nf">crawl_links</span><span class="p">(</span><span class="n">input_links</span><span class="p">,</span> <span class="n">result_stream</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">data_base</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Wrapper to crawl each input link&#39;&#39;&#39;</span>
    <span class="n">next_urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c"># When a redirect occurs, the database should store in the</span>
    <span class="c"># &#39;Url&#39; field the first link that caused redirection and then statistics</span>
    <span class="c"># for each cache server it gets redirected to</span>
    <span class="c"># - download statistics: only for final cache server from which the video is</span>
    <span class="c">#                        downloaded</span>
    <span class="c"># - ping statistics: for each cache server (intermediate and final)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;input_links: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">input_links</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">input_links</span><span class="p">:</span>
        <span class="n">next_urls</span> <span class="o">=</span> <span class="n">crawl_link</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">next_urls</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">,</span>
                               <span class="n">related</span><span class="p">,</span> <span class="n">loop</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">next_urls</span> <span class="o">=</span> <span class="n">next_urls</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">input_links</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">next_urls</span> <span class="o">=</span> <span class="n">input_links</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;next_urls: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">next_urls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">next_urls</span>
</div>
<div class="viewcode-block" id="do_rounds"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.do_rounds">[docs]</a><span class="k">def</span> <span class="nf">do_rounds</span><span class="p">(</span><span class="n">input_links</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">,</span> <span class="n">db_file</span><span class="p">,</span>
              <span class="n">image_file</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Perform the rounds of crawl&#39;&#39;&#39;</span>
    <span class="n">max_rounds</span> <span class="o">=</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_ROUNDS</span>
    <span class="k">for</span> <span class="n">round_nb</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">max_rounds</span><span class="p">):</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Round </span><span class="si">%d</span><span class="s"> started</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">round_nb</span><span class="p">,</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">SEP_LINE</span><span class="p">))</span>
        <span class="c"># Reseting the name servers at start of each crawl</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">EXTRA_NAME_SERVERS_CC</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">name_server</span><span class="p">,</span> <span class="n">dns_server_ip_address</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span>
                                            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">EXTRA_NAME_SERVERS</span><span class="p">):</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">EXTRA_NAME_SERVERS_CC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">(</span><span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROVIDER</span><span class="p">,</span> <span class="n">name_server</span><span class="p">)),</span>
                                 <span class="n">dns_server_ip_address</span><span class="p">))</span>
<span class="c">#        config_pytomo.EXTRA_NAME_SERVERS_CC = (</span>
<span class="c">#                                           config_pytomo.EXTRA_NAME_SERVERS[:])</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Name servers at round </span><span class="si">%s</span><span class="s">:&#39;</span>
                               <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">EXTRA_NAME_SERVERS_CC</span><span class="p">)</span>
        <span class="c">#config_pytomo.LOG.debug(input_links)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_links</span> <span class="o">=</span> <span class="n">crawl_links</span><span class="p">(</span><span class="n">input_links</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span>
                                      <span class="n">data_base</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># AO 20120926 TODO: check if this catches exception of crawled_urls</span>
            <span class="c"># extraction from database</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;not able to retrieve stats from url&#39;</span><span class="p">)</span>
            <span class="c"># no sleep here: check if it&#39;s ok</span>
            <span class="k">continue</span>
        <span class="c"># early exit if no more links</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_links</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DELAY_BETWEEN_REQUESTS</span><span class="p">)</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Slept </span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span>
                                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DELAY_BETWEEN_REQUESTS</span><span class="p">)</span>
        <span class="c"># The plot is redrawn everytime the database is updated</span>
        <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PLOT</span><span class="p">:</span>
            <span class="n">lib_plot</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">COLUMN_NAMES</span><span class="p">,</span>
                               <span class="n">image_file</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="do_crawl"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.do_crawl">[docs]</a><span class="k">def</span> <span class="nf">do_crawl</span><span class="p">(</span><span class="n">result_stream</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">db_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">image_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Crawls the urls given by the url_file</span>
<span class="sd">    up to max_rounds are performed or max_visited_urls</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result_stream</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Cannot start crawl because no file can &#39;</span>
                                   <span class="s">&#39;store output&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Start crawl&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">.%H_%M_%S&#39;</span><span class="p">)</span>
    <span class="n">data_base</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">db_file</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DATABASE_TIMESTAMP</span> <span class="o">=</span> <span class="n">db_file</span>
        <span class="n">trans_table</span> <span class="o">=</span> <span class="n">maketrans</span><span class="p">(</span><span class="s">&#39;.-&#39;</span><span class="p">,</span> <span class="s">&#39;__&#39;</span><span class="p">)</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">TABLE_TIMESTAMP</span> <span class="o">=</span> <span class="s">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">TABLE</span><span class="p">,</span>
                                              <span class="n">timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">trans_table</span><span class="p">)</span>
        <span class="n">data_base</span> <span class="o">=</span> <span class="n">lib_database</span><span class="o">.</span><span class="n">PytomoDatabase</span><span class="p">(</span>
                                            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DATABASE_TIMESTAMP</span><span class="p">)</span>
        <span class="n">data_base</span><span class="o">.</span><span class="n">create_pytomo_table</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">TABLE_TIMESTAMP</span><span class="p">)</span>
<span class="c">#    max_per_page = config_pytomo.MAX_PER_PAGE</span>
<span class="c">#    max_per_url = config_pytomo.MAX_PER_URL</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;STATIC_URL_LIST: </span><span class="si">%s</span><span class="s">&#39;</span>
                            <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">STATIC_URL_LIST</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">STATIC_URL_LIST</span><span class="p">:</span>
        <span class="n">input_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">STATIC_URL_LIST</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span> <span class="o">==</span> <span class="n">YOUTUBE_SERVICE</span><span class="p">:</span>
            <span class="n">lib_api</span> <span class="o">=</span> <span class="n">lib_youtube_api</span>
        <span class="k">elif</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span> <span class="o">==</span> <span class="n">DAILYMOTION_SERVICE</span><span class="p">:</span>
            <span class="n">lib_api</span> <span class="o">=</span> <span class="n">lib_dailymotion_api</span>
        <span class="n">input_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">lib_api</span><span class="o">.</span><span class="n">get_popular_links</span><span class="p">(</span>
                                 <span class="n">input_time</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">TIME_FRAME</span><span class="p">,</span>
                                 <span class="n">max_results</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_PAGE</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span> <span class="o">==</span> <span class="s">&#39;youtube&#39;</span>
            <span class="ow">and</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">EXTRA_COUNTRY</span><span class="p">):</span>
            <span class="n">links_tn</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span>
                                  <span class="n">lib_api</span><span class="o">.</span><span class="n">get_popular_links</span><span class="p">(</span>
                                      <span class="n">input_time</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">TIME_FRAME</span><span class="p">,</span>
                                      <span class="n">max_results</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_PAGE</span><span class="p">,</span>
                                      <span class="n">country</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">EXTRA_COUNTRY</span><span class="p">)))</span>
            <span class="n">input_links</span> <span class="o">=</span> <span class="n">input_links</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">links_tn</span><span class="p">)</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;bootstrap links: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">input_links</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">loop</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">do_rounds</span><span class="p">(</span><span class="n">input_links</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">,</span> <span class="n">db_file</span><span class="p">,</span>
                          <span class="n">image_file</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">do_rounds</span><span class="p">(</span><span class="n">input_links</span><span class="p">,</span> <span class="n">result_stream</span><span class="p">,</span> <span class="n">data_base</span><span class="p">,</span> <span class="n">db_file</span><span class="p">,</span>
                      <span class="n">image_file</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
            <span class="c"># next round input are related links of the current input_links</span>
    <span class="c">#   input_links = get_next_round_urls(lib_api, input_links, max_per_page,</span>
    <span class="c">#                                            max_per_url)</span>
    <span class="k">except</span> <span class="n">MaxUrlException</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Stopping crawl because </span><span class="si">%d</span><span class="s"> urls have been &#39;</span>
                               <span class="s">&#39;crawled&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">data_base</span><span class="p">:</span>
        <span class="n">data_base</span><span class="o">.</span><span class="n">close_handle</span><span class="p">()</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Crawl finished</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">SEP_LINE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="get_next_round_urls"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.get_next_round_urls">[docs]</a><span class="k">def</span> <span class="nf">get_next_round_urls</span><span class="p">(</span><span class="n">lib_api</span><span class="p">,</span> <span class="n">input_links</span><span class="p">,</span>
                        <span class="n">max_per_page</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_PAGE</span><span class="p">,</span>
                        <span class="n">max_per_url</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_URL</span><span class="p">,</span>
                        <span class="n">max_round_duration</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_ROUND_DURATION</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Return a tuple of the set of input urls and a set of related url of</span>
<span class="sd">    videos.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        * input_links: list of the urls</span>
<span class="sd">        * max_per_url and max_per_page options</span>
<span class="sd">        * out_file_name: if provided, list is dump in it</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># keep only non-duplicated links and no links from input file</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_links</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">CONTINUOUS_CRAWL_SIZE</span><span class="p">:</span>
        <span class="n">related_links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">input_links</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DELAY_BETWEEN_REQUESTS</span><span class="p">)</span>
            <span class="n">related_links</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="n">related_links</span><span class="p">,</span>
                                   <span class="n">lib_api</span><span class="o">.</span><span class="n">get_related_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">max_per_page</span><span class="p">,</span>
                                                   <span class="n">max_per_url</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_round_duration</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">related_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">related_links</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">input_links</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">related_links</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">reduce</span><span class="p">(</span><span class="n">concat</span><span class="p">,</span> <span class="p">(</span><span class="n">lib_api</span><span class="o">.</span><span class="n">get_related_urls</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
                                            <span class="n">max_per_page</span><span class="p">,</span> <span class="n">max_per_url</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">input_links</span><span class="p">),</span> <span class="p">[])</span>
                           <span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">input_links</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> links collected by crawler&quot;</span>
                            <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_links</span><span class="p">))</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">related_links</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">related_links</span>

</div>
<div class="viewcode-block" id="convert_debug_level"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.convert_debug_level">[docs]</a><span class="k">def</span> <span class="nf">convert_debug_level</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="s">&#39;Convert the string passed to a logging level&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">log_level</span> <span class="o">=</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">NAME_TO_LEVEL</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Incorrect log level.</span><span class="se">\n</span><span class="s">&#39;</span>
                     <span class="s">&quot;Choose from: &#39;DEBUG&#39;, &#39;INFO&#39;, &#39;WARNING&#39;, &quot;</span>
                     <span class="s">&quot;&#39;ERROR&#39; and &#39;CRITICAL&#39; (default &#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span>
                     <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LEVEL_TO_NAME</span><span class="p">[</span>
                         <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_LEVEL</span><span class="p">])</span>
        <span class="k">return</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s">&#39;LOG_LEVEL&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="set_proxies"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.set_proxies">[docs]</a><span class="k">def</span> <span class="nf">set_proxies</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
    <span class="s">&#39;Convert the proxy passed to a dict to be handled by urllib2&#39;</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="c"># remove quotes</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;http://&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;http://&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s">&#39;PROXIES&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;http&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                                           <span class="s">&#39;ftp&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">})</span>
</div>
<div class="viewcode-block" id="create_options"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.create_options">[docs]</a><span class="k">def</span> <span class="nf">create_options</span><span class="p">(</span><span class="n">parser</span><span class="p">):</span>
    <span class="s">&#39;Add the different options to the parser&#39;</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--batch&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;BATCH_MODE&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Do NOT prompt user for any input&#39;</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">BATCH_MODE</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;MAX_CRAWLED_URLS&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Max number of urls to visit (default </span><span class="si">%d</span><span class="s">)&#39;</span>
                            <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;MAX_ROUNDS&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Max number of rounds to perform (default </span><span class="si">%d</span><span class="s">)&#39;</span>
                            <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_ROUNDS</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_ROUNDS</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-l&#39;</span><span class="p">,</span> <span class="s">&#39;--loop&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;LOOP&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOOP</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Loop after completing the max nb of rounds&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--no-loop&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;LOOP&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_false&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOOP</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Loop after completing the max nb of rounds&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-R&#39;</span><span class="p">,</span> <span class="s">&#39;--related&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;RELATED&#39;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">RELATED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Crawl related videos&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--no-related&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;RELATED&#39;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">RELATED</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Do NOT crawl related videos (stays with the first &#39;</span>
                        <span class="s">&#39;urls found: either most popular or arguments given)&#39;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;MAX_PER_URL&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Max number of related urls from each page &#39;</span>
                            <span class="s">&#39;(default </span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_URL</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_URL</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-P&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;MAX_PER_PAGE&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Max number of related videos from each page &#39;</span>
                            <span class="s">&#39;(default </span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_PAGE</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_PER_PAGE</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;CRAWL_SERVICE&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Service for the most popular videos to fetch &#39;</span>
                            <span class="s">&quot;at start of crawl: select between &#39;youtube&#39;, &quot;</span>
                            <span class="s">&quot;or &#39;dailymotion&#39; (default &#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span>
                            <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;TIME_FRAME&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Timeframe for the most popular videos to fetch &#39;</span>
                            <span class="s">&quot;at start of crawl put &#39;today&#39;, &#39;week&#39;, &#39;month&#39; &quot;</span>
                            <span class="s">&quot;or &#39;all_time&#39; (default &#39;</span><span class="si">%s</span><span class="s">&#39;) [only for YouTube]&quot;</span>
                            <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">TIME_FRAME</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">TIME_FRAME</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;PING_PACKETS&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;int&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Number of packets to be sent for each ping &#39;</span>
                            <span class="s">&#39;(default </span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PING_PACKETS</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">PING_PACKETS</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-D&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;DOWNLOAD_TIME&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Download time for the video in seconds &#39;</span>
                            <span class="s">&#39;(default </span><span class="si">%f</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DOWNLOAD_TIME</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DOWNLOAD_TIME</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-S&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;DELAY_BETWEEN_REQUESTS&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;float&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Delay between consecutive video requests in &#39;</span>
                            <span class="s">&#39; seconds (default </span><span class="si">%f</span><span class="s">)&#39;</span>
                            <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DELAY_BETWEEN_REQUESTS</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DELAY_BETWEEN_REQUESTS</span><span class="p">)</span>
<span class="c">#    parser.add_option(&#39;-B&#39;, dest=&#39;INITIAL_PLAYBACK_DURATION &#39;, type=&#39;float&#39;,</span>
<span class="c">#                      help=(&#39;Buffering video duration in seconds (default %f)&#39;</span>
<span class="c">#                            % config_pytomo.INITIAL_PLAYBACK_DURATION),</span>
<span class="c">#                      default=config_pytomo.INITIAL_PLAYBACK_DURATION )</span>
<span class="c">#    parser.add_option(&#39;-M&#39;, dest=&#39;MIN_PLAYOUT_BUFFER_SIZE&#39;, type=&#39;float&#39;,</span>
<span class="c">#                      help=(&#39;Minimum Playout Buffer Size in seconds &#39;</span>
<span class="c">#                            &#39;(default %f)&#39; % config_pytomo.MIN_PLAYOUT_BUFFER),</span>
<span class="c">#                      default=config_pytomo.MIN_PLAYOUT_BUFFER)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-x&#39;</span><span class="p">,</span> <span class="s">&#39;--no-log-ip&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;LOG_PUBLIC_IP&#39;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_false&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Do NOT store public IP address of the machine &#39;</span>
                            <span class="s">&#39;in the logs&#39;</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_PUBLIC_IP</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;-centralise&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;CENTRALISE_DATA&#39;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Send logs to the centralisation server </span><span class="si">%s</span><span class="s">&#39;</span>
                            <span class="o">%</span> <span class="n">lib_data_centralisation</span><span class="o">.</span><span class="n">MAIN_SERVER</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">CENTRALISE_DATA</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--http-proxy&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;PROXIES&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;in case of http proxy to reach Internet &#39;</span>
                            <span class="s">&#39;(default </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;callback&#39;</span><span class="p">,</span>
                     <span class="n">callback</span><span class="o">=</span><span class="n">set_proxies</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--provider&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;PROVIDER&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;Indicate the ISP&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROVIDER</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--download-extra-dns&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;DOWNLOAD_FROM_EXTRA_IPS&#39;</span><span class="p">,</span>
                      <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DOWNLOAD_FROM_EXTRA_IPS</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Download videos from IP resolved by other DNS &#39;</span>
                        <span class="s">&#39;(default </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DOWNLOAD_FROM_EXTRA_IPS</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-L&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;LOG_LEVEL&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;The log level setting for the Logging module.&#39;</span>
                            <span class="s">&quot;Choose from: &#39;DEBUG&#39;, &#39;INFO&#39;, &#39;WARNING&#39;, &quot;</span>
                            <span class="s">&quot;&#39;ERROR&#39; and &#39;CRITICAL&#39; (default &#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span>
                            <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LEVEL_TO_NAME</span><span class="p">[</span>
                                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_LEVEL</span><span class="p">]),</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_LEVEL</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;callback&#39;</span><span class="p">,</span>
                      <span class="n">callback</span><span class="o">=</span><span class="n">convert_debug_level</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--input-file&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;INPUT_FILE&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s">&#39;string&#39;</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s">&#39;File indicating the URLs to crawl (one URL per line)&#39;</span><span class="p">,</span>
                      <span class="n">default</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">INPUT_FILE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="check_options"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.check_options">[docs]</a><span class="k">def</span> <span class="nf">check_options</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
    <span class="s">&#39;Check incompatible options&#39;</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">TIME_FRAME</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">([</span><span class="s">&#39;today&#39;</span><span class="p">,</span> <span class="s">&#39;week&#39;</span><span class="p">,</span> <span class="s">&#39;month&#39;</span><span class="p">,</span> <span class="s">&#39;all_time&#39;</span><span class="p">]):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Incorrect time frame.</span><span class="se">\n</span><span class="s">&#39;</span>
                     <span class="s">&quot;Choose from: &#39;today&#39;, &#39;week&#39;, &#39;month&#39;, &#39;all_time&#39; &quot;</span>
                     <span class="s">&quot;(default: &#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">TIME_FRAME</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">([</span><span class="n">YOUTUBE_SERVICE</span><span class="p">,</span>
                                              <span class="n">DAILYMOTION_SERVICE</span><span class="p">]):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Incorrect Service.</span><span class="se">\n</span><span class="s">&#39;</span>
                     <span class="s">&quot;Choose from: &#39;youtube&#39;, &#39;dailymotion&#39; &quot;</span>
                     <span class="s">&quot;(default &#39;</span><span class="si">%s</span><span class="s">&#39;)&quot;</span> <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="write_options_to_config"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.write_options_to_config">[docs]</a><span class="k">def</span> <span class="nf">write_options_to_config</span><span class="p">(</span><span class="n">options</span><span class="p">):</span>
    <span class="s">&#39;Write read options to config_pytomo&#39;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">config_pytomo</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="log_ip_address"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.log_ip_address">[docs]</a><span class="k">def</span> <span class="nf">log_ip_address</span><span class="p">():</span>
    <span class="s">&#39;Log the remote IP addresses&#39;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Logging the local public IP address.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="c"># is local address of some interest??</span>
    <span class="c"># check: http://stackoverflow.com/</span>
    <span class="c"># questions/166506/finding-local-ip-addresses-in-python</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">ProxyHandler</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">)</span>
        <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
        <span class="n">urllib2</span><span class="o">.</span><span class="n">install_opener</span><span class="p">(</span><span class="n">opener</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">public_ip</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">while</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">retries</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">hexversion</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="mh">0x2060000</span><span class="p">):</span>
                <span class="c"># timeout is available only python above 2.6</span>
                <span class="n">public_ip</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">PUBLIC_IP_FINDER</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span>
                                    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">IPADDR_TIMEOUT</span><span class="p">))[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">public_ip</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">PUBLIC_IP_FINDER</span><span class="p">,</span> <span class="bp">None</span><span class="p">))[</span><span class="s">&#39;data&#39;</span><span class="p">][</span><span class="s">&#39;ip&#39;</span><span class="p">]</span>
        <span class="c">#except urllib2.URLError, mes:</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">mes</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Public IP address not found: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mes</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Public IP address not found: </span><span class="si">%s</span><span class="s">, retrying in </span><span class="si">%i</span><span class="s"> seconds&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">mes</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Check for valid IP</span>
            <span class="n">is_valid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">IP_MATCH_PATTERN</span><span class="p">,</span> <span class="n">public_ip</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Machine has this public IP address:&#39;</span>
                                           <span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">public_ip</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Unable to Parse IP address: </span><span class="si">%s</span><span class="s">... &#39;</span>
                                           <span class="s">&#39;Skipping&#39;</span> <span class="o">%</span> <span class="n">public_ip</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">u&#39;ERROR: giving up after </span><span class="si">%d</span><span class="s"> retries, public IP&#39;</span>
                                <span class="s">&#39; not found&#39;</span> <span class="o">%</span> <span class="n">retries</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Public IP address could not be logged.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="log_md5_results"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.log_md5_results">[docs]</a><span class="k">def</span> <span class="nf">log_md5_results</span><span class="p">(</span><span class="n">result_file</span><span class="p">,</span> <span class="n">db_file</span><span class="p">):</span>
    <span class="s">&#39;Computes and stores the md5 hash of result and database files&#39;</span>
    <span class="k">if</span> <span class="n">db_file</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Hash of database file: </span><span class="si">%s</span><span class="s">&#39;</span>
                                   <span class="o">%</span> <span class="n">md5sum</span><span class="p">(</span><span class="n">db_file</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">result_file</span> <span class="ow">and</span> <span class="n">result_file</span> <span class="o">!=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Hash of result file: </span><span class="si">%s</span><span class="s">&#39;</span>
                                   <span class="o">%</span> <span class="n">md5sum</span><span class="p">(</span><span class="n">result_file</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="configure_log_file"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.configure_log_file">[docs]</a><span class="k">def</span> <span class="nf">configure_log_file</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">kaa_metadata</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="s">&#39;Configure log file and indicate succes or failure&#39;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Configuring log file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kaa_metadata</span><span class="p">:</span>
        <span class="c"># to have kaa-metadata logs</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;metadata&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;demo&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_FILE</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Logs are on standard output&#39;</span><span class="p">)</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log_file</span> <span class="o">=</span> <span class="n">check_out_files</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_FILE</span><span class="p">,</span>
                                       <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_DIR</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&#39;Logfile </span><span class="si">%s</span><span class="s"> could not be open for writing&#39;</span> <span class="o">%</span> <span class="n">log_file</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Logs are there: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">log_file</span><span class="p">)</span>
        <span class="c"># for lib_youtube_download</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_FILE_TIMESTAMP</span> <span class="o">=</span> <span class="n">log_file</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">log_file</span><span class="p">)</span>
    <span class="n">log_formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%(asctime)s</span><span class="s"> - </span><span class="si">%(filename)s</span><span class="s">:</span><span class="si">%(lineno)d</span><span class="s"> - &#39;</span>
                                      <span class="s">&#39;</span><span class="si">%(levelname)s</span><span class="s"> - </span><span class="si">%(message)s</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">log_formatter</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_LEVEL</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Log level set to </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
                           <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LEVEL_TO_NAME</span><span class="p">[</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_LEVEL</span><span class="p">])</span>
    <span class="c"># to not have console output</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># log all config file values except built in values</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;__&#39;</span><span class="p">),</span>
                        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">__dict__</span><span class="p">):</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span>
                                   <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config_pytomo</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">log_file</span>
</div>
<div class="viewcode-block" id="MyTimeoutException"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.MyTimeoutException">[docs]</a><span class="k">class</span> <span class="nc">MyTimeoutException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="s">&#39;Class to generate timeout exceptions&#39;</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="configure_alarm"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.configure_alarm">[docs]</a><span class="k">def</span> <span class="nf">configure_alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Set timeout if OS support it</span>
<span class="sd">    Return a bool indicating if signal is supported&#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">timeout_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="s">&#39;handle the timeout&#39;</span>
        <span class="k">raise</span> <span class="n">MyTimeoutException</span><span class="p">()</span>
    <span class="c"># non-posix support for signals is weak</span>
    <span class="n">support_signal</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;SIGALRM&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s">&#39;alarm&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">support_signal</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">timeout_handler</span><span class="p">)</span>
        <span class="c"># triger alarm in timeout seconds</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">support_signal</span>
</div>
<div class="viewcode-block" id="prompt_max_crawls"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.prompt_max_crawls">[docs]</a><span class="k">def</span> <span class="nf">prompt_max_crawls</span><span class="p">(</span><span class="n">support_signal</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="s">&#39;Function to prompt the user to enter max_urls&#39;</span>
    <span class="k">return</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&#39;Please enter the max. number of videos &#39;</span>
                              <span class="s">&#39;(press Enter for default </span><span class="si">%d</span><span class="s">): &#39;</span> <span class="o">%</span>
                              <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">,</span>
                          <span class="p">(</span><span class="s">&#39;(or wait </span><span class="si">%d</span><span class="s"> seconds)&#39;</span> <span class="o">%</span> <span class="n">timeout</span> <span class="k">if</span> <span class="n">support_signal</span>
                               <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="s">&#39;&#39;</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="set_max_crawls"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.set_max_crawls">[docs]</a><span class="k">def</span> <span class="nf">set_max_crawls</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">USER_INPUT_TIMEOUT</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">nb_max_crawls</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">):</span>
    <span class="s">&#39;Sets the max number of videos to be crawlled&#39;</span>
    <span class="n">support_signal</span> <span class="o">=</span> <span class="n">configure_alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prompt</span><span class="p">:</span>
            <span class="n">max_crawls</span> <span class="o">=</span> <span class="n">prompt_max_crawls</span><span class="p">(</span><span class="n">support_signal</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_crawls</span> <span class="o">=</span> <span class="n">nb_max_crawls</span>
    <span class="k">except</span> <span class="n">MyTimeoutException</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">support_signal</span><span class="p">:</span>
            <span class="c"># alarm disabled</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_crawls</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_crawls</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;User gave non-integer value: </span><span class="si">%s</span><span class="s">&#39;</span>
                                    <span class="o">%</span> <span class="n">max_crawls</span><span class="p">)</span>
    <span class="n">max_craw_message</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;The Max Crawls has been set to: </span><span class="si">%s</span><span class="s">&#39;</span>
                        <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">max_craw_message</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">max_craw_message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">max_crawls</span>
</div>
<div class="viewcode-block" id="prompt_proxies"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.prompt_proxies">[docs]</a><span class="k">def</span> <span class="nf">prompt_proxies</span><span class="p">(</span><span class="n">support_signal</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Function to prompt the user to enter the proxies it uses to connect to</span>
<span class="sd">    the internet&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s">&quot;Please enter the proxies you use to connect to&quot;</span>
                                <span class="s">&quot; the internet, in the format:</span><span class="se">\n</span><span class="s">&quot;</span>
                                <span class="s">&quot;http://proxy:8080/</span><span class="se">\n</span><span class="s">&quot;</span>
                                <span class="s">&quot;(press Enter for default: </span><span class="si">%s</span><span class="s">): &quot;</span> <span class="o">%</span>
                                <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">,</span>
                            <span class="p">(</span><span class="s">&quot;(or wait </span><span class="si">%d</span><span class="s"> seconds)&quot;</span> <span class="o">%</span> <span class="n">timeout</span> <span class="k">if</span> <span class="n">support_signal</span>
                            <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="set_proxies_cli"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.set_proxies_cli">[docs]</a><span class="k">def</span> <span class="nf">set_proxies_cli</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">USER_INPUT_TIMEOUT</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Sets the proxies needed to connect to the internet&#39;&#39;&#39;</span>
    <span class="n">support_signal</span> <span class="o">=</span> <span class="n">configure_alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cli_proxies</span> <span class="o">=</span> <span class="n">prompt_proxies</span><span class="p">(</span><span class="n">support_signal</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">MyTimeoutException</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">support_signal</span><span class="p">:</span>
            <span class="c"># alarm disabled</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cli_proxies</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c">#config_pytomo.PROXIES = literal_eval(cli_proxies)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">config_pytomo</span><span class="p">,</span> <span class="s">&#39;PROXIES&#39;</span><span class="p">,</span>
                    <span class="p">{</span><span class="s">&#39;http&#39;</span><span class="p">:</span> <span class="n">cli_proxies</span><span class="p">,</span> <span class="s">&#39;https&#39;</span><span class="p">:</span> <span class="n">cli_proxies</span><span class="p">,</span>
                     <span class="s">&#39;ftp&#39;</span><span class="p">:</span> <span class="n">cli_proxies</span><span class="p">})</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">SyntaxError</span><span class="p">):</span>
            <span class="n">proxies_message</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;ERROR: User gave incorrect proxy format: *</span><span class="si">%s</span><span class="s">*</span><span class="se">\n</span><span class="s">&quot;</span>
                               <span class="s">&quot;Will use default proxies: </span><span class="si">%s</span><span class="se">\n</span><span class="s">If you need to &quot;</span>
                               <span class="s">&quot;configure a specific proxy, please try to run&quot;</span>
                               <span class="s">&quot; the application again, respecting the format:&quot;</span>
                               <span class="s">&quot;</span><span class="se">\n</span><span class="s">http://proxy:8080/</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">cli_proxies</span><span class="p">,</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">))</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">proxies_message</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="n">proxies_message</span><span class="p">)</span>
    <span class="n">proxies_message</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;The Proxies have been set to: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span>
                        <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">proxies_message</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">proxies_message</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cli_proxies</span>
</div>
<div class="viewcode-block" id="log_provider"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.log_provider">[docs]</a><span class="k">def</span> <span class="nf">log_provider</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">USER_INPUT_TIMEOUT</span><span class="p">):</span>
    <span class="s">&#39;Get and logs the provider from the user or skip after timeout seconds&#39;</span>
    <span class="n">support_signal</span> <span class="o">=</span> <span class="n">configure_alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">provider</span> <span class="o">=</span> <span class="n">prompt_provider</span><span class="p">(</span><span class="n">support_signal</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">MyTimeoutException</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">support_signal</span><span class="p">:</span>
            <span class="c"># alarm disabled</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;User has given this provider: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">provider</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PROVIDER</span> <span class="o">=</span> <span class="n">provider</span>
</div>
<div class="viewcode-block" id="prompt_provider"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.prompt_provider">[docs]</a><span class="k">def</span> <span class="nf">prompt_provider</span><span class="p">(</span><span class="n">support_signal</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
    <span class="s">&#39;Function to prompt for provider&#39;</span>
    <span class="k">return</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
            <span class="s">&#39;Please indicate your provider/ISP (leave blank for skipping).</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="s">&#39;Crawl will START when you PRESS ENTER&#39;</span><span class="p">,</span>
            <span class="p">((</span><span class="s">&#39; (or after </span><span class="si">%d</span><span class="s"> seconds)&#39;</span> <span class="o">%</span> <span class="n">timeout</span><span class="p">)</span> <span class="k">if</span> <span class="n">support_signal</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
            <span class="s">&#39;.</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)))</span>
</div>
<div class="viewcode-block" id="prompt_start_crawl"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.prompt_start_crawl">[docs]</a><span class="k">def</span> <span class="nf">prompt_start_crawl</span><span class="p">():</span>
    <span class="s">&#39;Funtion to prompt user for to accept the crawling&#39;</span>
    <span class="k">return</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Are you ok to start crawling? (Y/N)</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../pytomo.html#pytomo.start_pytomo.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Program wrapper</span>
<span class="sd">    Setup of log part</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">argv</span><span class="p">:</span>
        <span class="n">argv</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">usage</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;%prog [-b --batch] &#39;</span>
             <span class="s">&#39;[-u max_crawled_url] &#39;</span>
             <span class="s">&#39;[-r max_rounds] &#39;</span>
             <span class="s">&#39;[-l, --loop|--no-loop] &#39;</span>
             <span class="s">&#39;[-R --related|--no-related] &#39;</span>
             <span class="s">&#39;[-p max_per_url] &#39;</span>
             <span class="s">&#39;[-P max_per_page] &#39;</span>
             <span class="s">&#39;[-s {youtube, dailymotion}] &#39;</span>
             <span class="s">&#39;[-t time_frame] &#39;</span>
             <span class="s">&#39;[-n ping_packets] &#39;</span>
             <span class="s">&#39;[-D download_time] &#39;</span>
             <span class="s">&#39;[-S delay_between_requests] &#39;</span>
             <span class="c">#&#39;[-B buffering_video_duration] &#39;</span>
             <span class="c">#&#39;[-M min_playout_buffer_size] &#39;</span>
             <span class="s">&#39;[-x, --no-log-ip] &#39;</span>
             <span class="s">&#39;[-c, --no-centralize] &#39;</span>
             <span class="s">&#39;[--http-proxy=http://proxy:8080] &#39;</span>
             <span class="s">&#39;[--provider=MY_ISP] &#39;</span>
             <span class="s">&#39;[--download-extra-dns] &#39;</span>
             <span class="s">&#39;[-L log_level] &#39;</span>
             <span class="s">&#39;[-f, --input_file input_file_list] &#39;</span>
             <span class="s">&#39;[input_urls]&#39;</span><span class="p">)</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">)</span>
    <span class="n">create_options</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
    <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">input_urls</span><span class="p">)</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">check_options</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
    <span class="n">write_options_to_config</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">.%H_%M_%S&#39;</span><span class="p">)</span>
    <span class="n">log_file</span> <span class="o">=</span> <span class="n">configure_log_file</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
    <span class="n">image_file</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">log_file</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result_file</span> <span class="o">=</span> <span class="n">check_out_files</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">RESULT_FILE</span><span class="p">,</span>
                                      <span class="n">config_pytomo</span><span class="o">.</span><span class="n">RESULT_DIR</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">result_file</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">result_file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span> <span class="s">&#39;Text results are there: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">result_file</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_file</span> <span class="o">=</span> <span class="n">check_out_files</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">DATABASE</span><span class="p">,</span>
                                  <span class="n">config_pytomo</span><span class="o">.</span><span class="n">DATABASE_DIR</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="n">db_file</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">db_file</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Database results are there: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">db_file</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Offset between local time and UTC: </span><span class="si">%d</span><span class="s">&#39;</span>
                               <span class="o">%</span> <span class="n">timezone</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Pytomo version = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">SYSTEM</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Pytomo is running on this system: </span><span class="si">%s</span><span class="s">&#39;</span>
                           <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">SYSTEM</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PLOT</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">image_file</span> <span class="o">=</span> <span class="n">check_out_files</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">IMAGE_FILE</span><span class="p">,</span>
                                    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">IMAGE_DIR</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">image_file</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">image_file</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Plots are here: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">image_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Unable to create image_file&#39;</span><span class="p">)</span>
    <span class="c"># do NOT prompt for start if BATCH_MODE on (no input expected from user)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">BATCH_MODE</span><span class="p">:</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">start_crawl</span> <span class="o">=</span> <span class="n">prompt_start_crawl</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">start_crawl</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;N&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">start_crawl</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;Y&#39;</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">PROVIDER</span><span class="p">:</span>
            <span class="n">log_provider</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">USER_INPUT_TIMEOUT</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Provider given at command line: </span><span class="si">%s</span><span class="s">&#39;</span>
                                       <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">PROVIDER</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">:</span>
            <span class="n">set_proxies_cli</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">USER_INPUT_TIMEOUT</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Proxies given at command line: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span>
                                       <span class="o">%</span> <span class="n">options</span><span class="o">.</span><span class="n">PROXIES</span><span class="p">)</span>
        <span class="n">set_max_crawls</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">USER_INPUT_TIMEOUT</span><span class="p">,</span>
                       <span class="n">prompt</span><span class="o">=</span><span class="p">(</span><span class="bp">False</span> <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">BATCH_MODE</span> <span class="k">else</span> <span class="bp">True</span><span class="p">),</span>
                       <span class="n">nb_max_crawls</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">MAX_CRAWLED_URLS</span><span class="p">)</span>
    <span class="c"># log IP after proxies given by the user</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_PUBLIC_IP</span><span class="p">:</span>
        <span class="n">log_ip_address</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Type Ctrl-C to interrupt crawl&#39;</span><span class="p">)</span>
    <span class="n">result_stream</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># memory monitoring module</span>
    <span class="k">if</span> <span class="n">result_file</span><span class="p">:</span>
        <span class="n">result_stream</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_urls</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">STATIC_URL_LIST</span> <span class="o">=</span> <span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">STATIC_URL_LIST</span>
                                         <span class="o">+</span> <span class="n">input_urls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">INPUT_FILE</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">INPUT_FILE</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_file</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">STATIC_URL_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">,</span> <span class="n">mes</span><span class="p">:</span>
            <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">mes</span><span class="p">)</span>
            <span class="n">parser</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Problem reading input file: </span><span class="si">%s</span><span class="s">&#39;</span>
                         <span class="o">%</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">INPUT_FILE</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Service for most popular links </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                            <span class="n">options</span><span class="o">.</span><span class="n">CRAWL_SERVICE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">do_crawl</span><span class="p">(</span><span class="n">result_stream</span><span class="o">=</span><span class="n">result_stream</span><span class="p">,</span> <span class="n">db_file</span><span class="o">=</span><span class="n">db_file</span><span class="p">,</span>
                 <span class="n">image_file</span><span class="o">=</span><span class="n">image_file</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                 <span class="n">loop</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOOP</span><span class="p">,</span> <span class="n">related</span><span class="o">=</span><span class="n">config_pytomo</span><span class="o">.</span><span class="n">RELATED</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">BlackListException</span><span class="p">:</span>
        <span class="n">err_mes</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;Crawl detected by YouTube: &#39;</span>
                   <span class="s">&#39;log to YouTube and enter captcha&#39;</span><span class="p">)</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">err_mes</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">err_mes</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Crawl interrupted by user&#39;</span><span class="p">)</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s">&#39;Crawl interrupted by user&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">mes</span><span class="p">:</span>
        <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Uncaught exception: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mes</span><span class="p">)</span>
    <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">CACHED_PREFIXES</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">PLOT</span><span class="p">:</span>
        <span class="n">lib_plot</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">config_pytomo</span><span class="o">.</span><span class="n">COLUMN_NAMES</span><span class="p">,</span>
                           <span class="n">image_file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result_file</span><span class="p">:</span>
        <span class="n">result_stream</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">log_md5_results</span><span class="p">(</span><span class="n">result_file</span><span class="p">,</span> <span class="n">db_file</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Compressing the files: wait a bit&#39;</span><span class="p">)</span>
    <span class="n">tarfile_name</span> <span class="o">=</span> <span class="n">check_out_files</span><span class="p">(</span><span class="s">&#39;to_send.tbz&#39;</span><span class="p">,</span>
                                   <span class="n">config_pytomo</span><span class="o">.</span><span class="n">LOG_DIR</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
    <span class="n">tar_file</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">tarfile_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;w:bz2&#39;</span><span class="p">)</span>
    <span class="n">tar_file</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">db_file</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">tar_file</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="n">arcname</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">log_file</span><span class="p">))</span>
    <span class="n">tar_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c"># upload archive on the FTP server</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">CENTRALISE_DATA</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;Trying to upload the files on the centralisation server...</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">ftp</span> <span class="o">=</span> <span class="n">lib_data_centralisation</span><span class="o">.</span><span class="n">PytomoFTP</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ftp</span><span class="o">.</span><span class="n">created</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ftp</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="n">tarfile_name</span><span class="p">)</span> <span class="o">!=</span>
                <span class="n">lib_data_centralisation</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">File </span><span class="si">%s</span><span class="s"> has been uploaded on </span><span class="si">%s</span><span class="s"> server.&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">tarfile_name</span><span class="p">,</span> <span class="n">lib_data_centralisation</span><span class="o">.</span><span class="n">MAIN_SERVER</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">WARNING! File </span><span class="si">%s</span><span class="s"> was not uploaded to </span><span class="si">%s</span><span class="s"> server.&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">tarfile_name</span><span class="p">,</span> <span class="n">lib_data_centralisation</span><span class="o">.</span><span class="n">MAIN_SERVER</span><span class="p">))</span>
            <span class="n">ftp</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">WARNING! Could not establish connection to </span><span class="si">%s</span><span class="s"> FTP server.&#39;</span>
                  <span class="o">%</span> <span class="p">(</span><span class="n">lib_data_centralisation</span><span class="o">.</span><span class="n">MAIN_SERVER</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">Crawl finished.</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n\n</span><span class="s">PLEASE SEND THIS FILE BY EMAIL: &#39;</span>
           <span class="s">&#39;(to pytomo@gmail.com)</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span>
           <span class="o">%</span> <span class="p">(</span><span class="n">SEPARATOR_LINE</span><span class="p">,</span> <span class="n">tarfile_name</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">options</span><span class="o">.</span><span class="n">BATCH_MODE</span><span class="p">:</span>
        <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Press Enter to exit</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>
</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">Pytomo 2.8.6 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Louis Plissoneau.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>