

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pytomo.web.wsgiserver &mdash; Pytomo 2.8.6 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '2.8.6',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Pytomo 2.8.6 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Pytomo 2.8.6 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pytomo.web.wsgiserver</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;A high-speed, production ready, thread pooled, generic HTTP server.</span>

<span class="sd">Simplest example on how to use this module directly</span>
<span class="sd">(without using CherryPy&#39;s application machinery)::</span>

<span class="sd">    from cherrypy import wsgiserver</span>
<span class="sd">    </span>
<span class="sd">    def my_crazy_app(environ, start_response):</span>
<span class="sd">        status = &#39;200 OK&#39;</span>
<span class="sd">        response_headers = [(&#39;Content-type&#39;,&#39;text/plain&#39;)]</span>
<span class="sd">        start_response(status, response_headers)</span>
<span class="sd">        return [&#39;Hello world!&#39;]</span>
<span class="sd">    </span>
<span class="sd">    server = wsgiserver.CherryPyWSGIServer(</span>
<span class="sd">                (&#39;0.0.0.0&#39;, 8070), my_crazy_app,</span>
<span class="sd">                server_name=&#39;www.cherrypy.example&#39;)</span>
<span class="sd">    server.start()</span>
<span class="sd">    </span>
<span class="sd">The CherryPy WSGI server can serve as many WSGI applications </span>
<span class="sd">as you want in one instance by using a WSGIPathInfoDispatcher::</span>
<span class="sd">    </span>
<span class="sd">    d = WSGIPathInfoDispatcher({&#39;/&#39;: my_crazy_app, &#39;/blog&#39;: my_blog_app})</span>
<span class="sd">    server = wsgiserver.CherryPyWSGIServer((&#39;0.0.0.0&#39;, 80), d)</span>
<span class="sd">    </span>
<span class="sd">Want SSL support? Just set server.ssl_adapter to an SSLAdapter instance.</span>

<span class="sd">This won&#39;t call the CherryPy engine (application side) at all, only the</span>
<span class="sd">HTTP server, which is independent from the rest of CherryPy. Don&#39;t</span>
<span class="sd">let the name &quot;CherryPyWSGIServer&quot; throw you; the name merely reflects</span>
<span class="sd">its origin, not its coupling.</span>

<span class="sd">For those of you wanting to understand internals of this module, here&#39;s the</span>
<span class="sd">basic call flow. The server&#39;s listening thread runs a very tight loop,</span>
<span class="sd">sticking incoming connections onto a Queue::</span>

<span class="sd">    server = CherryPyWSGIServer(...)</span>
<span class="sd">    server.start()</span>
<span class="sd">    while True:</span>
<span class="sd">        tick()</span>
<span class="sd">        # This blocks until a request comes in:</span>
<span class="sd">        child = socket.accept()</span>
<span class="sd">        conn = HTTPConnection(child, ...)</span>
<span class="sd">        server.requests.put(conn)</span>

<span class="sd">Worker threads are kept in a pool and poll the Queue, popping off and then</span>
<span class="sd">handling each connection in turn. Each connection can consist of an arbitrary</span>
<span class="sd">number of requests and their responses, so we run a nested loop::</span>

<span class="sd">    while True:</span>
<span class="sd">        conn = server.requests.get()</span>
<span class="sd">        conn.communicate()</span>
<span class="sd">        -&gt;  while True:</span>
<span class="sd">                req = HTTPRequest(...)</span>
<span class="sd">                req.parse_request()</span>
<span class="sd">                -&gt;  # Read the Request-Line, e.g. &quot;GET /page HTTP/1.1&quot;</span>
<span class="sd">                    req.rfile.readline()</span>
<span class="sd">                    read_headers(req.rfile, req.inheaders)</span>
<span class="sd">                req.respond()</span>
<span class="sd">                -&gt;  response = app(...)</span>
<span class="sd">                    try:</span>
<span class="sd">                        for chunk in response:</span>
<span class="sd">                            if chunk:</span>
<span class="sd">                                req.write(chunk)</span>
<span class="sd">                    finally:</span>
<span class="sd">                        if hasattr(response, &quot;close&quot;):</span>
<span class="sd">                            response.close()</span>
<span class="sd">                if req.close_connection:</span>
<span class="sd">                    return</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">CRLF</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">Queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">quoted_slash</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;(?i)</span><span class="si">%2F</span><span class="s">&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">rfc822</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="k">if</span> <span class="s">&#39;win&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;IPPROTO_IPV6&#39;</span><span class="p">):</span>
    <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span> <span class="o">=</span> <span class="mi">41</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">cStringIO</span> <span class="kn">as</span> <span class="nn">StringIO</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">StringIO</span>
<span class="n">DEFAULT_BUFFER_SIZE</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">_fileobject_uses_str_type</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">_fileobject</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span><span class="o">.</span><span class="n">_rbuf</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<div class="viewcode-block" id="format_exc"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.format_exc">[docs]</a><span class="k">def</span> <span class="nf">format_exc</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Like print_exc() but return a string. Backport for Python 2.3.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="n">etype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">,</span> <span class="n">limit</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">etype</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="n">tb</span> <span class="o">=</span> <span class="bp">None</span>

</div>
<span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">unquote</span>
<span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">urlparse</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">errno</span>

<div class="viewcode-block" id="plat_specific_errors"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.plat_specific_errors">[docs]</a><span class="k">def</span> <span class="nf">plat_specific_errors</span><span class="p">(</span><span class="o">*</span><span class="n">errnames</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return error numbers for all errors in errnames on this platform.</span>
<span class="sd">    </span>
<span class="sd">    The &#39;errno&#39; module contains different global constants depending on</span>
<span class="sd">    the specific platform (OS). This function will return the list of</span>
<span class="sd">    numeric values for a given list of potential names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">errno_names</span> <span class="o">=</span> <span class="nb">dir</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">errnames</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">errno_names</span><span class="p">]</span>
    <span class="c"># de-dupe the list</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</div>
<span class="n">socket_error_eintr</span> <span class="o">=</span> <span class="n">plat_specific_errors</span><span class="p">(</span><span class="s">&quot;EINTR&quot;</span><span class="p">,</span> <span class="s">&quot;WSAEINTR&quot;</span><span class="p">)</span>

<span class="n">socket_errors_to_ignore</span> <span class="o">=</span> <span class="n">plat_specific_errors</span><span class="p">(</span>
    <span class="s">&quot;EPIPE&quot;</span><span class="p">,</span>
    <span class="s">&quot;EBADF&quot;</span><span class="p">,</span> <span class="s">&quot;WSAEBADF&quot;</span><span class="p">,</span>
    <span class="s">&quot;ENOTSOCK&quot;</span><span class="p">,</span> <span class="s">&quot;WSAENOTSOCK&quot;</span><span class="p">,</span>
    <span class="s">&quot;ETIMEDOUT&quot;</span><span class="p">,</span> <span class="s">&quot;WSAETIMEDOUT&quot;</span><span class="p">,</span>
    <span class="s">&quot;ECONNREFUSED&quot;</span><span class="p">,</span> <span class="s">&quot;WSAECONNREFUSED&quot;</span><span class="p">,</span>
    <span class="s">&quot;ECONNRESET&quot;</span><span class="p">,</span> <span class="s">&quot;WSAECONNRESET&quot;</span><span class="p">,</span>
    <span class="s">&quot;ECONNABORTED&quot;</span><span class="p">,</span> <span class="s">&quot;WSAECONNABORTED&quot;</span><span class="p">,</span>
    <span class="s">&quot;ENETRESET&quot;</span><span class="p">,</span> <span class="s">&quot;WSAENETRESET&quot;</span><span class="p">,</span>
    <span class="s">&quot;EHOSTDOWN&quot;</span><span class="p">,</span> <span class="s">&quot;EHOSTUNREACH&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">socket_errors_to_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;timed out&quot;</span><span class="p">)</span>
<span class="n">socket_errors_to_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;The read operation timed out&quot;</span><span class="p">)</span>

<span class="n">socket_errors_nonblocking</span> <span class="o">=</span> <span class="n">plat_specific_errors</span><span class="p">(</span>
    <span class="s">&#39;EAGAIN&#39;</span><span class="p">,</span> <span class="s">&#39;EWOULDBLOCK&#39;</span><span class="p">,</span> <span class="s">&#39;WSAEWOULDBLOCK&#39;</span><span class="p">)</span>

<span class="n">comma_separated_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;Accept&#39;</span><span class="p">,</span> <span class="s">&#39;Accept-Charset&#39;</span><span class="p">,</span> <span class="s">&#39;Accept-Encoding&#39;</span><span class="p">,</span>
    <span class="s">&#39;Accept-Language&#39;</span><span class="p">,</span> <span class="s">&#39;Accept-Ranges&#39;</span><span class="p">,</span> <span class="s">&#39;Allow&#39;</span><span class="p">,</span> <span class="s">&#39;Cache-Control&#39;</span><span class="p">,</span>
    <span class="s">&#39;Connection&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;Content-Language&#39;</span><span class="p">,</span> <span class="s">&#39;Expect&#39;</span><span class="p">,</span>
    <span class="s">&#39;If-Match&#39;</span><span class="p">,</span> <span class="s">&#39;If-None-Match&#39;</span><span class="p">,</span> <span class="s">&#39;Pragma&#39;</span><span class="p">,</span> <span class="s">&#39;Proxy-Authenticate&#39;</span><span class="p">,</span> <span class="s">&#39;TE&#39;</span><span class="p">,</span>
    <span class="s">&#39;Trailer&#39;</span><span class="p">,</span> <span class="s">&#39;Transfer-Encoding&#39;</span><span class="p">,</span> <span class="s">&#39;Upgrade&#39;</span><span class="p">,</span> <span class="s">&#39;Vary&#39;</span><span class="p">,</span> <span class="s">&#39;Via&#39;</span><span class="p">,</span> <span class="s">&#39;Warning&#39;</span><span class="p">,</span>
    <span class="s">&#39;WWW-Authenticate&#39;</span><span class="p">]</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="s">&#39;statistics&#39;</span><span class="p">):</span> <span class="n">logging</span><span class="o">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="read_headers"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.read_headers">[docs]</a><span class="k">def</span> <span class="nf">read_headers</span><span class="p">(</span><span class="n">rfile</span><span class="p">,</span> <span class="n">hdict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read headers from the given stream into the given header dict.</span>
<span class="sd">    </span>
<span class="sd">    If hdict is None, a new header dict is created. Returns the populated</span>
<span class="sd">    header dict.</span>
<span class="sd">    </span>
<span class="sd">    Headers which are repeated are folded together using a comma if their</span>
<span class="sd">    specification so dictates.</span>
<span class="sd">    </span>
<span class="sd">    This function raises ValueError when the read bytes violate the HTTP spec.</span>
<span class="sd">    You should probably return &quot;400 Bad Request&quot; if this happens.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hdict</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">hdict</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="c"># No more data--illegal end of headers</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Illegal end of headers.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">CRLF</span><span class="p">:</span>
            <span class="c"># Normal end of headers</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">CRLF</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;HTTP requires CRLF terminators&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39; </span><span class="se">\t</span><span class="s">&#39;</span><span class="p">:</span>
            <span class="c"># It&#39;s a continuation line.</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Illegal header line.&quot;</span><span class="p">)</span>
            <span class="c"># TODO: what about TE and WWW-Authenticate?</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">hname</span> <span class="o">=</span> <span class="n">k</span>
        
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">comma_separated_headers</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="n">hdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">hname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="n">existing</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
        <span class="n">hdict</span><span class="p">[</span><span class="n">hname</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    
    <span class="k">return</span> <span class="n">hdict</span>

</div>
<div class="viewcode-block" id="MaxSizeExceeded"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.MaxSizeExceeded">[docs]</a><span class="k">class</span> <span class="nc">MaxSizeExceeded</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>
</div>
<div class="viewcode-block" id="SizeCheckWrapper"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SizeCheckWrapper">[docs]</a><span class="k">class</span> <span class="nc">SizeCheckWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a file-like object, raising MaxSizeExceeded if too large.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">def</span> <span class="nf">_check_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxSizeExceeded</span><span class="p">()</span>
    
<div class="viewcode-block" id="SizeCheckWrapper.read"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SizeCheckWrapper.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>
    </div>
<div class="viewcode-block" id="SizeCheckWrapper.readline"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SizeCheckWrapper.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">data</span>
        
        <span class="c"># User didn&#39;t specify a size ...</span>
        <span class="c"># We read the line in chunks to make sure it&#39;s not a 100MB line !</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c"># See http://www.cherrypy.org/ticket/421</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="SizeCheckWrapper.readlines"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SizeCheckWrapper.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lines</span>
    </div>
<div class="viewcode-block" id="SizeCheckWrapper.close"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SizeCheckWrapper.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    
<div class="viewcode-block" id="SizeCheckWrapper.next"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SizeCheckWrapper.next">[docs]</a>    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_length</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

</div></div>
<div class="viewcode-block" id="KnownLengthRFile"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.KnownLengthRFile">[docs]</a><span class="k">class</span> <span class="nc">KnownLengthRFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a file-like object, returning an empty string when exhausted.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">content_length</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">=</span> <span class="n">content_length</span>
    
<div class="viewcode-block" id="KnownLengthRFile.read"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.KnownLengthRFile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    </div>
<div class="viewcode-block" id="KnownLengthRFile.readline"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.KnownLengthRFile.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span><span class="p">)</span>
        
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    </div>
<div class="viewcode-block" id="KnownLengthRFile.readlines"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.KnownLengthRFile.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>
    </div>
<div class="viewcode-block" id="KnownLengthRFile.close"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.KnownLengthRFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>
    
    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

</div>
<div class="viewcode-block" id="ChunkedRFile"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ChunkedRFile">[docs]</a><span class="k">class</span> <span class="nc">ChunkedRFile</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Wraps a file-like object, returning an empty string when exhausted.</span>
<span class="sd">    </span>
<span class="sd">    This class is intended to provide a conforming wsgi.input value for</span>
<span class="sd">    request entities that have been encoded with the &#39;chunked&#39; transfer</span>
<span class="sd">    encoding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rfile</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="mi">8192</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">rfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="o">=</span> <span class="n">maxlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">bufsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">_fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MaxSizeExceeded</span><span class="p">(</span><span class="s">&quot;Request Entity Too Large&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">)</span>
        
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;;&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Bad chunked transfer size: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">chunk_size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">closed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">return</span>
        
<span class="c">##            if line: chunk_extension = line[0]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+</span> <span class="n">chunk_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Request Entity Too Large&quot;</span><span class="p">)</span>
        
        <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">+=</span> <span class="n">chunk</span>
        
        <span class="n">crlf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crlf</span> <span class="o">!=</span> <span class="n">CRLF</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                 <span class="s">&quot;Bad chunked transfer coding (expected &#39;</span><span class="se">\\</span><span class="s">r</span><span class="se">\\</span><span class="s">n&#39;, &quot;</span>
                 <span class="s">&quot;got &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">crlf</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="ChunkedRFile.read"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ChunkedRFile.read">[docs]</a>    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fetch</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                    <span class="c"># EOF</span>
                    <span class="k">return</span> <span class="n">data</span>
            
            <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
                <span class="n">remaining</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">remaining</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span>
    </div>
<div class="viewcode-block" id="ChunkedRFile.readline"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ChunkedRFile.readline">[docs]</a>    <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fetch</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
                    <span class="c"># EOF</span>
                    <span class="k">return</span> <span class="n">data</span>
            
            <span class="n">newline_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">size</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newline_pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">remaining</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">remaining</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">remaining</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">newline_pos</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">remaining</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">remaining</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newline_pos</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[:</span><span class="n">newline_pos</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">[</span><span class="n">newline_pos</span><span class="p">:]</span>
    </div>
<div class="viewcode-block" id="ChunkedRFile.readlines"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ChunkedRFile.readlines">[docs]</a>    <span class="k">def</span> <span class="nf">readlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sizehint</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lines</span>
    </div>
<div class="viewcode-block" id="ChunkedRFile.read_trailer_lines"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ChunkedRFile.read_trailer_lines">[docs]</a>    <span class="k">def</span> <span class="nf">read_trailer_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s">&quot;Cannot read trailers until the request body has been read.&quot;</span><span class="p">)</span>
        
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="c"># No more data--illegal end of headers</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Illegal end of headers.&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxlen</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&quot;Request Entity Too Large&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">CRLF</span><span class="p">:</span>
                <span class="c"># Normal end of headers</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">CRLF</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;HTTP requires CRLF terminators&quot;</span><span class="p">)</span>
            
            <span class="k">yield</span> <span class="n">line</span>
    </div>
<div class="viewcode-block" id="ChunkedRFile.close"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ChunkedRFile.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    </div>
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Shamelessly stolen from StringIO</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">line</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">sizehint</span> <span class="o">&lt;=</span> <span class="n">total</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">sizehint</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="HTTPRequest"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest">[docs]</a><span class="k">class</span> <span class="nc">HTTPRequest</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An HTTP Request (and response).</span>
<span class="sd">    </span>
<span class="sd">    A single HTTP connection may consist of multiple request/response pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">server</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The HTTPServer object which is receiving this request.&quot;&quot;&quot;</span>
    
    <span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The HTTPConnection object on which this request connected.&quot;&quot;&quot;</span>
    
    <span class="n">inheaders</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="sd">&quot;&quot;&quot;A dict of request headers.&quot;&quot;&quot;</span>
    
    <span class="n">outheaders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;A list of header tuples to write in the response.&quot;&quot;&quot;</span>
    
    <span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;When True, the request has been parsed and is ready to begin generating</span>
<span class="sd">    the response. When False, signals the calling Connection that the response</span>
<span class="sd">    should not be generated and the connection should close.&quot;&quot;&quot;</span>
    
    <span class="n">close_connection</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;Signals the calling Connection that the request should close. This does</span>
<span class="sd">    not imply an error! The client and/or server may each request that the</span>
<span class="sd">    connection be closed.&quot;&quot;&quot;</span>
    
    <span class="n">chunked_write</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;If True, output will be encoded with the &quot;chunked&quot; transfer-coding.</span>
<span class="sd">    </span>
<span class="sd">    This value is set automatically inside send_headers.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_request</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;http&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="s">&quot;https&quot;</span>
        <span class="c"># Use the lowest-common protocol in case read_request_line errors.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">=</span> <span class="s">&#39;HTTP/1.0&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">close_connection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">chunked_write</span>
    
<div class="viewcode-block" id="HTTPRequest.parse_request"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.parse_request">[docs]</a>    <span class="k">def</span> <span class="nf">parse_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the next HTTP request start-line and message-headers.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">SizeCheckWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">max_request_header_size</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_request_line</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">MaxSizeExceeded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;414 Request-URI Too Long&quot;</span><span class="p">,</span>
                <span class="s">&quot;The Request-URI sent with the request exceeds the maximum &quot;</span>
                <span class="s">&quot;allowed bytes.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_request_headers</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">MaxSizeExceeded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;413 Request Entity Too Large&quot;</span><span class="p">,</span>
                <span class="s">&quot;The headers sent with the request exceed the maximum &quot;</span>
                <span class="s">&quot;allowed bytes.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="HTTPRequest.read_request_line"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.read_request_line">[docs]</a>    <span class="k">def</span> <span class="nf">read_request_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># HTTP/1.1 connections are persistent by default. If a client</span>
        <span class="c"># requests a page, then idles (leaves the connection open),</span>
        <span class="c"># then rfile.readline() will raise socket.error(&quot;timed out&quot;).</span>
        <span class="c"># Note that it does this based on the value given to settimeout(),</span>
        <span class="c"># and doesn&#39;t need the client to request or acknowledge the close</span>
        <span class="c"># (although your TCP stack might suffer for it: cf Apache&#39;s history</span>
        <span class="c"># with FIN_WAIT_2).</span>
        <span class="n">request_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        
        <span class="c"># Set started_request to True so communicate() knows to send 408</span>
        <span class="c"># from here on out.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_request</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request_line</span><span class="p">:</span>
            <span class="c"># Force self.ready = False so the connection will close.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">request_line</span> <span class="o">==</span> <span class="n">CRLF</span><span class="p">:</span>
            <span class="c"># RFC 2616 sec 4.1: &quot;...if the server is reading the protocol</span>
            <span class="c"># stream at the beginning of a message and receives a CRLF</span>
            <span class="c"># first, it should ignore the CRLF.&quot;</span>
            <span class="c"># But only ignore one leading line! else we enable a DoS.</span>
            <span class="n">request_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request_line</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">return</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request_line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">CRLF</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="s">&quot;HTTP requires CRLF terminators&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">method</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="n">req_protocol</span> <span class="o">=</span> <span class="n">request_line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">rp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">req_protocol</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">req_protocol</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="s">&quot;Malformed Request-Line&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        
        <span class="c"># uri may be an abs_path (including &quot;http://host.domain.tld&quot;);</span>
        <span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_request_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;400 Bad Request&quot;</span><span class="p">,</span>
                                 <span class="s">&quot;Illegal #fragment in Request-URI.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">scheme</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span>
        
        <span class="n">qs</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">qs</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c"># Unquote the path+params (e.g. &quot;/this%20path&quot; -&gt; &quot;/this path&quot;).</span>
        <span class="c"># http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html#sec5.1.2</span>
        <span class="c">#</span>
        <span class="c"># But note that &quot;...a URI must be separated into its components</span>
        <span class="c"># before the escaped characters within those components can be</span>
        <span class="c"># safely decoded.&quot; http://www.ietf.org/rfc/rfc2396.txt, sec 2.4.2</span>
        <span class="c"># Therefore, &quot;/this%2Fpath&quot; becomes &quot;/this%2Fpath&quot;, not &quot;/this/path&quot;.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atoms</span> <span class="o">=</span> <span class="p">[</span><span class="n">unquote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">quoted_slash</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span>
        <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%2F</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        
        <span class="c"># Note that, like wsgiref and most other HTTP servers,</span>
        <span class="c"># we &quot;% HEX HEX&quot;-unquote the path but not the query string.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span>
        
        <span class="c"># Compare request and server HTTP protocol versions, in case our</span>
        <span class="c"># server does not support the requested protocol. Limit our output</span>
        <span class="c"># to min(req, server). We want the following output:</span>
        <span class="c">#     request    server     actual written   supported response</span>
        <span class="c">#     protocol   protocol  response protocol    feature set</span>
        <span class="c"># a     1.0        1.0           1.0                1.0</span>
        <span class="c"># b     1.0        1.1           1.1                1.0</span>
        <span class="c"># c     1.1        1.0           1.0                1.0</span>
        <span class="c"># d     1.1        1.1           1.1                1.1</span>
        <span class="c"># Notice that, in (b), the response will be &quot;HTTP/1.1&quot; even though</span>
        <span class="c"># the client only understands 1.0. RFC 2616 10.5.6 says we should</span>
        <span class="c"># only return 505 if the _major_ version is different.</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;505 HTTP Version Not Supported&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_protocol</span> <span class="o">=</span> <span class="n">req_protocol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">=</span> <span class="s">&quot;HTTP/</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">min</span><span class="p">(</span><span class="n">rp</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="HTTPRequest.read_request_headers"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.read_request_headers">[docs]</a>    <span class="k">def</span> <span class="nf">read_request_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read self.rfile into self.inheaders. Return success.&quot;&quot;&quot;</span>
        
        <span class="c"># then all the http headers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">read_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;400 Bad Request&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="n">mrbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">max_request_body_size</span>
        <span class="k">if</span> <span class="n">mrbs</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">mrbs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;413 Request Entity Too Large&quot;</span><span class="p">,</span>
                <span class="s">&quot;The entity sent with the request exceeds the maximum &quot;</span>
                <span class="s">&quot;allowed bytes.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        
        <span class="c"># Persistent connection support</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
            <span class="c"># Both server and client are HTTP/1.1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Connection&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;close&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Either the server or client (or both) are HTTP/1.0</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Connection&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;Keep-Alive&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="c"># Transfer-Encoding support</span>
        <span class="n">te</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s">&quot;HTTP/1.1&quot;</span><span class="p">:</span>
            <span class="n">te</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">te</span><span class="p">:</span>
                <span class="n">te</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">te</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span> <span class="o">=</span> <span class="bp">False</span>
        
        <span class="k">if</span> <span class="n">te</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">enc</span> <span class="ow">in</span> <span class="n">te</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">enc</span> <span class="o">==</span> <span class="s">&quot;chunked&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Note that, even if we see &quot;chunked&quot;, we must reject</span>
                    <span class="c"># if there is an extension we don&#39;t recognize.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;501 Unimplemented&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">return</span> <span class="bp">False</span>
        
        <span class="c"># From PEP 333:</span>
        <span class="c"># &quot;Servers and gateways that implement HTTP 1.1 must provide</span>
        <span class="c"># transparent support for HTTP 1.1&#39;s &quot;expect/continue&quot; mechanism.</span>
        <span class="c"># This may be done in any of several ways:</span>
        <span class="c">#   1. Respond to requests containing an Expect: 100-continue request</span>
        <span class="c">#      with an immediate &quot;100 Continue&quot; response, and proceed normally.</span>
        <span class="c">#   2. Proceed with the request normally, but provide the application</span>
        <span class="c">#      with a wsgi.input stream that will send the &quot;100 Continue&quot;</span>
        <span class="c">#      response if/when the application first attempts to read from</span>
        <span class="c">#      the input stream. The read request must then remain blocked</span>
        <span class="c">#      until the client responds.</span>
        <span class="c">#   3. Wait until the client decides that the server does not support</span>
        <span class="c">#      expect/continue, and sends the request body on its own.</span>
        <span class="c">#      (This is suboptimal, and is not recommended.)</span>
        <span class="c">#</span>
        <span class="c"># We used to do 3, but are now doing 1. Maybe we&#39;ll do 2 someday,</span>
        <span class="c"># but it seems like it would be a big slowdown for such a rare case.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Expect&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;100-continue&quot;</span><span class="p">:</span>
            <span class="c"># Don&#39;t use simple_response here, because it emits headers</span>
            <span class="c"># we don&#39;t want. See http://www.cherrypy.org/ticket/951</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span> <span class="o">+</span> <span class="s">&quot; 100 Continue</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                    <span class="k">raise</span>
        <span class="k">return</span> <span class="bp">True</span>
    </div>
<div class="viewcode-block" id="HTTPRequest.parse_request_uri"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.parse_request_uri">[docs]</a>    <span class="k">def</span> <span class="nf">parse_request_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a Request-URI into (scheme, authority, path).</span>
<span class="sd">        </span>
<span class="sd">        Note that Request-URI&#39;s must be one of::</span>
<span class="sd">            </span>
<span class="sd">            Request-URI    = &quot;*&quot; | absoluteURI | abs_path | authority</span>
<span class="sd">        </span>
<span class="sd">        Therefore, a Request-URI which starts with a double forward-slash</span>
<span class="sd">        cannot be a &quot;net_path&quot;::</span>
<span class="sd">        </span>
<span class="sd">            net_path      = &quot;//&quot; authority [ abs_path ]</span>
<span class="sd">        </span>
<span class="sd">        Instead, it must be interpreted as an &quot;abs_path&quot; with an empty first</span>
<span class="sd">        path segment::</span>
<span class="sd">        </span>
<span class="sd">            abs_path      = &quot;/&quot;  path_segments</span>
<span class="sd">            path_segments = segment *( &quot;/&quot; segment )</span>
<span class="sd">            segment       = *pchar *( &quot;;&quot; param )</span>
<span class="sd">            param         = *pchar</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="o">==</span> <span class="s">&quot;*&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">uri</span>
        
        <span class="n">i</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s">&#39;?&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">uri</span><span class="p">[:</span><span class="n">i</span><span class="p">]:</span>
            <span class="c"># An absoluteURI.</span>
            <span class="c"># If there&#39;s a scheme (and it must be http or https), then:</span>
            <span class="c"># http_URL = &quot;http:&quot; &quot;//&quot; host [ &quot;:&quot; port ] [ abs_path [ &quot;?&quot; query ]]</span>
            <span class="n">scheme</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">uri</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:]</span>
            <span class="n">authority</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">remainder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">authority</span><span class="p">,</span> <span class="n">path</span>
        
        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
            <span class="c"># An abs_path.</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">uri</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># An authority.</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">uri</span><span class="p">,</span> <span class="bp">None</span>
    </div>
<div class="viewcode-block" id="HTTPRequest.respond"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.respond">[docs]</a>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call the gateway and write its iterable output.&quot;&quot;&quot;</span>
        <span class="n">mrbs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">max_request_body_size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">ChunkedRFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="n">mrbs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Content-Length&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">mrbs</span> <span class="ow">and</span> <span class="n">mrbs</span> <span class="o">&lt;</span> <span class="n">cl</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;413 Request Entity Too Large&quot;</span><span class="p">,</span>
                        <span class="s">&quot;The entity sent with the request exceeds the maximum &quot;</span>
                        <span class="s">&quot;allowed bytes.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">KnownLengthRFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="n">cl</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">gateway</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">respond</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sent_headers</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_headers</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">&quot;0</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="HTTPRequest.simple_response"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.simple_response">[docs]</a>    <span class="k">def</span> <span class="nf">simple_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a simple response back to the client.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span>
               <span class="n">status</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">,</span>
               <span class="s">&quot;Content-Length: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
               <span class="s">&quot;Content-Type: text/plain</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">status</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;413&quot;</span><span class="p">,</span> <span class="s">&quot;414&quot;</span><span class="p">):</span>
            <span class="c"># Request Entity Too Large / Request-URI Too Long</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s">&#39;HTTP/1.1&#39;</span><span class="p">:</span>
                <span class="c"># This will not be true for 414, since read_request_line</span>
                <span class="c"># usually raises 414 before reading the whole line, and we</span>
                <span class="c"># therefore cannot know the proper response_protocol.</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;Connection: close</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># HTTP/1.0 had no 413/414 status nor Connection header.</span>
                <span class="c"># Emit 400 instead and trust the message body is enough.</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s">&quot;400 Bad Request&quot;</span>
        
        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CRLF</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;ISO-8859-1&quot;</span><span class="p">)</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                <span class="k">raise</span>
    </div>
<div class="viewcode-block" id="HTTPRequest.write"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write unbuffered data to the client.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span> <span class="ow">and</span> <span class="n">chunk</span><span class="p">:</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="nb">hex</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">))[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">CRLF</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">CRLF</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="HTTPRequest.send_headers"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPRequest.send_headers">[docs]</a>    <span class="k">def</span> <span class="nf">send_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assert, process, and send the HTTP response message-headers.</span>
<span class="sd">        </span>
<span class="sd">        You must set self.status, and self.outheaders before calling this.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">413</span><span class="p">:</span>
            <span class="c"># Request Entity Too Large. Close conn to avoid garbage.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="s">&quot;content-length&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="c"># &quot;All 1xx (informational), 204 (no content),</span>
            <span class="c"># and 304 (not modified) responses MUST NOT</span>
            <span class="c"># include a message-body.&quot; So no point chunking.</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">status</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span> <span class="mi">304</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s">&#39;HTTP/1.1&#39;</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s">&#39;HEAD&#39;</span><span class="p">):</span>
                    <span class="c"># Use the chunked transfer-coding</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">chunked_write</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;Transfer-Encoding&quot;</span><span class="p">,</span> <span class="s">&quot;chunked&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Closing the conn is the only way to determine len.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="k">if</span> <span class="s">&quot;connection&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_protocol</span> <span class="o">==</span> <span class="s">&#39;HTTP/1.1&#39;</span><span class="p">:</span>
                <span class="c"># Both server and client are HTTP/1.1 or better</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;Connection&quot;</span><span class="p">,</span> <span class="s">&quot;close&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Server and/or client are HTTP/1.0</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;Connection&quot;</span><span class="p">,</span> <span class="s">&quot;Keep-Alive&quot;</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunked_read</span><span class="p">):</span>
            <span class="c"># Read any remaining request body data on the socket.</span>
            <span class="c"># &quot;If an origin server receives a request that does not include an</span>
            <span class="c"># Expect request-header field with the &quot;100-continue&quot; expectation,</span>
            <span class="c"># the request includes a request body, and the server responds</span>
            <span class="c"># with a final status code before reading the entire request body</span>
            <span class="c"># from the transport connection, then the server SHOULD NOT close</span>
            <span class="c"># the transport connection until it has read the entire request,</span>
            <span class="c"># or until the client closes the connection. Otherwise, the client</span>
            <span class="c"># might not reliably receive the response message. However, this</span>
            <span class="c"># requirement is not be construed as preventing a server from</span>
            <span class="c"># defending itself against denial-of-service attacks, or from</span>
            <span class="c"># badly broken client implementations.&quot;</span>
            <span class="n">remaining</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span> <span class="s">&#39;remaining&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">remaining</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s">&quot;date&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;Date&quot;</span><span class="p">,</span> <span class="n">rfc822</span><span class="o">.</span><span class="n">formatdate</span><span class="p">()))</span>
        
        <span class="k">if</span> <span class="s">&quot;server&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hkeys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s">&quot;Server&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_name</span><span class="p">))</span>
        
        <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outheaders</span><span class="p">:</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">CRLF</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CRLF</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>

</div></div>
<div class="viewcode-block" id="NoSSLError"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.NoSSLError">[docs]</a><span class="k">class</span> <span class="nc">NoSSLError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised when a client speaks HTTP to an HTTPS socket.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="FatalSSLAlert"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.FatalSSLAlert">[docs]</a><span class="k">class</span> <span class="nc">FatalSSLAlert</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exception raised when the SSL implementation signals a fatal alert.&quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="CP_fileobject"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CP_fileobject">[docs]</a><span class="k">class</span> <span class="nc">CP_fileobject</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">_fileobject</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Faux file object attached to a socket object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">socket</span><span class="o">.</span><span class="n">_fileobject</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
<div class="viewcode-block" id="CP_fileobject.sendall"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CP_fileobject.sendall">[docs]</a>    <span class="k">def</span> <span class="nf">sendall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sendall for non-blocking sockets.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bytes_sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bytes_sent</span><span class="p">:]</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_nonblocking</span><span class="p">:</span>
                    <span class="k">raise</span>
</div>
<div class="viewcode-block" id="CP_fileobject.send"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CP_fileobject.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">bytes_sent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">+=</span> <span class="n">bytes_sent</span>
        <span class="k">return</span> <span class="n">bytes_sent</span>
</div>
<div class="viewcode-block" id="CP_fileobject.flush"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CP_fileobject.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wbuf</span><span class="p">:</span>
            <span class="nb">buffer</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wbuf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_wbuf</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CP_fileobject.recv"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CP_fileobject.recv">[docs]</a>    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">data</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_nonblocking</span>
                    <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_error_eintr</span><span class="p">):</span>
                    <span class="k">raise</span>
</div>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_fileobject_uses_str_type</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c"># Use max, disallow tiny reads in a loop as they are very inefficient.</span>
            <span class="c"># We never leave read() with any leftover data from a new recv() call</span>
            <span class="c"># in our internal buffer.</span>
            <span class="n">rbufsize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_bufsize</span><span class="p">)</span>
            <span class="c"># Our use of StringIO rather than lists of string objects returned by</span>
            <span class="c"># recv() minimizes memory usage and fragmentation that occurs when</span>
            <span class="c"># rbufsize is large compared to the typical return value of recv().</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c"># seek end</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># Read until EOF</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>  <span class="c"># reset _rbuf.  we consume it via buf.</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">rbufsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Read until size bytes or EOF seen, whichever comes first</span>
                <span class="n">buf_len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">buf_len</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                    <span class="c"># Already have size bytes in our buffer?  Extract and return.</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="k">return</span> <span class="n">rv</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>  <span class="c"># reset _rbuf.  we consume it via buf.</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">buf_len</span>
                    <span class="c"># recv() will malloc the amount of memory given as its</span>
                    <span class="c"># parameter even though it often returns much less data</span>
                    <span class="c"># than that.  The returned data string is short lived</span>
                    <span class="c"># as we copy it into a StringIO and free it.  This avoids</span>
                    <span class="c"># fragmentation issues on many platforms.</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">size</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">buf_len</span><span class="p">:</span>
                        <span class="c"># Shortcut.  Avoid buffer data copies when:</span>
                        <span class="c"># - We have no data in our buffer.</span>
                        <span class="c"># AND</span>
                        <span class="c"># - Our call to recv returned exactly the</span>
                        <span class="c">#   number of bytes we were asked to read.</span>
                        <span class="k">return</span> <span class="n">data</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">left</span><span class="p">:</span>
                        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                        <span class="k">del</span> <span class="n">data</span>  <span class="c"># explicit free</span>
                        <span class="k">break</span>
                    <span class="k">assert</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">left</span><span class="p">,</span> <span class="s">&quot;recv(</span><span class="si">%d</span><span class="s">) returned </span><span class="si">%d</span><span class="s"> bytes&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">buf_len</span> <span class="o">+=</span> <span class="n">n</span>
                    <span class="k">del</span> <span class="n">data</span>  <span class="c"># explicit free</span>
                    <span class="c">#assert buf_len == buf.tell()</span>
                <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span>
            <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c"># seek end</span>
            <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># check if we already have it in our buffer</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">bline</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">readline</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bline</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">bline</span><span class="p">)</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="k">return</span> <span class="n">bline</span>
                <span class="k">del</span> <span class="n">bline</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># Read until \n or EOF, whichever comes first</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c"># Speed up unbuffered case</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">buffers</span> <span class="o">=</span> <span class="p">[</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">()]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>  <span class="c"># reset _rbuf.  we consume it via buf.</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">recv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span>
                    <span class="k">while</span> <span class="n">data</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>

                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c"># seek end</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>  <span class="c"># reset _rbuf.  we consume it via buf.</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">nl</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">:])</span>
                        <span class="k">del</span> <span class="n">data</span>
                        <span class="k">break</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Read until size bytes or \n or EOF seen, whichever comes first</span>
                <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c"># seek end</span>
                <span class="n">buf_len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">buf_len</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                    <span class="k">return</span> <span class="n">rv</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>  <span class="c"># reset _rbuf.  we consume it via buf.</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">buf_len</span>
                    <span class="c"># did we just receive a newline?</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">nl</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="c"># save the excess data to _rbuf</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">:])</span>
                        <span class="k">if</span> <span class="n">buf_len</span><span class="p">:</span>
                            <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">])</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># Shortcut.  Avoid data copy through buf when returning</span>
                            <span class="c"># a substring of our first recv().</span>
                            <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">]</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">size</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">buf_len</span><span class="p">:</span>
                        <span class="c"># Shortcut.  Avoid data copy through buf when</span>
                        <span class="c"># returning exactly all of our first recv().</span>
                        <span class="k">return</span> <span class="n">data</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">:</span>
                        <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">left</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">left</span><span class="p">:])</span>
                        <span class="k">break</span>
                    <span class="n">buf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">buf_len</span> <span class="o">+=</span> <span class="n">n</span>
                    <span class="c">#assert buf_len == buf.tell()</span>
                <span class="k">return</span> <span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="CP_fileobject.read"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CP_fileobject.read">[docs]</a>        <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># Read until EOF</span>
                <span class="n">buffers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">recv_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_bufsize</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">recv_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span>

                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">recv_size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Read until size bytes or EOF seen, whichever comes first</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span>
                <span class="n">buf_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">buf_len</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">buf_len</span>
                    <span class="n">recv_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">recv_size</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">left</span><span class="p">:]</span>
                        <span class="n">buffers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span>
                        <span class="k">break</span>
                    <span class="n">buf_len</span> <span class="o">+=</span> <span class="n">n</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="CP_fileobject.readline"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CP_fileobject.readline">[docs]</a>        <span class="k">def</span> <span class="nf">readline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c"># Read until \n or EOF, whichever comes first</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c"># Speed up unbuffered case</span>
                    <span class="k">assert</span> <span class="n">data</span> <span class="o">==</span> <span class="s">&quot;&quot;</span>
                    <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">while</span> <span class="n">data</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>
                <span class="n">nl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nl</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">]</span>
                <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">nl</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">:]</span>
                        <span class="n">buffers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">]</span>
                        <span class="k">break</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Read until size bytes or \n or EOF seen, whichever comes first</span>
                <span class="n">nl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nl</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">]</span>
                <span class="n">buf_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">buf_len</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">]</span>
                <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rbufsize</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="n">buf_len</span>
                    <span class="n">nl</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">nl</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">nl</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">nl</span><span class="p">:]</span>
                        <span class="n">buffers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">nl</span><span class="p">]</span>
                        <span class="k">break</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_rbuf</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">left</span><span class="p">:]</span>
                        <span class="n">buffers</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">left</span><span class="p">]</span>
                        <span class="k">break</span>
                    <span class="n">buf_len</span> <span class="o">+=</span> <span class="n">n</span>
                <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buffers</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="HTTPConnection"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPConnection">[docs]</a><span class="k">class</span> <span class="nc">HTTPConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An HTTP connection (active socket).</span>
<span class="sd">    </span>
<span class="sd">    server: the Server object which received this connection.</span>
<span class="sd">    socket: the raw socket object (usually TCP) for this connection.</span>
<span class="sd">    makefile: a fileobject class for reading from the socket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">remote_addr</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">remote_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">ssl_env</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">rbufsize</span> <span class="o">=</span> <span class="n">DEFAULT_BUFFER_SIZE</span>
    <span class="n">wbufsize</span> <span class="o">=</span> <span class="n">DEFAULT_BUFFER_SIZE</span>
    <span class="n">RequestHandlerClass</span> <span class="o">=</span> <span class="n">HTTPRequest</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">makefile</span><span class="o">=</span><span class="n">CP_fileobject</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">sock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span> <span class="o">=</span> <span class="n">makefile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rbufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">makefile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wbufsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">=</span> <span class="mi">0</span>
    
<div class="viewcode-block" id="HTTPConnection.communicate"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPConnection.communicate">[docs]</a>    <span class="k">def</span> <span class="nf">communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read each request and respond appropriately.&quot;&quot;&quot;</span>
        <span class="n">request_seen</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="c"># (re)set req to None so that if something goes wrong in</span>
                <span class="c"># the RequestHandlerClass constructor, the error doesn&#39;t</span>
                <span class="c"># get written to the previous request.</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RequestHandlerClass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                
                <span class="c"># This order of operations should guarantee correct pipelining.</span>
                <span class="n">req</span><span class="o">.</span><span class="n">parse_request</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                    <span class="c"># Something went wrong in the parsing (and the server has</span>
                    <span class="c"># probably already made a simple_response). Return and</span>
                    <span class="c"># let the conn close.</span>
                    <span class="k">return</span>
                
                <span class="n">request_seen</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">req</span><span class="o">.</span><span class="n">respond</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">close_connection</span><span class="p">:</span>
                    <span class="k">return</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">errnum</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c"># sadly SSL sockets return a different (longer) time out string</span>
            <span class="k">if</span> <span class="n">errnum</span> <span class="o">==</span> <span class="s">&#39;timed out&#39;</span> <span class="ow">or</span> <span class="n">errnum</span> <span class="o">==</span> <span class="s">&#39;The read operation timed out&#39;</span><span class="p">:</span>
                <span class="c"># Don&#39;t error if we&#39;re between requests; only error</span>
                <span class="c"># if 1) no request has been started at all, or 2) we&#39;re</span>
                <span class="c"># in the middle of a request.</span>
                <span class="c"># See http://www.cherrypy.org/ticket/853</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">request_seen</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">req</span> <span class="ow">and</span> <span class="n">req</span><span class="o">.</span><span class="n">started_request</span><span class="p">):</span>
                    <span class="c"># Don&#39;t bother writing the 408 if the response</span>
                    <span class="c"># has already started being written.</span>
                    <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;408 Request Timeout&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
                            <span class="c"># Close the connection.</span>
                            <span class="k">return</span>
            <span class="k">elif</span> <span class="n">errnum</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;500 Internal Server Error&quot;</span><span class="p">,</span>
                                            <span class="n">format_exc</span><span class="p">())</span>
                    <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
                        <span class="c"># Close the connection.</span>
                        <span class="k">return</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
            <span class="c"># Close the connection.</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">NoSSLError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                <span class="c"># Unwrap our wfile</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wfile</span> <span class="o">=</span> <span class="n">CP_fileobject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">_sock</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wbufsize</span><span class="p">)</span>
                <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;400 Bad Request&quot;</span><span class="p">,</span>
                    <span class="s">&quot;The client sent a plain HTTP request, but &quot;</span>
                    <span class="s">&quot;this server only speaks HTTPS on this port.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">linger</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;500 Internal Server Error&quot;</span><span class="p">,</span> <span class="n">format_exc</span><span class="p">())</span>
                <span class="k">except</span> <span class="n">FatalSSLAlert</span><span class="p">:</span>
                    <span class="c"># Close the connection.</span>
                    <span class="k">return</span>
    </div>
    <span class="n">linger</span> <span class="o">=</span> <span class="bp">False</span>
    
<div class="viewcode-block" id="HTTPConnection.close"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPConnection.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Close the socket underlying this connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">linger</span><span class="p">:</span>
            <span class="c"># Python&#39;s socket module does NOT call close on the kernel socket</span>
            <span class="c"># when you call socket.close(). We do so manually here because we</span>
            <span class="c"># want this server to send a FIN TCP segment immediately. Note this</span>
            <span class="c"># must be called *before* calling socket.close(), because the latter</span>
            <span class="c"># drops its reference to the kernel socket.</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;_sock&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">_sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># On the other hand, sometimes we want to hang around for a bit</span>
            <span class="c"># to make sure the client has a chance to read our entire</span>
            <span class="c"># response. Skipping the close() calls here delays the FIN</span>
            <span class="c"># packet until the socket object is garbage-collected later.</span>
            <span class="c"># Someday, perhaps, we&#39;ll do the full lingering_close that</span>
            <span class="c"># Apache does, but not today.</span>
            <span class="k">pass</span>

</div></div>
<span class="n">_SHUTDOWNREQUEST</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="WorkerThread"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WorkerThread">[docs]</a><span class="k">class</span> <span class="nc">WorkerThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thread which continuously polls a Queue for Connection objects.</span>
<span class="sd">    </span>
<span class="sd">    Due to the timing issues of polling a Queue, a WorkerThread does not</span>
<span class="sd">    check its own &#39;ready&#39; flag after it has started. To stop the thread,</span>
<span class="sd">    it is necessary to stick a _SHUTDOWNREQUEST object onto the Queue</span>
<span class="sd">    (one for each running WorkerThread).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The current connection pulled off the Queue, or None.&quot;&quot;&quot;</span>
    
    <span class="n">server</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The HTTP Server which spawned this thread, and which owns the</span>
<span class="sd">    Queue and is placing active connections into it.&quot;&quot;&quot;</span>
    
    <span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;A simple flag for the calling server to know when this thread</span>
<span class="sd">    has begun polling the Queue.&quot;&quot;&quot;</span>
    
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">work_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;Requests&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">requests_seen</span><span class="p">),</span>
            <span class="s">&#39;Bytes Read&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">bytes_read</span><span class="p">),</span>
            <span class="s">&#39;Bytes Written&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">bytes_written</span><span class="p">),</span>
            <span class="s">&#39;Work Time&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_time</span> <span class="o">+</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span>
            <span class="s">&#39;Read Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Bytes Read&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">),</span>
            <span class="s">&#39;Write Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Bytes Written&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">s</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    
<div class="viewcode-block" id="WorkerThread.run"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WorkerThread.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Worker Threads&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="n">_SHUTDOWNREQUEST</span><span class="p">:</span>
                    <span class="k">return</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">requests_seen</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">requests_seen</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">bytes_read</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bytes_written</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">wfile</span><span class="o">.</span><span class="n">bytes_written</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">work_time</span> <span class="o">+=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyboardInterrupt</span><span class="p">,</span> <span class="ne">SystemExit</span><span class="p">),</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">exc</span>

</div></div>
<div class="viewcode-block" id="ThreadPool"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ThreadPool">[docs]</a><span class="k">class</span> <span class="nc">ThreadPool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A Request Queue for the CherryPyWSGIServer which pools threads.</span>
<span class="sd">    </span>
<span class="sd">    ThreadPool objects must provide min, get(), put(obj), start()</span>
<span class="sd">    and stop(timeout) attributes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="nb">min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">=</span> <span class="nb">max</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">get</span>
    
<div class="viewcode-block" id="ThreadPool.start"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ThreadPool.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start the pool of threads.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WorkerThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;CP Server &quot;</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">worker</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">_get_idle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Number of worker threads which are idle. Read-only.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">conn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">])</span>
    <span class="n">idle</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_idle</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">_get_idle</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
    
<div class="viewcode-block" id="ThreadPool.put"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ThreadPool.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">_SHUTDOWNREQUEST</span><span class="p">:</span>
            <span class="k">return</span>
    </div>
<div class="viewcode-block" id="ThreadPool.grow"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ThreadPool.grow">[docs]</a>    <span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Spawn new worker threads (not above self.max).&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">amount</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">WorkerThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="s">&quot;CP Server &quot;</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="ThreadPool.shrink"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ThreadPool.shrink">[docs]</a>    <span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">amount</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Kill off worker threads (not below self.min).&quot;&quot;&quot;</span>
        <span class="c"># Grow/shrink the pool if necessary.</span>
        <span class="c"># Remove any dead threads from our list</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">amount</span> <span class="o">-=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">min</span><span class="p">)):</span>
                <span class="c"># Put a number of shutdown requests on the queue equal</span>
                <span class="c"># to &#39;amount&#39;. Once each of those is processed by a worker,</span>
                <span class="c"># that worker will terminate and be culled from our list</span>
                <span class="c"># in self.put.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_SHUTDOWNREQUEST</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="ThreadPool.stop"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.ThreadPool.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="c"># Must shut down threads here so the code that calls</span>
        <span class="c"># this method can know when all threads are stopped.</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">_SHUTDOWNREQUEST</span><span class="p">)</span>
        
        <span class="c"># Don&#39;t join currentThread (when stop is called inside a request).</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="n">timeout</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="p">:</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_threads</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">worker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">worker</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">remaining_time</span> <span class="o">=</span> <span class="n">endtime</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">remaining_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remaining_time</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">worker</span><span class="o">.</span><span class="n">isAlive</span><span class="p">():</span>
                            <span class="c"># We exhausted the timeout.</span>
                            <span class="c"># Forcibly shut down the socket.</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">conn</span>
                            <span class="k">if</span> <span class="n">c</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">rfile</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">c</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SHUT_RD</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                                    <span class="c"># pyOpenSSL sockets don&#39;t take an arg</span>
                                    <span class="n">c</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
                            <span class="n">worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">AssertionError</span><span class="p">,</span>
                        <span class="c"># Ignore repeated Ctrl-C.</span>
                        <span class="c"># See http://www.cherrypy.org/ticket/691.</span>
                        <span class="ne">KeyboardInterrupt</span><span class="p">),</span> <span class="n">exc1</span><span class="p">:</span>
                    <span class="k">pass</span>
    </div>
    <span class="k">def</span> <span class="nf">_get_qsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="o">.</span><span class="n">qsize</span><span class="p">()</span>
    <span class="n">qsize</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_qsize</span><span class="p">)</span>


</div>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fcntl</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">windll</span><span class="p">,</span> <span class="n">WinError</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">prevent_socket_inheritance</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Dummy function, since neither fcntl nor ctypes are available.&quot;&quot;&quot;</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">prevent_socket_inheritance</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Mark the given socket fd as non-inheritable (Windows).&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">SetHandleInformation</span><span class="p">(</span><span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">WinError</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
<div class="viewcode-block" id="prevent_socket_inheritance"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.prevent_socket_inheritance">[docs]</a>    <span class="k">def</span> <span class="nf">prevent_socket_inheritance</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Mark the given socket fd as non-inheritable (POSIX).&quot;&quot;&quot;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="n">old_flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span>
        <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFD</span><span class="p">,</span> <span class="n">old_flags</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SSLAdapter"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SSLAdapter">[docs]</a><span class="k">class</span> <span class="nc">SSLAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for SSL driver library adapters.</span>
<span class="sd">    </span>
<span class="sd">    Required methods:</span>
<span class="sd">    </span>
<span class="sd">        * ``wrap(sock) -&gt; (wrapped socket, ssl environ dict)``</span>
<span class="sd">        * ``makefile(sock, mode=&#39;r&#39;, bufsize=DEFAULT_BUFFER_SIZE) -&gt; socket file object``</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">certificate</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">certificate_chain</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificate</span> <span class="o">=</span> <span class="n">certificate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">private_key</span> <span class="o">=</span> <span class="n">private_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certificate_chain</span> <span class="o">=</span> <span class="n">certificate_chain</span>
    
<div class="viewcode-block" id="SSLAdapter.wrap"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SSLAdapter.wrap">[docs]</a>    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>
    </div>
<div class="viewcode-block" id="SSLAdapter.makefile"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.SSLAdapter.makefile">[docs]</a>    <span class="k">def</span> <span class="nf">makefile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">bufsize</span><span class="o">=</span><span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>

</div></div>
<div class="viewcode-block" id="HTTPServer"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPServer">[docs]</a><span class="k">class</span> <span class="nc">HTTPServer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An HTTP server.&quot;&quot;&quot;</span>
    
    <span class="n">_bind_addr</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span>
    <span class="n">_interrupt</span> <span class="o">=</span> <span class="bp">None</span>
    
    <span class="n">gateway</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;A Gateway instance.&quot;&quot;&quot;</span>
    
    <span class="n">minthreads</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The minimum number of worker threads to create (default 10).&quot;&quot;&quot;</span>
    
    <span class="n">maxthreads</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The maximum number of worker threads to create (default -1 = no limit).&quot;&quot;&quot;</span>
    
    <span class="n">server_name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The name of the server; defaults to socket.gethostname().&quot;&quot;&quot;</span>
    
    <span class="n">protocol</span> <span class="o">=</span> <span class="s">&quot;HTTP/1.1&quot;</span>
    <span class="sd">&quot;&quot;&quot;The version string to write in the Status-Line of all HTTP responses.</span>
<span class="sd">    </span>
<span class="sd">    For example, &quot;HTTP/1.1&quot; is the default. This also limits the supported</span>
<span class="sd">    features used in the response.&quot;&quot;&quot;</span>
    
    <span class="n">request_queue_size</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="sd">&quot;&quot;&quot;The &#39;backlog&#39; arg to socket.listen(); max queued connections (default 5).&quot;&quot;&quot;</span>
    
    <span class="n">shutdown_timeout</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="sd">&quot;&quot;&quot;The total time, in seconds, to wait for worker threads to cleanly exit.&quot;&quot;&quot;</span>
    
    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="sd">&quot;&quot;&quot;The timeout in seconds for accepted connections (default 10).&quot;&quot;&quot;</span>
    
    <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;CherryPy/3.2.0&quot;</span>
    <span class="sd">&quot;&quot;&quot;A version string for the HTTPServer.&quot;&quot;&quot;</span>
    
    <span class="n">software</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;The value to set for the SERVER_SOFTWARE entry in the WSGI environ.</span>
<span class="sd">    </span>
<span class="sd">    If None, this defaults to ``&#39;%s Server&#39; % self.version``.&quot;&quot;&quot;</span>
    
    <span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="sd">&quot;&quot;&quot;An internal flag which marks whether the socket is accepting connections.&quot;&quot;&quot;</span>
    
    <span class="n">max_request_header_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="sd">&quot;&quot;&quot;The maximum size, in bytes, for request headers, or 0 for no limit.&quot;&quot;&quot;</span>
    
    <span class="n">max_request_body_size</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="sd">&quot;&quot;&quot;The maximum size, in bytes, for request bodies, or 0 for no limit.&quot;&quot;&quot;</span>
    
    <span class="n">nodelay</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="sd">&quot;&quot;&quot;If True (the default since 3.1), sets the TCP_NODELAY socket option.&quot;&quot;&quot;</span>
    
    <span class="n">ConnectionClass</span> <span class="o">=</span> <span class="n">HTTPConnection</span>
    <span class="sd">&quot;&quot;&quot;The class to use for handling HTTP connections.&quot;&quot;&quot;</span>
    
    <span class="n">ssl_adapter</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;An instance of SSLAdapter (or a subclass).</span>
<span class="sd">    </span>
<span class="sd">    You must have the corresponding SSL driver library installed.&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind_addr</span><span class="p">,</span> <span class="n">gateway</span><span class="p">,</span> <span class="n">minthreads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">maxthreads</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">server_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span> <span class="o">=</span> <span class="n">bind_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span> <span class="o">=</span> <span class="n">gateway</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">minthreads</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">maxthreads</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_name</span><span class="p">:</span>
            <span class="n">server_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_stats</span><span class="p">()</span>
    
<div class="viewcode-block" id="HTTPServer.clear_stats"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPServer.clear_stats">[docs]</a>    <span class="k">def</span> <span class="nf">clear_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;Enabled&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;Bind Address&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">),</span>
            <span class="s">&#39;Run time&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">(),</span>
            <span class="s">&#39;Accepts&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">&#39;Accepts/sec&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Accepts&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">(),</span>
            <span class="s">&#39;Queue&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">,</span> <span class="s">&quot;qsize&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
            <span class="s">&#39;Threads&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">,</span> <span class="s">&quot;_threads&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="s">&#39;Threads Idle&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">,</span> <span class="s">&quot;idle&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
            <span class="s">&#39;Socket Errors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s">&#39;Requests&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Requests&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span>
                                       <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s">&#39;Bytes Read&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Bytes Read&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span>
                                         <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s">&#39;Bytes Written&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Bytes Written&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span>
                                            <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s">&#39;Work Time&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">([</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span>
                                         <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s">&#39;Read Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Bytes Read&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s">&#39;Write Throughput&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="ow">not</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="p">[</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Bytes Written&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="s">&#39;Work Time&#39;</span><span class="p">](</span><span class="n">w</span><span class="p">)</span> <span class="ow">or</span> <span class="mf">1e-6</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="s">&#39;Worker Threads&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="mi">0</span><span class="p">),</span>
            <span class="s">&#39;Worker Threads&#39;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="p">}</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">statistics</span><span class="p">[</span><span class="s">&quot;CherryPy HTTPServer </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
    </div>
<div class="viewcode-block" id="HTTPServer.runtime"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPServer.runtime">[docs]</a>    <span class="k">def</span> <span class="nf">runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span>
    </div>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">(</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_get_bind_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind_addr</span>
    <span class="k">def</span> <span class="nf">_set_bind_addr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="c"># Despite the socket module docs, using &#39;&#39; does not</span>
            <span class="c"># allow AI_PASSIVE to work. Passing None instead</span>
            <span class="c"># returns &#39;0.0.0.0&#39; like we want. In other words:</span>
            <span class="c">#     host    AI_PASSIVE     result</span>
            <span class="c">#      &#39;&#39;         Y         192.168.x.y</span>
            <span class="c">#      &#39;&#39;         N         192.168.x.y</span>
            <span class="c">#     None        Y         0.0.0.0</span>
            <span class="c">#     None        N         127.0.0.1</span>
            <span class="c"># But since you can get the same effect with an explicit</span>
            <span class="c"># &#39;0.0.0.0&#39;, we deny both the empty string and None as values.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Host values of &#39;&#39; or None are not allowed. &quot;</span>
                             <span class="s">&quot;Use &#39;0.0.0.0&#39; (IPv4) or &#39;::&#39; (IPv6) instead &quot;</span>
                             <span class="s">&quot;to listen on all active interfaces.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind_addr</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">bind_addr</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_bind_addr</span><span class="p">,</span> <span class="n">_set_bind_addr</span><span class="p">,</span>
        <span class="n">doc</span><span class="o">=</span><span class="s">&quot;&quot;&quot;The interface on which to listen for connections.</span>
<span class="s">        </span>
<span class="s">        For TCP sockets, a (host, port) tuple. Host values may be any IPv4</span>
<span class="s">        or IPv6 address, or any valid hostname. The string &#39;localhost&#39; is a</span>
<span class="s">        synonym for &#39;127.0.0.1&#39; (or &#39;::1&#39;, if your hosts file prefers IPv6).</span>
<span class="s">        The string &#39;0.0.0.0&#39; is a special IPv4 entry meaning &quot;any active</span>
<span class="s">        interface&quot; (INADDR_ANY), and &#39;::&#39; is the similar IN6ADDR_ANY for</span>
<span class="s">        IPv6. The empty string or None are not allowed.</span>
<span class="s">        </span>
<span class="s">        For UNIX sockets, supply the filename as a string.&quot;&quot;&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="HTTPServer.start"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPServer.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the server forever.&quot;&quot;&quot;</span>
        <span class="c"># We don&#39;t have to trap KeyboardInterrupt or SystemExit here,</span>
        <span class="c"># because cherrpy.server already does so, calling self.stop() for us.</span>
        <span class="c"># If you&#39;re using this server with another framework, you should</span>
        <span class="c"># trap those exceptions in whatever code block calls start().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">software</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> Server&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        
        <span class="c"># SSL backward compatibility</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;ssl_certificate&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;ssl_private_key&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s">&quot;SSL attributes are deprecated in CherryPy 3.2, and will &quot;</span>
                    <span class="s">&quot;be removed in CherryPy 3.3. Use an ssl_adapter attribute &quot;</span>
                    <span class="s">&quot;instead.&quot;</span><span class="p">,</span>
                    <span class="ne">DeprecationWarning</span>
                <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">cherrypy.wsgiserver.ssl_pyopenssl</span> <span class="kn">import</span> <span class="n">pyOpenSSLAdapter</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="o">=</span> <span class="n">pyOpenSSLAdapter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ssl_certificate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_private_key</span><span class="p">,</span>
                    <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;ssl_certificate_chain&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        
        <span class="c"># Select the appropriate socket</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="c"># AF_UNIX socket</span>
            
            <span class="c"># So we can reuse the socket...</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            
            <span class="c"># So everyone can access the socket...</span>
            <span class="k">try</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="mo">0777</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
            
            <span class="n">info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># AF_INET or AF_INET6 socket</span>
            <span class="c"># Get the correct address family for our host (allows IPv6 addresses)</span>
            <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span>
                                          <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AI_PASSIVE</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="p">[(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span>
                             <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;No socket could be created&quot;</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">continue</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c"># Timeout so KeyboardInterrupt can be caught on Win32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request_queue_size</span><span class="p">)</span>
        
        <span class="c"># Create worker threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tick</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="c"># Wait for self.stop() to complete. See _set_interrupt.</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">interrupt</span>
    </div>
<div class="viewcode-block" id="HTTPServer.bind"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPServer.bind">[docs]</a>    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create (or recreate) the actual socket object.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
        <span class="n">prevent_socket_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelay</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
        
        <span class="c"># If listening on the IPV6 any address (&#39;::&#39; = IN6ADDR_ANY),</span>
        <span class="c"># activate dual-stack. See http://www.cherrypy.org/ticket/871.</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;AF_INET6&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="s">&#39;::0&#39;</span><span class="p">,</span> <span class="s">&#39;::0.0.0.0&#39;</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IPV6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPV6_V6ONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">):</span>
                <span class="c"># Apparently, the socket option is not available in</span>
                <span class="c"># this machine&#39;s TCP stack</span>
                <span class="k">pass</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">)</span>
    </div>
<div class="viewcode-block" id="HTTPServer.tick"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPServer.tick">[docs]</a>    <span class="k">def</span> <span class="nf">tick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Accept a new connection and put it on the Queue.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Accepts&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready</span><span class="p">:</span>
                <span class="k">return</span>
            
            <span class="n">prevent_socket_inheritance</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;settimeout&#39;</span><span class="p">):</span>
                <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            
            <span class="n">makefile</span> <span class="o">=</span> <span class="n">CP_fileobject</span>
            <span class="n">ssl_env</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c"># if ssl cert and key are set, we try to be a secure HTTP server</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s</span><span class="p">,</span> <span class="n">ssl_env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span><span class="o">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">NoSSLError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;The client sent a plain HTTP request, but &quot;</span>
                           <span class="s">&quot;this server only speaks HTTPS on this port.&quot;</span><span class="p">)</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> 400 Bad Request</span><span class="se">\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
                           <span class="s">&quot;Content-Length: </span><span class="si">%s</span><span class="se">\r\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
                           <span class="s">&quot;Content-Type: text/plain</span><span class="se">\r\n\r\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">msg</span><span class="p">]</span>
                    
                    <span class="n">wfile</span> <span class="o">=</span> <span class="n">CP_fileobject</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">,</span> <span class="n">DEFAULT_BUFFER_SIZE</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">wfile</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
                    <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">makefile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_adapter</span><span class="o">.</span><span class="n">makefile</span>
                <span class="c"># Re-apply our timeout since we may have a new socket object</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&#39;settimeout&#39;</span><span class="p">):</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ConnectionClass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">makefile</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="c"># optional values</span>
                <span class="c"># Until we do DNS lookups, omit REMOTE_HOST</span>
                <span class="k">if</span> <span class="n">addr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c"># sometimes this can happen</span>
                    <span class="c"># figure out if AF_INET or AF_INET6.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getsockname</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c"># AF_INET</span>
                        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># AF_INET6</span>
                        <span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;::&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">remote_port</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">conn</span><span class="o">.</span><span class="n">ssl_env</span> <span class="o">=</span> <span class="n">ssl_env</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">:</span>
            <span class="c"># The only reason for the timeout in start() is so we can</span>
            <span class="c"># notice keyboard interrupts on Win32, which don&#39;t interrupt</span>
            <span class="c"># accept() by default</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Enabled&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s">&#39;Socket Errors&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_error_eintr</span><span class="p">:</span>
                <span class="c"># I *think* this is right. EINTR should occur when a signal</span>
                <span class="c"># is received during the accept() call; all docs say retry</span>
                <span class="c"># the call, and I *think* I&#39;m reading it right that Python</span>
                <span class="c"># will then go ahead and poll for and handle the signal</span>
                <span class="c"># elsewhere. See http://www.cherrypy.org/ticket/707.</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_errors_nonblocking</span><span class="p">:</span>
                <span class="c"># Just try again. See http://www.cherrypy.org/ticket/479.</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                <span class="c"># Our socket was closed.</span>
                <span class="c"># See http://www.cherrypy.org/ticket/686.</span>
                <span class="k">return</span>
            <span class="k">raise</span>
    </div>
    <span class="k">def</span> <span class="nf">_get_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span>
    <span class="k">def</span> <span class="nf">_set_interrupt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupt</span> <span class="o">=</span> <span class="n">interrupt</span>
    <span class="n">interrupt</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_interrupt</span><span class="p">,</span> <span class="n">_set_interrupt</span><span class="p">,</span>
                         <span class="n">doc</span><span class="o">=</span><span class="s">&quot;Set this to an Exception instance to &quot;</span>
                             <span class="s">&quot;interrupt the server.&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="HTTPServer.stop"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.HTTPServer.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gracefully shutdown a server that is serving forever.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ready</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="n">sock</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;socket&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="c"># Touch our own socket to make accept() return immediately.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">socket_errors_to_ignore</span><span class="p">:</span>
                        <span class="c"># Changed to use error code and not message</span>
                        <span class="c"># See http://www.cherrypy.org/ticket/860.</span>
                        <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Note that we&#39;re explicitly NOT using AI_PASSIVE,</span>
                    <span class="c"># here, because we want an actual IP to touch.</span>
                    <span class="c"># localhost won&#39;t work if we&#39;ve bound to a public IP,</span>
                    <span class="c"># but it will if we bound to &#39;0.0.0.0&#39; (INADDR_ANY).</span>
                    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span>
                                                  <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
                        <span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">res</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">af</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                            <span class="c"># See http://groups.google.com/group/cherrypy-users/</span>
                            <span class="c">#        browse_frm/thread/bbfe5eb39c904fe0</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
                            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                                <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="s">&quot;close&quot;</span><span class="p">):</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown_timeout</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="Gateway"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.Gateway">[docs]</a><span class="k">class</span> <span class="nc">Gateway</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span>
    
<div class="viewcode-block" id="Gateway.respond"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.Gateway.respond">[docs]</a>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>


<span class="c"># These may either be wsgiserver.SSLAdapter subclasses or the string names</span>
<span class="c"># of such classes (in which case they will be lazily loaded).</span></div></div>
<span class="n">ssl_adapters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;builtin&#39;</span><span class="p">:</span> <span class="s">&#39;cherrypy.wsgiserver.ssl_builtin.BuiltinSSLAdapter&#39;</span><span class="p">,</span>
    <span class="s">&#39;pyopenssl&#39;</span><span class="p">:</span> <span class="s">&#39;cherrypy.wsgiserver.ssl_pyopenssl.pyOpenSSLAdapter&#39;</span><span class="p">,</span>
    <span class="p">}</span>

<div class="viewcode-block" id="get_ssl_adapter_class"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.get_ssl_adapter_class">[docs]</a><span class="k">def</span> <span class="nf">get_ssl_adapter_class</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;pyopenssl&#39;</span><span class="p">):</span>
    <span class="n">adapter</span> <span class="o">=</span> <span class="n">ssl_adapters</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">last_dot</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">attr_name</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">[</span><span class="n">last_dot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">mod_path</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">[:</span><span class="n">last_dot</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mod_path</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c"># The last [&#39;&#39;] is important.</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">mod_path</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">])</span>
        
        <span class="c"># Let an AttributeError propagate outward.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">adapter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; object has no attribute &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span>
                                 <span class="o">%</span> <span class="p">(</span><span class="n">mod_path</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">adapter</span>

<span class="c"># -------------------------------- WSGI Stuff -------------------------------- #</span>

</div>
<div class="viewcode-block" id="CherryPyWSGIServer"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.CherryPyWSGIServer">[docs]</a><span class="k">class</span> <span class="nc">CherryPyWSGIServer</span><span class="p">(</span><span class="n">HTTPServer</span><span class="p">):</span>
    
    <span class="n">wsgi_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind_addr</span><span class="p">,</span> <span class="n">wsgi_app</span><span class="p">,</span> <span class="n">numthreads</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">server_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="nb">max</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">request_queue_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shutdown_timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">ThreadPool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">numthreads</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">wsgi_app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gateway</span> <span class="o">=</span> <span class="n">wsgi_gateways</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wsgi_version</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bind_addr</span> <span class="o">=</span> <span class="n">bind_addr</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">server_name</span><span class="p">:</span>
            <span class="n">server_name</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_name</span> <span class="o">=</span> <span class="n">server_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue_size</span> <span class="o">=</span> <span class="n">request_queue_size</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_timeout</span> <span class="o">=</span> <span class="n">shutdown_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_stats</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_get_numthreads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">min</span>
    <span class="k">def</span> <span class="nf">_set_numthreads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">numthreads</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_numthreads</span><span class="p">,</span> <span class="n">_set_numthreads</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WSGIGateway"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway">[docs]</a><span class="k">class</span> <span class="nc">WSGIGateway</span><span class="p">(</span><span class="n">Gateway</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span> <span class="o">=</span> <span class="n">req</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_environ</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remaining_bytes_out</span> <span class="o">=</span> <span class="bp">None</span>
    
<div class="viewcode-block" id="WSGIGateway.get_environ"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway.get_environ">[docs]</a>    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new environ dict targeting the given wsgi.version&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="bp">NotImplemented</span>
    </div>
<div class="viewcode-block" id="WSGIGateway.respond"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway.respond">[docs]</a>    <span class="k">def</span> <span class="nf">respond</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_response</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="c"># &quot;The start_response callable must not actually transmit</span>
                <span class="c"># the response headers. Instead, it must store them for the</span>
                <span class="c"># server or gateway to transmit only after the first</span>
                <span class="c"># iteration of the application return value that yields</span>
                <span class="c"># a NON-EMPTY string, or upon the application&#39;s first</span>
                <span class="c"># invocation of the write() callable.&quot; (PEP 333)</span>
                <span class="k">if</span> <span class="n">chunk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                        <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s">&quot;close&quot;</span><span class="p">):</span>
                <span class="n">response</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    </div>
<div class="viewcode-block" id="WSGIGateway.start_response"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway.start_response">[docs]</a>    <span class="k">def</span> <span class="nf">start_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WSGI callable to begin the HTTP response.&quot;&quot;&quot;</span>
        <span class="c"># &quot;The application may call start_response more than once,</span>
        <span class="c"># if and only if the exc_info argument is provided.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exc_info</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;WSGI start_response called a second &quot;</span>
                                 <span class="s">&quot;time with no exc_info.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="c"># &quot;if exc_info is provided, and the HTTP headers have already been</span>
        <span class="c"># sent, start_response must raise an error, and should raise the</span>
        <span class="c"># exc_info tuple.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">exc_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">exc_info</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;WSGI response header key </span><span class="si">%r</span><span class="s"> is not a byte string.&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;WSGI response header value </span><span class="si">%r</span><span class="s"> is not a byte string.&quot;</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;content-length&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remaining_bytes_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">outheaders</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
    </div>
<div class="viewcode-block" id="WSGIGateway.write"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;WSGI callable to write unbuffered data to the client.</span>
<span class="sd">        </span>
<span class="sd">        This method is also used internally by start_response (to write</span>
<span class="sd">        data from the iterable returned by the WSGI application).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started_response</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&quot;WSGI write called before start_response.&quot;</span><span class="p">)</span>
        
        <span class="n">chunklen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="n">rbo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remaining_bytes_out</span>
        <span class="k">if</span> <span class="n">rbo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">chunklen</span> <span class="o">&gt;</span> <span class="n">rbo</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
                <span class="c"># Whew. We can send a 500 to the client.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">simple_response</span><span class="p">(</span><span class="s">&quot;500 Internal Server Error&quot;</span><span class="p">,</span>
                    <span class="s">&quot;The requested resource returned more bytes than the &quot;</span>
                    <span class="s">&quot;declared Content-Length.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Dang. We have probably already sent data. Truncate the chunk</span>
                <span class="c"># to fit (so the client doesn&#39;t hang) and raise an error later.</span>
                <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span><span class="n">rbo</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">sent_headers</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">send_headers</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">rbo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rbo</span> <span class="o">-=</span> <span class="n">chunklen</span>
            <span class="k">if</span> <span class="n">rbo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s">&quot;Response body exceeds the declared Content-Length.&quot;</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="WSGIGateway_10"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway_10">[docs]</a><span class="k">class</span> <span class="nc">WSGIGateway_10</span><span class="p">(</span><span class="n">WSGIGateway</span><span class="p">):</span>
    
<div class="viewcode-block" id="WSGIGateway_10.get_environ"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway_10.get_environ">[docs]</a>    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new environ dict targeting the given wsgi.version&quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span>
        <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># set a non-standard environ entry so the WSGI app can know what</span>
            <span class="c"># the *real* server protocol is (and what features to support).</span>
            <span class="c"># See http://www.faqs.org/rfcs/rfc2145.html.</span>
            <span class="s">&#39;ACTUAL_SERVER_PROTOCOL&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">protocol</span><span class="p">,</span>
            <span class="s">&#39;PATH_INFO&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
            <span class="s">&#39;QUERY_STRING&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">qs</span><span class="p">,</span>
            <span class="s">&#39;REMOTE_ADDR&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">remote_addr</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="s">&#39;REMOTE_PORT&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">remote_port</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">),</span>
            <span class="s">&#39;REQUEST_METHOD&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s">&#39;REQUEST_URI&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span>
            <span class="s">&#39;SCRIPT_NAME&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
            <span class="s">&#39;SERVER_NAME&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">server_name</span><span class="p">,</span>
            <span class="c"># Bah. &quot;SERVER_PROTOCOL&quot; is actually the REQUEST protocol.</span>
            <span class="s">&#39;SERVER_PROTOCOL&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">request_protocol</span><span class="p">,</span>
            <span class="s">&#39;SERVER_SOFTWARE&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">software</span><span class="p">,</span>
            <span class="s">&#39;wsgi.errors&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="s">&#39;wsgi.input&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">rfile</span><span class="p">,</span>
            <span class="s">&#39;wsgi.multiprocess&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;wsgi.multithread&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">&#39;wsgi.run_once&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">&#39;wsgi.url_scheme&#39;</span><span class="p">:</span> <span class="n">req</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span>
            <span class="s">&#39;wsgi.version&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="p">}</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="c"># AF_UNIX. This isn&#39;t really allowed by WSGI, which doesn&#39;t</span>
            <span class="c"># address unix domain sockets. But it&#39;s better than nothing.</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&quot;SERVER_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&quot;SERVER_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">bind_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c"># Request headers</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">req</span><span class="o">.</span><span class="n">inheaders</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&quot;HTTP_&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>
        
        <span class="c"># CONTENT_TYPE/CONTENT_LENGTH</span>
        <span class="n">ct</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;HTTP_CONTENT_TYPE&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ct</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&quot;CONTENT_TYPE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span>
        <span class="n">cl</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;HTTP_CONTENT_LENGTH&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">env</span><span class="p">[</span><span class="s">&quot;CONTENT_LENGTH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cl</span>
        
        <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">ssl_env</span><span class="p">:</span>
            <span class="n">env</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">ssl_env</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">env</span>

</div></div>
<div class="viewcode-block" id="WSGIGateway_u0"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway_u0">[docs]</a><span class="k">class</span> <span class="nc">WSGIGateway_u0</span><span class="p">(</span><span class="n">WSGIGateway_10</span><span class="p">):</span>
    
<div class="viewcode-block" id="WSGIGateway_u0.get_environ"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIGateway_u0.get_environ">[docs]</a>    <span class="k">def</span> <span class="nf">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new environ dict targeting the given wsgi.version&quot;&quot;&quot;</span>
        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">req</span>
        <span class="n">env_10</span> <span class="o">=</span> <span class="n">WSGIGateway_10</span><span class="o">.</span><span class="n">get_environ</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ISO-8859-1&#39;</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env_10</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()])</span>
        <span class="n">env</span><span class="p">[</span><span class="s">u&#39;wsgi.version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c"># Request-URI</span>
        <span class="n">env</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">u&#39;wsgi.url_encoding&#39;</span><span class="p">,</span> <span class="s">u&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">u&quot;PATH_INFO&quot;</span><span class="p">,</span> <span class="s">u&quot;SCRIPT_NAME&quot;</span><span class="p">,</span> <span class="s">u&quot;QUERY_STRING&quot;</span><span class="p">]:</span>
                <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_10</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s">u&#39;wsgi.url_encoding&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="c"># Fall back to latin 1 so apps can transcode if needed.</span>
            <span class="n">env</span><span class="p">[</span><span class="s">u&#39;wsgi.url_encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39;ISO-8859-1&#39;</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s">u&quot;PATH_INFO&quot;</span><span class="p">,</span> <span class="s">u&quot;SCRIPT_NAME&quot;</span><span class="p">,</span> <span class="s">u&quot;QUERY_STRING&quot;</span><span class="p">]:</span>
                <span class="n">env</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">env_10</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">env</span><span class="p">[</span><span class="s">u&#39;wsgi.url_encoding&#39;</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;REQUEST_URI&#39;</span><span class="p">,</span> <span class="s">&#39;wsgi.input&#39;</span><span class="p">):</span>
                <span class="n">env</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ISO-8859-1&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">env</span>
</div></div>
<span class="n">wsgi_gateways</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="n">WSGIGateway_10</span><span class="p">,</span>
    <span class="p">(</span><span class="s">&#39;u&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span> <span class="n">WSGIGateway_u0</span><span class="p">,</span>
<span class="p">}</span>

<div class="viewcode-block" id="WSGIPathInfoDispatcher"><a class="viewcode-back" href="../../../pytomo.web.wsgiserver.html#pytomo.web.wsgiserver.WSGIPathInfoDispatcher">[docs]</a><span class="k">class</span> <span class="nc">WSGIPathInfoDispatcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WSGI dispatcher for dispatch based on the PATH_INFO.</span>
<span class="sd">    </span>
<span class="sd">    apps: a dict or list of (path_prefix, app) pairs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apps</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">apps</span> <span class="o">=</span> <span class="n">apps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        
        <span class="c"># Sort the apps by len(path), descending</span>
        <span class="n">apps</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">apps</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        
        <span class="c"># The path_prefix strings must start, but not end, with a slash.</span>
        <span class="c"># Use &quot;&quot; instead of &quot;/&quot;.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">p</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&quot;PATH_INFO&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&quot;/&quot;</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">app</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apps</span><span class="p">:</span>
            <span class="c"># The apps list should be sorted by length, descending.</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">path</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">environ</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&quot;SCRIPT_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s">&quot;SCRIPT_NAME&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span>
                <span class="n">environ</span><span class="p">[</span><span class="s">&quot;PATH_INFO&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">):]</span>
                <span class="k">return</span> <span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;404 Not Found&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">),</span>
                                         <span class="p">(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">)])</span>
        <span class="k">return</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Pytomo 2.8.6 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Louis Plissoneau.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>